(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();class kt{}class oe extends kt{constructor(e,t,i){super(),this.viewId=e,this.groupId=t,this.panelId=i}}class le{constructor(){}static getInstance(){return le.INSTANCE}hasData(e){return e&&e===this.proto}clearData(e){this.hasData(e)&&(this.proto=void 0,this.data=void 0)}getData(e){if(this.hasData(e))return this.data}setData(e,t){t&&(this.data=e,this.proto=t)}}le.INSTANCE=new le;function $(){const o=le.getInstance();if(o.hasData(oe.prototype))return o.getData(oe.prototype)[0]}var he;(function(o){o.any=(...e)=>t=>{const i=e.map(s=>s(t));return{dispose:()=>{i.forEach(s=>{s.dispose()})}}}})(he||(he={}));class $e{constructor(){this._defaultPrevented=!1}get defaultPrevented(){return this._defaultPrevented}preventDefault(){this._defaultPrevented=!0}}class Rt{constructor(){this._isAccepted=!1}get isAccepted(){return this._isAccepted}accept(){this._isAccepted=!0}}class Vt{constructor(){this.events=new Map}get size(){return this.events.size}add(e,t){this.events.set(e,t)}delete(e){this.events.delete(e)}clear(){this.events.clear()}}class ye{static create(){var e;return new ye((e=new Error().stack)!==null&&e!==void 0?e:"")}constructor(e){this.value=e}print(){console.warn("dockview: stacktrace",this.value)}}class Wt{constructor(e,t){this.callback=e,this.stacktrace=t}}class f{static setLeakageMonitorEnabled(e){e!==f.ENABLE_TRACKING&&f.MEMORY_LEAK_WATCHER.clear(),f.ENABLE_TRACKING=e}get value(){return this._last}constructor(e){this.options=e,this._listeners=[],this._disposed=!1}get event(){return this._event||(this._event=e=>{var t;!((t=this.options)===null||t===void 0)&&t.replay&&this._last!==void 0&&e(this._last);const i=new Wt(e,f.ENABLE_TRACKING?ye.create():void 0);return this._listeners.push(i),{dispose:()=>{const s=this._listeners.indexOf(i);s>-1&&this._listeners.splice(s,1)}}},f.ENABLE_TRACKING&&f.MEMORY_LEAK_WATCHER.add(this._event,ye.create())),this._event}fire(e){var t;!((t=this.options)===null||t===void 0)&&t.replay&&(this._last=e);for(const i of this._listeners)i.callback(e)}dispose(){this._disposed||(this._disposed=!0,this._listeners.length>0&&(f.ENABLE_TRACKING&&queueMicrotask(()=>{var e;for(const t of this._listeners)console.warn("dockview: stacktrace",(e=t.stacktrace)===null||e===void 0?void 0:e.print())}),this._listeners=[]),f.ENABLE_TRACKING&&this._event&&f.MEMORY_LEAK_WATCHER.delete(this._event))}}f.ENABLE_TRACKING=!1;f.MEMORY_LEAK_WATCHER=new Vt;function I(o,e,t,i){return o.addEventListener(e,t,i),{dispose:()=>{o.removeEventListener(e,t,i)}}}class Qe{constructor(){this._onFired=new f,this._currentFireCount=0,this._queued=!1,this.onEvent=e=>{const t=this._currentFireCount;return this._onFired.event(()=>{this._currentFireCount>t&&e()})}}fire(){this._currentFireCount++,!this._queued&&(this._queued=!0,queueMicrotask(()=>{this._queued=!1,this._onFired.fire()}))}dispose(){this._onFired.dispose()}}var W;(function(o){o.NONE={dispose:()=>{}};function e(t){return{dispose:()=>{t()}}}o.from=e})(W||(W={}));class E{get isDisposed(){return this._isDisposed}constructor(...e){this._isDisposed=!1,this._disposables=e}addDisposables(...e){e.forEach(t=>this._disposables.push(t))}dispose(){this._isDisposed||(this._isDisposed=!0,this._disposables.forEach(e=>e.dispose()),this._disposables=[])}}class Y{constructor(){this._disposable=W.NONE}set value(e){this._disposable&&this._disposable.dispose(),this._disposable=e}dispose(){this._disposable&&(this._disposable.dispose(),this._disposable=W.NONE)}}class Nt extends E{constructor(e){super(),this._onDidChange=new f,this.onDidChange=this._onDidChange.event,this._value=null,this.addDisposables(this._onDidChange,Se(e,t=>{const i=t.target.scrollWidth>t.target.clientWidth,s=t.target.scrollHeight>t.target.clientHeight;this._value={hasScrollX:i,hasScrollY:s},this._onDidChange.fire(this._value)}))}}function Se(o,e){const t=new ResizeObserver(i=>{requestAnimationFrame(()=>{const s=i[0];e(s)})});return t.observe(o),{dispose:()=>{t.unobserve(o),t.disconnect()}}}const Me=(o,...e)=>{for(const t of e)o.classList.contains(t)&&o.classList.remove(t)},pt=(o,...e)=>{for(const t of e)o.classList.contains(t)||o.classList.add(t)},A=(o,e,t)=>{const i=o.classList.contains(e);t&&!i&&o.classList.add(e),!t&&i&&o.classList.remove(e)};function Te(o,e){for(;o;){if(o===e)return!0;o=o.parentNode}return!1}function mt(o){return new Ht(o)}class Ht extends E{constructor(e){super(),this._onDidFocus=new f,this.onDidFocus=this._onDidFocus.event,this._onDidBlur=new f,this.onDidBlur=this._onDidBlur.event,this.addDisposables(this._onDidFocus,this._onDidBlur);let t=Te(document.activeElement,e),i=!1;const s=()=>{i=!1,t||(t=!0,this._onDidFocus.fire())},n=()=>{t&&(i=!0,window.setTimeout(()=>{i&&(i=!1,t=!1,this._onDidBlur.fire())},0))};this._refreshStateHandler=()=>{Te(document.activeElement,e)!==t&&(t?n():s())},this.addDisposables(I(e,"focus",s,!0)),this.addDisposables(I(e,"blur",n,!0))}refreshState(){this._refreshStateHandler()}}const ft="dv-quasiPreventDefault";function Bt(o){o[ft]=!0}function et(o){return o[ft]}function Ft(o,e){const t=Array.from(e);for(const i of t){if(i.href){const n=o.createElement("link");n.href=i.href,n.type=i.type,n.rel="stylesheet",o.head.appendChild(n)}let s=[];try{i.cssRules&&(s=Array.from(i.cssRules).map(n=>n.cssText))}catch{}for(const n of s){const r=o.createElement("style");r.appendChild(o.createTextNode(n)),o.head.appendChild(r)}}}function Le(o){const{left:e,top:t,width:i,height:s}=o.getBoundingClientRect();return{left:e+window.scrollX,top:t+window.scrollY,width:i,height:s}}function Ut(o){let e=o;for(;e?.parentNode;){if(e.parentNode===document)return!0;e.parentNode instanceof DocumentFragment?e=e.parentNode.host:e=e.parentNode}return!1}function jt(o,e){o.setAttribute("data-testid",e)}function $t(o){const e=[];function t(i){if(i.nodeType===Node.ELEMENT_NODE){o.includes(i.tagName)&&e.push(i),i.shadowRoot&&t(i.shadowRoot);for(const s of i.children)t(s)}}return t(document.documentElement),e}function xe(o=document){const e=$t(["IFRAME","WEBVIEW"]),t=new WeakMap;for(const i of e)t.set(i,i.style.pointerEvents),i.style.pointerEvents="none";return{release:()=>{var i;for(const s of e)s.style.pointerEvents=(i=t.get(s))!==null&&i!==void 0?i:"auto";e.splice(0,e.length)}}}function qt(o){function e(s){const n=[];for(let r=0;r<s.classList.length;r++)n.push(s.classList.item(r));return n}let t,i=o;for(;i!==null&&(t=e(i).find(s=>s.startsWith("dockview-theme-")),typeof t!="string");)i=i.parentElement;return t}class vt{constructor(e){this.element=e,this._classNames=[]}setClassNames(e){for(const t of this._classNames)A(this.element,t,!1);this._classNames=e.split(" ").filter(t=>t.trim().length>0);for(const t of this._classNames)A(this.element,t,!0)}}const gt=100;function Yt(o,e){const t=Le(o),i=Le(e);return!(t.left<i.left||t.left+t.width>i.left+i.width)}function Xt(o){const e=new f;let t=o.screenX,i=o.screenY,s;const n=()=>{if(o.closed)return;const r=o.screenX,a=o.screenY;(r!==t||a!==i)&&(clearTimeout(s),s=setTimeout(()=>{e.fire()},gt),t=r,i=a),requestAnimationFrame(n)};return n(),e}function Zt(o,e){let t;return new E(I(o,"resize",()=>{clearTimeout(t),t=setTimeout(()=>{e()},gt)}))}function Jt(o,e,t={buffer:10}){const i=t.buffer,s=o.getBoundingClientRect(),n=e.getBoundingClientRect();let r=0,a=0;const h=s.left-n.left,l=s.top-n.top,d=s.bottom-n.bottom,c=s.right-n.right;h<i?r=i-h:c>i&&(r=-i-c),l<i?a=i-l:d>i&&(a=-d-i),(r!==0||a!==0)&&(o.style.transform=`translate(${r}px, ${a}px)`)}function Kt(o){let e=o;for(;e&&(e.style.zIndex==="auto"||e.style.zIndex==="");)e=e.parentElement;return e}function re(o){if(o.length===0)throw new Error("Invalid tail call");return[o.slice(0,o.length-1),o[o.length-1]]}function Qt(o,e){if(o.length!==e.length)return!1;for(let t=0;t<o.length;t++)if(o[t]!==e[t])return!1;return!0}function Ie(o,e){const t=o.indexOf(e);t>-1&&(o.splice(t,1),o.unshift(e))}function ge(o,e){const t=o.indexOf(e);t>-1&&(o.splice(t,1),o.push(e))}function ei(o,e){for(let t=0;t<o.length;t++){const i=o[t];if(e(i))return t}return-1}function Ge(o,e){const t=o.findIndex(i=>i===e);return t>-1?(o.splice(t,1),!0):!1}const O=(o,e,t)=>e>t?e:Math.min(t,Math.max(o,e)),_t=()=>{let o=1;return{next:()=>(o++).toString()}},X=(o,e)=>{const t=[];if(typeof e!="number"&&(e=o,o=0),o<=e)for(let i=o;i<e;i++)t.push(i);else for(let i=o;i>e;i--)t.push(i);return t};class ti{set size(e){this._size=e}get size(){return this._size}get cachedVisibleSize(){return this._cachedVisibleSize}get visible(){return typeof this._cachedVisibleSize>"u"}get minimumSize(){return this.visible?this.view.minimumSize:0}get viewMinimumSize(){return this.view.minimumSize}get maximumSize(){return this.visible?this.view.maximumSize:0}get viewMaximumSize(){return this.view.maximumSize}get priority(){return this.view.priority}get snap(){return!!this.view.snap}set enabled(e){this.container.style.pointerEvents=e?"":"none"}constructor(e,t,i,s){this.container=e,this.view=t,this.disposable=s,this._cachedVisibleSize=void 0,typeof i=="number"?(this._size=i,this._cachedVisibleSize=void 0,e.classList.add("visible")):(this._size=0,this._cachedVisibleSize=i.cachedVisibleSize)}setVisible(e,t){var i;e!==this.visible&&(e?(this.size=O((i=this._cachedVisibleSize)!==null&&i!==void 0?i:0,this.viewMinimumSize,this.viewMaximumSize),this._cachedVisibleSize=void 0):(this._cachedVisibleSize=typeof t=="number"?t:this.size,this.size=0),this.container.classList.toggle("visible",e),this.view.setVisible&&this.view.setVisible(e))}dispose(){return this.disposable.dispose(),this.view}}var P;(function(o){o.HORIZONTAL="HORIZONTAL",o.VERTICAL="VERTICAL"})(P||(P={}));var q;(function(o){o[o.MAXIMUM=0]="MAXIMUM",o[o.MINIMUM=1]="MINIMUM",o[o.DISABLED=2]="DISABLED",o[o.ENABLED=3]="ENABLED"})(q||(q={}));var V;(function(o){o.Low="low",o.High="high",o.Normal="normal"})(V||(V={}));var te;(function(o){o.Distribute={type:"distribute"};function e(i){return{type:"split",index:i}}o.Split=e;function t(i){return{type:"invisible",cachedVisibleSize:i}}o.Invisible=t})(te||(te={}));class tt{get contentSize(){return this._contentSize}get size(){return this._size}set size(e){this._size=e}get orthogonalSize(){return this._orthogonalSize}set orthogonalSize(e){this._orthogonalSize=e}get length(){return this.viewItems.length}get proportions(){return this._proportions?[...this._proportions]:void 0}get orientation(){return this._orientation}set orientation(e){this._orientation=e;const t=this.size;this.size=this.orthogonalSize,this.orthogonalSize=t,Me(this.element,"dv-horizontal","dv-vertical"),this.element.classList.add(this.orientation==P.HORIZONTAL?"dv-horizontal":"dv-vertical")}get minimumSize(){return this.viewItems.reduce((e,t)=>e+t.minimumSize,0)}get maximumSize(){return this.length===0?Number.POSITIVE_INFINITY:this.viewItems.reduce((e,t)=>e+t.maximumSize,0)}get startSnappingEnabled(){return this._startSnappingEnabled}set startSnappingEnabled(e){this._startSnappingEnabled!==e&&(this._startSnappingEnabled=e,this.updateSashEnablement())}get endSnappingEnabled(){return this._endSnappingEnabled}set endSnappingEnabled(e){this._endSnappingEnabled!==e&&(this._endSnappingEnabled=e,this.updateSashEnablement())}get disabled(){return this._disabled}set disabled(e){this._disabled=e,A(this.element,"dv-splitview-disabled",e)}get margin(){return this._margin}set margin(e){this._margin=e,A(this.element,"dv-splitview-has-margin",e!==0)}constructor(e,t){var i,s;this.container=e,this.viewItems=[],this.sashes=[],this._size=0,this._orthogonalSize=0,this._contentSize=0,this._proportions=void 0,this._startSnappingEnabled=!0,this._endSnappingEnabled=!0,this._disabled=!1,this._margin=0,this._onDidSashEnd=new f,this.onDidSashEnd=this._onDidSashEnd.event,this._onDidAddView=new f,this.onDidAddView=this._onDidAddView.event,this._onDidRemoveView=new f,this.onDidRemoveView=this._onDidRemoveView.event,this.resize=(n,r,a=this.viewItems.map(v=>v.size),h,l,d=Number.NEGATIVE_INFINITY,c=Number.POSITIVE_INFINITY,m,u)=>{if(n<0||n>this.viewItems.length)return 0;const v=X(n,-1),p=X(n+1,this.viewItems.length);if(l)for(const w of l)Ie(v,w),Ie(p,w);if(h)for(const w of h)ge(v,w),ge(p,w);const g=v.map(w=>this.viewItems[w]),b=v.map(w=>a[w]),y=p.map(w=>this.viewItems[w]),D=p.map(w=>a[w]),_=v.reduce((w,S)=>w+this.viewItems[S].minimumSize-a[S],0),x=v.reduce((w,S)=>w+this.viewItems[S].maximumSize-a[S],0),C=p.length===0?Number.POSITIVE_INFINITY:p.reduce((w,S)=>w+a[S]-this.viewItems[S].minimumSize,0),M=p.length===0?Number.NEGATIVE_INFINITY:p.reduce((w,S)=>w+a[S]-this.viewItems[S].maximumSize,0),L=Math.max(_,M),U=Math.min(C,x);let k=!1;if(m){const w=this.viewItems[m.index],S=r>=m.limitDelta;k=S!==w.visible,w.setVisible(S,m.size)}if(!k&&u){const w=this.viewItems[u.index],S=r<u.limitDelta;k=S!==w.visible,w.setVisible(S,u.size)}if(k)return this.resize(n,r,a,h,l,d,c);const H=O(r,L,U);let j=0,G=H;for(let w=0;w<g.length;w++){const S=g[w],R=O(b[w]+G,S.minimumSize,S.maximumSize),ve=R-b[w];j+=ve,G-=ve,S.size=R}let z=j;for(let w=0;w<y.length;w++){const S=y[w],R=O(D[w]-z,S.minimumSize,S.maximumSize),ve=R-D[w];z+=ve,S.size=R}return r},this._orientation=(i=t.orientation)!==null&&i!==void 0?i:P.VERTICAL,this.element=this.createContainer(),this.margin=(s=t.margin)!==null&&s!==void 0?s:0,this.proportionalLayout=t.proportionalLayout===void 0?!0:!!t.proportionalLayout,this.viewContainer=this.createViewContainer(),this.sashContainer=this.createSashContainer(),this.element.appendChild(this.sashContainer),this.element.appendChild(this.viewContainer),this.container.appendChild(this.element),this.style(t.styles),t.descriptor&&(this._size=t.descriptor.size,t.descriptor.views.forEach((n,r)=>{const a=n.visible===void 0||n.visible?n.size:{type:"invisible",cachedVisibleSize:n.size},h=n.view;this.addView(h,a,r,!0)}),this._contentSize=this.viewItems.reduce((n,r)=>n+r.size,0),this.saveProportions())}style(e){e?.separatorBorder==="transparent"?(Me(this.element,"dv-separator-border"),this.element.style.removeProperty("--dv-separator-border")):(pt(this.element,"dv-separator-border"),e?.separatorBorder&&this.element.style.setProperty("--dv-separator-border",e.separatorBorder))}isViewVisible(e){if(e<0||e>=this.viewItems.length)throw new Error("Index out of bounds");return this.viewItems[e].visible}setViewVisible(e,t){if(e<0||e>=this.viewItems.length)throw new Error("Index out of bounds");const i=this.viewItems[e];i.setVisible(t,i.size),this.distributeEmptySpace(e),this.layoutViews(),this.saveProportions()}getViewSize(e){return e<0||e>=this.viewItems.length?-1:this.viewItems[e].size}resizeView(e,t){if(e<0||e>=this.viewItems.length)return;const i=X(this.viewItems.length).filter(a=>a!==e),s=[...i.filter(a=>this.viewItems[a].priority===V.Low),e],n=i.filter(a=>this.viewItems[a].priority===V.High),r=this.viewItems[e];t=Math.round(t),t=O(t,r.minimumSize,Math.min(r.maximumSize,this._size)),r.size=t,this.relayout(s,n)}getViews(){return this.viewItems.map(e=>e.view)}onDidChange(e,t){const i=this.viewItems.indexOf(e);if(i<0||i>=this.viewItems.length)return;t=typeof t=="number"?t:e.size,t=O(t,e.minimumSize,e.maximumSize),e.size=t;const s=X(this.viewItems.length).filter(a=>a!==i),n=[...s.filter(a=>this.viewItems[a].priority===V.Low),i],r=s.filter(a=>this.viewItems[a].priority===V.High);this.relayout([...n,i],r)}addView(e,t={type:"distribute"},i=this.viewItems.length,s){const n=document.createElement("div");n.className="dv-view",n.appendChild(e.element);let r;typeof t=="number"?r=t:t.type==="split"?r=this.getViewSize(t.index)/2:t.type==="invisible"?r={cachedVisibleSize:t.cachedVisibleSize}:r=e.minimumSize;const a=e.onDidChange(l=>this.onDidChange(h,l.size)),h=new ti(n,e,r,{dispose:()=>{a.dispose(),this.viewContainer.removeChild(n)}});if(i===this.viewItems.length?this.viewContainer.appendChild(n):this.viewContainer.insertBefore(n,this.viewContainer.children.item(i)),this.viewItems.splice(i,0,h),this.viewItems.length>1){const l=document.createElement("div");l.className="dv-sash";const d=m=>{for(const w of this.viewItems)w.enabled=!1;const u=xe(),v=this._orientation===P.HORIZONTAL?m.clientX:m.clientY,p=ei(this.sashes,w=>w.container===l),g=this.viewItems.map(w=>w.size);let b,y;const D=X(p,-1),_=X(p+1,this.viewItems.length),x=D.reduce((w,S)=>w+(this.viewItems[S].minimumSize-g[S]),0),C=D.reduce((w,S)=>w+(this.viewItems[S].viewMaximumSize-g[S]),0),M=_.length===0?Number.POSITIVE_INFINITY:_.reduce((w,S)=>w+(g[S]-this.viewItems[S].minimumSize),0),L=_.length===0?Number.NEGATIVE_INFINITY:_.reduce((w,S)=>w+(g[S]-this.viewItems[S].viewMaximumSize),0),U=Math.max(x,L),k=Math.min(M,C),H=this.findFirstSnapIndex(D),j=this.findFirstSnapIndex(_);if(typeof H=="number"){const w=this.viewItems[H],S=Math.floor(w.viewMinimumSize/2);b={index:H,limitDelta:w.visible?U-S:U+S,size:w.size}}if(typeof j=="number"){const w=this.viewItems[j],S=Math.floor(w.viewMinimumSize/2);y={index:j,limitDelta:w.visible?k+S:k-S,size:w.size}}const G=w=>{const R=(this._orientation===P.HORIZONTAL?w.clientX:w.clientY)-v;this.resize(p,R,g,void 0,void 0,U,k,b,y),this.distributeEmptySpace(),this.layoutViews()},z=()=>{for(const w of this.viewItems)w.enabled=!0;u.release(),this.saveProportions(),document.removeEventListener("pointermove",G),document.removeEventListener("pointerup",z),document.removeEventListener("pointercancel",z),this._onDidSashEnd.fire(void 0)};document.addEventListener("pointermove",G),document.addEventListener("pointerup",z),document.addEventListener("pointercancel",z)};l.addEventListener("pointerdown",d);const c={container:l,disposable:()=>{l.removeEventListener("pointerdown",d),this.sashContainer.removeChild(l)}};this.sashContainer.appendChild(l),this.sashes.push(c)}s||this.relayout([i]),!s&&typeof t!="number"&&t.type==="distribute"&&this.distributeViewSizes(),this._onDidAddView.fire(e)}distributeViewSizes(){const e=[];let t=0;for(const a of this.viewItems)a.maximumSize-a.minimumSize>0&&(e.push(a),t+=a.size);const i=Math.floor(t/e.length);for(const a of e)a.size=O(i,a.minimumSize,a.maximumSize);const s=X(this.viewItems.length),n=s.filter(a=>this.viewItems[a].priority===V.Low),r=s.filter(a=>this.viewItems[a].priority===V.High);this.relayout(n,r)}removeView(e,t,i=!1){const s=this.viewItems.splice(e,1)[0];if(s.dispose(),this.viewItems.length>=1){const n=Math.max(e-1,0);this.sashes.splice(n,1)[0].disposable()}return i||this.relayout(),t&&t.type==="distribute"&&this.distributeViewSizes(),this._onDidRemoveView.fire(s.view),s.view}getViewCachedVisibleSize(e){if(e<0||e>=this.viewItems.length)throw new Error("Index out of bounds");return this.viewItems[e].cachedVisibleSize}moveView(e,t){const i=this.getViewCachedVisibleSize(e),s=typeof i>"u"?this.getViewSize(e):te.Invisible(i),n=this.removeView(e,void 0,!0);this.addView(n,s,t)}layout(e,t){const i=Math.max(this.size,this._contentSize);if(this.size=e,this.orthogonalSize=t,this.proportions){let s=0;for(let n=0;n<this.viewItems.length;n++){const r=this.viewItems[n],a=this.proportions[n];typeof a=="number"?s+=a:e-=r.size}for(let n=0;n<this.viewItems.length;n++){const r=this.viewItems[n],a=this.proportions[n];typeof a=="number"&&s>0&&(r.size=O(Math.round(a*e/s),r.minimumSize,r.maximumSize))}}else{const s=X(this.viewItems.length),n=s.filter(a=>this.viewItems[a].priority===V.Low),r=s.filter(a=>this.viewItems[a].priority===V.High);this.resize(this.viewItems.length-1,e-i,void 0,n,r)}this.distributeEmptySpace(),this.layoutViews()}relayout(e,t){const i=this.viewItems.reduce((s,n)=>s+n.size,0);this.resize(this.viewItems.length-1,this._size-i,void 0,e,t),this.distributeEmptySpace(),this.layoutViews(),this.saveProportions()}distributeEmptySpace(e){const t=this.viewItems.reduce((a,h)=>a+h.size,0);let i=this.size-t;const s=X(this.viewItems.length-1,-1),n=s.filter(a=>this.viewItems[a].priority===V.Low),r=s.filter(a=>this.viewItems[a].priority===V.High);for(const a of r)Ie(s,a);for(const a of n)ge(s,a);typeof e=="number"&&ge(s,e);for(let a=0;i!==0&&a<s.length;a++){const h=this.viewItems[s[a]],l=O(h.size+i,h.minimumSize,h.maximumSize),d=l-h.size;i-=d,h.size=l}}saveProportions(){this.proportionalLayout&&this._contentSize>0&&(this._proportions=this.viewItems.map(e=>e.visible?e.size/this._contentSize:void 0))}layoutViews(){if(this._contentSize=this.viewItems.reduce((h,l)=>h+l.size,0),this.updateSashEnablement(),this.viewItems.length===0)return;const e=this.viewItems.filter(h=>h.visible),t=Math.max(0,e.length-1),i=this.margin*t/Math.max(1,e.length);let s=0;const n=[],r=4,a=this.viewItems.reduce((h,l,d)=>{const c=l.visible?1:0;return d===0?h.push(c):h.push(h[d-1]+c),h},[]);this.viewItems.forEach((h,l)=>{s+=this.viewItems[l].size,n.push(s);const d=h.visible?h.size-i:0,c=Math.max(0,a[l]-1),m=l===0||c===0?0:n[l-1]+c/t*i;if(l<this.viewItems.length-1){const u=h.visible?m+d-r/2+this.margin/2:m;this._orientation===P.HORIZONTAL&&(this.sashes[l].container.style.left=`${u}px`,this.sashes[l].container.style.top="0px"),this._orientation===P.VERTICAL&&(this.sashes[l].container.style.left="0px",this.sashes[l].container.style.top=`${u}px`)}this._orientation===P.HORIZONTAL&&(h.container.style.width=`${d}px`,h.container.style.left=`${m}px`,h.container.style.top="",h.container.style.height=""),this._orientation===P.VERTICAL&&(h.container.style.height=`${d}px`,h.container.style.top=`${m}px`,h.container.style.width="",h.container.style.left=""),h.view.layout(h.size-i,this._orthogonalSize)})}findFirstSnapIndex(e){for(const t of e){const i=this.viewItems[t];if(i.visible&&i.snap)return t}for(const t of e){const i=this.viewItems[t];if(i.visible&&i.maximumSize-i.minimumSize>0)return;if(!i.visible&&i.snap)return t}}updateSashEnablement(){let e=!1;const t=this.viewItems.map(h=>e=h.size-h.minimumSize>0||e);e=!1;const i=this.viewItems.map(h=>e=h.maximumSize-h.size>0||e),s=[...this.viewItems].reverse();e=!1;const n=s.map(h=>e=h.size-h.minimumSize>0||e).reverse();e=!1;const r=s.map(h=>e=h.maximumSize-h.size>0||e).reverse();let a=0;for(let h=0;h<this.sashes.length;h++){const l=this.sashes[h],d=this.viewItems[h];a+=d.size;const c=!(t[h]&&r[h+1]),m=!(i[h]&&n[h+1]);if(c&&m){const u=X(h,-1),v=X(h+1,this.viewItems.length),p=this.findFirstSnapIndex(u),g=this.findFirstSnapIndex(v),b=typeof p=="number"&&!this.viewItems[p].visible,y=typeof g=="number"&&!this.viewItems[g].visible;b&&n[h]&&(a>0||this.startSnappingEnabled)?this.updateSash(l,q.MINIMUM):y&&t[h]&&(a<this._contentSize||this.endSnappingEnabled)?this.updateSash(l,q.MAXIMUM):this.updateSash(l,q.DISABLED)}else c&&!m?this.updateSash(l,q.MINIMUM):!c&&m?this.updateSash(l,q.MAXIMUM):this.updateSash(l,q.ENABLED)}}updateSash(e,t){A(e.container,"dv-disabled",t===q.DISABLED),A(e.container,"dv-enabled",t===q.ENABLED),A(e.container,"dv-maximum",t===q.MAXIMUM),A(e.container,"dv-minimum",t===q.MINIMUM)}createViewContainer(){const e=document.createElement("div");return e.className="dv-view-container",e}createSashContainer(){const e=document.createElement("div");return e.className="dv-sash-container",e}createContainer(){const e=document.createElement("div"),t=this._orientation===P.HORIZONTAL?"dv-horizontal":"dv-vertical";return e.className=`dv-split-view-container ${t}`,e}dispose(){this._onDidSashEnd.dispose(),this._onDidAddView.dispose(),this._onDidRemoveView.dispose();for(let e=0;e<this.element.children.length;e++)if(this.element.children.item(e)===this.element){this.element.removeChild(this.element);break}for(const e of this.viewItems)e.dispose();this.element.remove()}}class N{get minimumWidth(){return this.view.minimumWidth}get maximumWidth(){return this.view.maximumWidth}get minimumHeight(){return this.view.minimumHeight}get maximumHeight(){return this.view.maximumHeight}get priority(){return this.view.priority}get snap(){return this.view.snap}get minimumSize(){return this.orientation===P.HORIZONTAL?this.minimumHeight:this.minimumWidth}get maximumSize(){return this.orientation===P.HORIZONTAL?this.maximumHeight:this.maximumWidth}get minimumOrthogonalSize(){return this.orientation===P.HORIZONTAL?this.minimumWidth:this.minimumHeight}get maximumOrthogonalSize(){return this.orientation===P.HORIZONTAL?this.maximumWidth:this.maximumHeight}get orthogonalSize(){return this._orthogonalSize}get size(){return this._size}get element(){return this.view.element}get width(){return this.orientation===P.HORIZONTAL?this.orthogonalSize:this.size}get height(){return this.orientation===P.HORIZONTAL?this.size:this.orthogonalSize}constructor(e,t,i,s=0){this.view=e,this.orientation=t,this._onDidChange=new f,this.onDidChange=this._onDidChange.event,this._orthogonalSize=i,this._size=s,this._disposable=this.view.onDidChange(n=>{n?this._onDidChange.fire({size:this.orientation===P.VERTICAL?n.width:n.height,orthogonalSize:this.orientation===P.VERTICAL?n.height:n.width}):this._onDidChange.fire({})})}setVisible(e){this.view.setVisible&&this.view.setVisible(e)}layout(e,t){this._size=e,this._orthogonalSize=t,this.view.layout(this.width,this.height)}dispose(){this._onDidChange.dispose(),this._disposable.dispose()}}class T extends E{get width(){return this.orientation===P.HORIZONTAL?this.size:this.orthogonalSize}get height(){return this.orientation===P.HORIZONTAL?this.orthogonalSize:this.size}get minimumSize(){return this.children.length===0?0:Math.max(...this.children.map((e,t)=>this.splitview.isViewVisible(t)?e.minimumOrthogonalSize:0))}get maximumSize(){return Math.min(...this.children.map((e,t)=>this.splitview.isViewVisible(t)?e.maximumOrthogonalSize:Number.POSITIVE_INFINITY))}get minimumOrthogonalSize(){return this.splitview.minimumSize}get maximumOrthogonalSize(){return this.splitview.maximumSize}get orthogonalSize(){return this._orthogonalSize}get size(){return this._size}get minimumWidth(){return this.orientation===P.HORIZONTAL?this.minimumOrthogonalSize:this.minimumSize}get minimumHeight(){return this.orientation===P.HORIZONTAL?this.minimumSize:this.minimumOrthogonalSize}get maximumWidth(){return this.orientation===P.HORIZONTAL?this.maximumOrthogonalSize:this.maximumSize}get maximumHeight(){return this.orientation===P.HORIZONTAL?this.maximumSize:this.maximumOrthogonalSize}get priority(){if(this.children.length===0)return V.Normal;const e=this.children.map(t=>typeof t.priority>"u"?V.Normal:t.priority);return e.some(t=>t===V.High)?V.High:e.some(t=>t===V.Low)?V.Low:V.Normal}get disabled(){return this.splitview.disabled}set disabled(e){this.splitview.disabled=e}get margin(){return this.splitview.margin}set margin(e){this.splitview.margin=e,this.children.forEach(t=>{t instanceof T&&(t.margin=e)})}constructor(e,t,i,s,n,r,a,h){if(super(),this.orientation=e,this.proportionalLayout=t,this.styles=i,this._childrenDisposable=W.NONE,this.children=[],this._onDidChange=new f,this.onDidChange=this._onDidChange.event,this._onDidVisibilityChange=new f,this.onDidVisibilityChange=this._onDidVisibilityChange.event,this._orthogonalSize=n,this._size=s,this.element=document.createElement("div"),this.element.className="dv-branch-node",!h)this.splitview=new tt(this.element,{orientation:this.orientation,proportionalLayout:t,styles:i,margin:a}),this.splitview.layout(this.size,this.orthogonalSize);else{const l={views:h.map(d=>({view:d.node,size:d.node.size,visible:d.node instanceof N&&d.visible!==void 0?d.visible:!0})),size:this.orthogonalSize};this.children=h.map(d=>d.node),this.splitview=new tt(this.element,{orientation:this.orientation,descriptor:l,proportionalLayout:t,styles:i,margin:a})}this.disabled=r,this.addDisposables(this._onDidChange,this._onDidVisibilityChange,this.splitview.onDidSashEnd(()=>{this._onDidChange.fire({})})),this.setupChildrenEvents()}setVisible(e){}isChildVisible(e){if(e<0||e>=this.children.length)throw new Error("Invalid index");return this.splitview.isViewVisible(e)}setChildVisible(e,t){if(e<0||e>=this.children.length)throw new Error("Invalid index");if(this.splitview.isViewVisible(e)===t)return;const i=this.splitview.contentSize===0;this.splitview.setViewVisible(e,t);const s=this.splitview.contentSize===0;(t&&i||!t&&s)&&this._onDidVisibilityChange.fire({visible:t})}moveChild(e,t){if(e===t)return;if(e<0||e>=this.children.length)throw new Error("Invalid from index");e<t&&t--,this.splitview.moveView(e,t);const i=this._removeChild(e);this._addChild(i,t)}getChildSize(e){if(e<0||e>=this.children.length)throw new Error("Invalid index");return this.splitview.getViewSize(e)}resizeChild(e,t){if(e<0||e>=this.children.length)throw new Error("Invalid index");this.splitview.resizeView(e,t)}layout(e,t){this._size=t,this._orthogonalSize=e,this.splitview.layout(t,e)}addChild(e,t,i,s){if(i<0||i>this.children.length)throw new Error("Invalid index");this.splitview.addView(e,t,i,s),this._addChild(e,i)}getChildCachedVisibleSize(e){if(e<0||e>=this.children.length)throw new Error("Invalid index");return this.splitview.getViewCachedVisibleSize(e)}removeChild(e,t){if(e<0||e>=this.children.length)throw new Error("Invalid index");return this.splitview.removeView(e,t),this._removeChild(e)}_addChild(e,t){this.children.splice(t,0,e),this.setupChildrenEvents()}_removeChild(e){const[t]=this.children.splice(e,1);return this.setupChildrenEvents(),t}setupChildrenEvents(){this._childrenDisposable.dispose(),this._childrenDisposable=new E(he.any(...this.children.map(e=>e.onDidChange))(e=>{this._onDidChange.fire({size:e.orthogonalSize})}),...this.children.map((e,t)=>e instanceof T?e.onDidVisibilityChange(({visible:i})=>{this.setChildVisible(t,i)}):W.NONE))}dispose(){this._childrenDisposable.dispose(),this.splitview.dispose(),this.children.forEach(e=>e.dispose()),super.dispose()}}function ke(o,e){if(o instanceof N)return o;if(o instanceof T)return ke(o.children[e?o.children.length-1:0],e);throw new Error("invalid node")}function wt(o,e,t){if(o instanceof T){const i=new T(o.orientation,o.proportionalLayout,o.styles,e,t,o.disabled,o.margin);for(let s=o.children.length-1;s>=0;s--){const n=o.children[s];i.addChild(wt(n,n.size,n.orthogonalSize),n.size,0,!0)}return i}else return new N(o.view,o.orientation,t)}function Re(o,e,t){if(o instanceof T){const i=new T(J(o.orientation),o.proportionalLayout,o.styles,e,t,o.disabled,o.margin);let s=0;for(let n=o.children.length-1;n>=0;n--){const r=o.children[n],a=r instanceof T?r.orthogonalSize:r.size;let h=o.size===0?0:Math.round(e*a/o.size);s+=h,n===0&&(h+=e-s),i.addChild(Re(r,t,h),h,0,!0)}return i}else return new N(o.view,J(o.orientation),t)}function ii(o){const e=o.parentElement;if(!e)throw new Error("Invalid grid element");let t=e.firstElementChild,i=0;for(;t!==o&&t!==e.lastElementChild&&t;)t=t.nextElementSibling,i++;return i}function B(o){const e=o.parentElement;if(!e)throw new Error("Invalid grid element");if(/\bdv-grid-view\b/.test(e.className))return[];const t=ii(e),i=e.parentElement.parentElement.parentElement;return[...B(i),t]}function ce(o,e,t){const i=si(o,e),s=ni(t);if(i===s){const[n,r]=re(e);let a=r;return(t==="right"||t==="bottom")&&(a+=1),[...n,a]}else{const n=t==="right"||t==="bottom"?1:0;return[...e,n]}}function ni(o){return o==="top"||o==="bottom"?P.VERTICAL:P.HORIZONTAL}function si(o,e){return e.length%2===0?J(o):o}const J=o=>o===P.HORIZONTAL?P.VERTICAL:P.HORIZONTAL;function oi(o){return!!o.children}const Ve=(o,e)=>{const t=e===P.VERTICAL?o.box.width:o.box.height;return oi(o)?{type:"branch",data:o.children.map(i=>Ve(i,J(e))),size:t}:typeof o.cachedVisibleSize=="number"?{type:"leaf",data:o.view.toJSON(),size:o.cachedVisibleSize,visible:!1}:{type:"leaf",data:o.view.toJSON(),size:t}};class ri{get length(){return this._root?this._root.children.length:0}get orientation(){return this.root.orientation}set orientation(e){if(this.root.orientation===e)return;const{size:t,orthogonalSize:i}=this.root;this.root=Re(this.root,i,t),this.root.layout(t,i)}get width(){return this.root.width}get height(){return this.root.height}get minimumWidth(){return this.root.minimumWidth}get minimumHeight(){return this.root.minimumHeight}get maximumWidth(){return this.root.maximumHeight}get maximumHeight(){return this.root.maximumHeight}get locked(){return this._locked}set locked(e){this._locked=e;const t=[this.root];for(;t.length>0;){const i=t.pop();i instanceof T&&(i.disabled=e,t.push(...i.children))}}get margin(){return this._margin}set margin(e){this._margin=e,this.root.margin=e}maximizedView(){var e;return(e=this._maximizedNode)===null||e===void 0?void 0:e.leaf.view}hasMaximizedView(){return this._maximizedNode!==void 0}maximizeView(e){var t;const i=B(e.element),[s,n]=this.getNode(i);if(!(n instanceof N)||((t=this._maximizedNode)===null||t===void 0?void 0:t.leaf)===n)return;this.hasMaximizedView()&&this.exitMaximizedView(),Ve(this.getView(),this.orientation);const r=[];function a(h,l){for(let d=0;d<h.children.length;d++){const c=h.children[d];c instanceof N?c!==l&&(h.isChildVisible(d)?h.setChildVisible(d,!1):r.push(c)):a(c,l)}}a(this.root,n),this._maximizedNode={leaf:n,hiddenOnMaximize:r},this._onDidMaximizedNodeChange.fire({view:n.view,isMaximized:!0})}exitMaximizedView(){if(!this._maximizedNode)return;const e=this._maximizedNode.hiddenOnMaximize;function t(s){for(let n=s.children.length-1;n>=0;n--){const r=s.children[n];r instanceof N?e.includes(r)||s.setChildVisible(n,!0):t(r)}}t(this.root);const i=this._maximizedNode.leaf;this._maximizedNode=void 0,this._onDidMaximizedNodeChange.fire({view:i.view,isMaximized:!1})}serialize(){const e=this.maximizedView();let t;e&&(t=B(e.element)),this.hasMaximizedView()&&this.exitMaximizedView();const s={root:Ve(this.getView(),this.orientation),width:this.width,height:this.height,orientation:this.orientation};return t&&(s.maximizedNode={location:t}),e&&this.maximizeView(e),s}dispose(){this.disposable.dispose(),this._onDidChange.dispose(),this._onDidMaximizedNodeChange.dispose(),this._onDidViewVisibilityChange.dispose(),this.root.dispose(),this._maximizedNode=void 0,this.element.remove()}clear(){const e=this.root.orientation;this.root=new T(e,this.proportionalLayout,this.styles,this.root.size,this.root.orthogonalSize,this.locked,this.margin)}deserialize(e,t){const i=e.orientation,s=i===P.VERTICAL?e.height:e.width;if(this._deserialize(e.root,i,t,s),this.layout(e.width,e.height),e.maximizedNode){const n=e.maximizedNode.location,[r,a]=this.getNode(n);if(!(a instanceof N))return;this.maximizeView(a.view)}}_deserialize(e,t,i,s){this.root=this._deserializeNode(e,t,i,s)}_deserializeNode(e,t,i,s){var n;let r;if(e.type==="branch"){const h=e.data.map(l=>({node:this._deserializeNode(l,J(t),i,e.size),visible:l.visible}));r=new T(t,this.proportionalLayout,this.styles,e.size,s,this.locked,this.margin,h)}else{const a=i.fromJSON(e);typeof e.visible=="boolean"&&((n=a.setVisible)===null||n===void 0||n.call(a,e.visible)),r=new N(a,t,s,e.size)}return r}get root(){return this._root}set root(e){const t=this._root;t&&(t.dispose(),this._maximizedNode=void 0,this.element.removeChild(t.element)),this._root=e,this.element.appendChild(this._root.element),this.disposable.value=this._root.onDidChange(i=>{this._onDidChange.fire(i)})}normalize(){if(!this._root||this._root.children.length!==1)return;const e=this.root,t=e.children[0];if(t instanceof N)return;e.element.remove();const i=e.removeChild(0);e.dispose(),i.dispose(),this._root=wt(t,t.size,t.orthogonalSize),this.element.appendChild(this._root.element),this.disposable.value=this._root.onDidChange(s=>{this._onDidChange.fire(s)})}insertOrthogonalSplitviewAtRoot(){if(!this._root)return;const e=this.root;if(e.element.remove(),this._root=new T(J(e.orientation),this.proportionalLayout,this.styles,this.root.orthogonalSize,this.root.size,this.locked,this.margin),e.children.length!==0)if(e.children.length===1){const t=e.children[0];e.removeChild(0).dispose(),e.dispose(),this._root.addChild(Re(t,t.orthogonalSize,t.size),te.Distribute,0)}else this._root.addChild(e,te.Distribute,0);this.element.appendChild(this._root.element),this.disposable.value=this._root.onDidChange(t=>{this._onDidChange.fire(t)})}next(e){return this.progmaticSelect(e)}previous(e){return this.progmaticSelect(e,!0)}getView(e){const t=e?this.getNode(e)[1]:this.root;return this._getViews(t,this.orientation)}_getViews(e,t,i){const s={height:e.height,width:e.width};if(e instanceof N)return{box:s,view:e.view,cachedVisibleSize:i};const n=[];for(let r=0;r<e.children.length;r++){const a=e.children[r],h=e.getChildCachedVisibleSize(r);n.push(this._getViews(a,J(t),h))}return{box:s,children:n}}progmaticSelect(e,t=!1){const[i,s]=this.getNode(e);if(!(s instanceof N))throw new Error("invalid location");for(let n=i.length-1;n>-1;n--){const r=i[n],a=e[n]||0;if(t?a-1>-1:a+1<r.children.length)return ke(r.children[t?a-1:a+1],t)}return ke(this.root,t)}constructor(e,t,i,s,n){this.proportionalLayout=e,this.styles=t,this._locked=!1,this._margin=0,this._maximizedNode=void 0,this.disposable=new Y,this._onDidChange=new f,this.onDidChange=this._onDidChange.event,this._onDidViewVisibilityChange=new f,this.onDidViewVisibilityChange=this._onDidViewVisibilityChange.event,this._onDidMaximizedNodeChange=new f,this.onDidMaximizedNodeChange=this._onDidMaximizedNodeChange.event,this.element=document.createElement("div"),this.element.className="dv-grid-view",this._locked=s??!1,this._margin=n??0,this.root=new T(i,e,t,0,0,this.locked,this.margin)}isViewVisible(e){const[t,i]=re(e),[,s]=this.getNode(t);if(!(s instanceof T))throw new Error("Invalid from location");return s.isChildVisible(i)}setViewVisible(e,t){this.hasMaximizedView()&&this.exitMaximizedView();const[i,s]=re(e),[,n]=this.getNode(i);if(!(n instanceof T))throw new Error("Invalid from location");this._onDidViewVisibilityChange.fire(),n.setChildVisible(s,t)}moveView(e,t,i){this.hasMaximizedView()&&this.exitMaximizedView();const[,s]=this.getNode(e);if(!(s instanceof T))throw new Error("Invalid location");s.moveChild(t,i)}addView(e,t,i){this.hasMaximizedView()&&this.exitMaximizedView();const[s,n]=re(i),[r,a]=this.getNode(s);if(a instanceof T){const h=new N(e,J(a.orientation),a.orthogonalSize);a.addChild(h,t,n)}else{const[h,...l]=[...r].reverse(),[d,...c]=[...s].reverse();let m=0;const u=h.getChildCachedVisibleSize(d);typeof u=="number"&&(m=te.Invisible(u)),h.removeChild(d).dispose();const p=new T(a.orientation,this.proportionalLayout,this.styles,a.size,a.orthogonalSize,this.locked,this.margin);h.addChild(p,a.size,d);const g=new N(a.view,h.orientation,a.size);p.addChild(g,m,0),typeof t!="number"&&t.type==="split"&&(t={type:"split",index:0});const b=new N(e,h.orientation,a.size);p.addChild(b,t,n)}}remove(e,t){const i=B(e.element);return this.removeView(i,t)}removeView(e,t){this.hasMaximizedView()&&this.exitMaximizedView();const[i,s]=re(e),[n,r]=this.getNode(i);if(!(r instanceof T))throw new Error("Invalid location");const a=r.children[s];if(!(a instanceof N))throw new Error("Invalid location");if(r.removeChild(s,t),a.dispose(),r.children.length!==1)return a.view;const h=r.children[0];if(n.length===0)return h instanceof N||(r.removeChild(0,t),this.root=h),a.view;const[l,...d]=[...n].reverse(),[c,...m]=[...i].reverse(),u=r.isChildVisible(0);r.removeChild(0,t);const v=l.children.map((p,g)=>l.getChildSize(g));if(l.removeChild(c,t).dispose(),h instanceof T){v.splice(c,1,...h.children.map(p=>p.size));for(let p=0;p<h.children.length;p++){const g=h.children[p];l.addChild(g,g.size,c+p)}for(;h.children.length>0;)h.removeChild(0)}else{const p=new N(h.view,J(h.orientation),h.size),g=u?h.orthogonalSize:te.Invisible(h.orthogonalSize);l.addChild(p,g,c)}h.dispose();for(let p=0;p<v.length;p++)l.resizeChild(p,v[p]);return a.view}layout(e,t){const[i,s]=this.root.orientation===P.HORIZONTAL?[t,e]:[e,t];this.root.layout(i,s)}getNode(e,t=this.root,i=[]){if(e.length===0)return[i,t];if(!(t instanceof T))throw new Error("Invalid location");const[s,...n]=e;if(s<0||s>=t.children.length)throw new Error("Invalid location");const r=t.children[s];return i.push(t),this.getNode(n,r,i)}}class ai extends E{get element(){return this._element}get disableResizing(){return this._disableResizing}set disableResizing(e){this._disableResizing=e}constructor(e,t=!1){super(),this._disableResizing=t,this._element=e,this.addDisposables(Se(this._element,i=>{if(this.isDisposed||this.disableResizing||!this._element.offsetParent||!Ut(this._element))return;const{width:s,height:n}=i.contentRect;this.layout(s,n)}))}}const hi=_t();function it(o){switch(o){case"left":return"left";case"right":return"right";case"above":return"top";case"below":return"bottom";case"within":default:return"center"}}class li extends ai{get id(){return this._id}get size(){return this._groups.size}get groups(){return Array.from(this._groups.values()).map(e=>e.value)}get width(){return this.gridview.width}get height(){return this.gridview.height}get minimumHeight(){return this.gridview.minimumHeight}get maximumHeight(){return this.gridview.maximumHeight}get minimumWidth(){return this.gridview.minimumWidth}get maximumWidth(){return this.gridview.maximumWidth}get activeGroup(){return this._activeGroup}get locked(){return this.gridview.locked}set locked(e){this.gridview.locked=e}constructor(e,t){var i;super(document.createElement("div"),t.disableAutoResizing),this._id=hi.next(),this._groups=new Map,this._onDidRemove=new f,this.onDidRemove=this._onDidRemove.event,this._onDidAdd=new f,this.onDidAdd=this._onDidAdd.event,this._onDidMaximizedChange=new f,this.onDidMaximizedChange=this._onDidMaximizedChange.event,this._onDidActiveChange=new f,this.onDidActiveChange=this._onDidActiveChange.event,this._bufferOnDidLayoutChange=new Qe,this.onDidLayoutChange=this._bufferOnDidLayoutChange.onEvent,this._onDidViewVisibilityChangeMicroTaskQueue=new Qe,this.onDidViewVisibilityChangeMicroTaskQueue=this._onDidViewVisibilityChangeMicroTaskQueue.onEvent,this.element.style.height="100%",this.element.style.width="100%",this._classNames=new vt(this.element),this._classNames.setClassNames((i=t.className)!==null&&i!==void 0?i:""),e.appendChild(this.element),this.gridview=new ri(!!t.proportionalLayout,t.styles,t.orientation,t.locked,t.margin),this.gridview.locked=!!t.locked,this.element.appendChild(this.gridview.element),this.layout(0,0,!0),this.addDisposables(this.gridview.onDidMaximizedNodeChange(s=>{this._onDidMaximizedChange.fire({panel:s.view,isMaximized:s.isMaximized})}),this.gridview.onDidViewVisibilityChange(()=>this._onDidViewVisibilityChangeMicroTaskQueue.fire()),this.onDidViewVisibilityChangeMicroTaskQueue(()=>{this.layout(this.width,this.height,!0)}),W.from(()=>{var s;(s=this.element.parentElement)===null||s===void 0||s.removeChild(this.element)}),this.gridview.onDidChange(()=>{this._bufferOnDidLayoutChange.fire()}),he.any(this.onDidAdd,this.onDidRemove,this.onDidActiveChange)(()=>{this._bufferOnDidLayoutChange.fire()}),this._onDidMaximizedChange,this._onDidViewVisibilityChangeMicroTaskQueue,this._bufferOnDidLayoutChange)}setVisible(e,t){this.gridview.setViewVisible(B(e.element),t),this._bufferOnDidLayoutChange.fire()}isVisible(e){return this.gridview.isViewVisible(B(e.element))}updateOptions(e){var t,i,s,n;e.proportionalLayout,e.orientation&&(this.gridview.orientation=e.orientation),"disableResizing"in e&&(this.disableResizing=(t=e.disableAutoResizing)!==null&&t!==void 0?t:!1),"locked"in e&&(this.locked=(i=e.locked)!==null&&i!==void 0?i:!1),"margin"in e&&(this.gridview.margin=(s=e.margin)!==null&&s!==void 0?s:0),"className"in e&&this._classNames.setClassNames((n=e.className)!==null&&n!==void 0?n:"")}maximizeGroup(e){this.gridview.maximizeView(e),this.doSetGroupActive(e)}isMaximizedGroup(e){return this.gridview.maximizedView()===e}exitMaximizedGroup(){this.gridview.exitMaximizedView()}hasMaximizedGroup(){return this.gridview.hasMaximizedView()}doAddGroup(e,t=[0],i){this.gridview.addView(e,i??te.Distribute,t),this._onDidAdd.fire(e)}doRemoveGroup(e,t){if(!this._groups.has(e.id))throw new Error("invalid operation");const i=this._groups.get(e.id),s=this.gridview.remove(e,te.Distribute);if(i&&!t?.skipDispose&&(i.disposable.dispose(),i.value.dispose(),this._groups.delete(e.id),this._onDidRemove.fire(e)),!t?.skipActive&&this._activeGroup===e){const n=Array.from(this._groups.values());this.doSetGroupActive(n.length>0?n[0].value:void 0)}return s}getPanel(e){var t;return(t=this._groups.get(e))===null||t===void 0?void 0:t.value}doSetGroupActive(e){this._activeGroup!==e&&(this._activeGroup&&this._activeGroup.setActive(!1),e&&e.setActive(!0),this._activeGroup=e,this._onDidActiveChange.fire(e))}removeGroup(e){this.doRemoveGroup(e)}moveToNext(e){var t;if(e||(e={}),!e.group){if(!this.activeGroup)return;e.group=this.activeGroup}const i=B(e.group.element),s=(t=this.gridview.next(i))===null||t===void 0?void 0:t.view;this.doSetGroupActive(s)}moveToPrevious(e){var t;if(e||(e={}),!e.group){if(!this.activeGroup)return;e.group=this.activeGroup}const i=B(e.group.element),s=(t=this.gridview.previous(i))===null||t===void 0?void 0:t.view;this.doSetGroupActive(s)}layout(e,t,i){(i||e!==this.width||t!==this.height)&&(this.gridview.element.style.height=`${t}px`,this.gridview.element.style.width=`${e}px`,this.gridview.layout(e,t))}dispose(){this._onDidActiveChange.dispose(),this._onDidAdd.dispose(),this._onDidRemove.dispose();for(const e of this.groups)e.dispose();this.gridview.dispose(),super.dispose()}}class Ae{get id(){return this.component.id}get width(){return this.component.width}get height(){return this.component.height}get minimumHeight(){return this.component.minimumHeight}get maximumHeight(){return this.component.maximumHeight}get minimumWidth(){return this.component.minimumWidth}get maximumWidth(){return this.component.maximumWidth}get size(){return this.component.size}get totalPanels(){return this.component.totalPanels}get onDidActiveGroupChange(){return this.component.onDidActiveGroupChange}get onDidAddGroup(){return this.component.onDidAddGroup}get onDidRemoveGroup(){return this.component.onDidRemoveGroup}get onDidActivePanelChange(){return this.component.onDidActivePanelChange}get onDidAddPanel(){return this.component.onDidAddPanel}get onDidRemovePanel(){return this.component.onDidRemovePanel}get onDidMovePanel(){return this.component.onDidMovePanel}get onDidLayoutFromJSON(){return this.component.onDidLayoutFromJSON}get onDidLayoutChange(){return this.component.onDidLayoutChange}get onDidDrop(){return this.component.onDidDrop}get onWillDrop(){return this.component.onWillDrop}get onWillShowOverlay(){return this.component.onWillShowOverlay}get onWillDragGroup(){return this.component.onWillDragGroup}get onWillDragPanel(){return this.component.onWillDragPanel}get onUnhandledDragOverEvent(){return this.component.onUnhandledDragOverEvent}get onDidPopoutGroupSizeChange(){return this.component.onDidPopoutGroupSizeChange}get onDidPopoutGroupPositionChange(){return this.component.onDidPopoutGroupPositionChange}get onDidOpenPopoutWindowFail(){return this.component.onDidOpenPopoutWindowFail}get panels(){return this.component.panels}get groups(){return this.component.groups}get activePanel(){return this.component.activePanel}get activeGroup(){return this.component.activeGroup}constructor(e){this.component=e}focus(){this.component.focus()}getPanel(e){return this.component.getGroupPanel(e)}layout(e,t,i=!1){this.component.layout(e,t,i)}addPanel(e){return this.component.addPanel(e)}removePanel(e){this.component.removePanel(e)}addGroup(e){return this.component.addGroup(e)}closeAllGroups(){return this.component.closeAllGroups()}removeGroup(e){this.component.removeGroup(e)}getGroup(e){return this.component.getPanel(e)}addFloatingGroup(e,t){return this.component.addFloatingGroup(e,t)}fromJSON(e){this.component.fromJSON(e)}toJSON(){return this.component.toJSON()}clear(){this.component.clear()}moveToNext(e){this.component.moveToNext(e)}moveToPrevious(e){this.component.moveToPrevious(e)}maximizeGroup(e){this.component.maximizeGroup(e.group)}hasMaximizedGroup(){return this.component.hasMaximizedGroup()}exitMaximizedGroup(){this.component.exitMaximizedGroup()}get onDidMaximizedGroupChange(){return this.component.onDidMaximizedGroupChange}addPopoutGroup(e,t){return this.component.addPopoutGroup(e,t)}updateOptions(e){this.component.updateOptions(e)}dispose(){this.component.dispose()}}class bt extends E{constructor(e,t){super(),this.el=e,this.disabled=t,this.dataDisposable=new Y,this.pointerEventsDisposable=new Y,this._onDragStart=new f,this.onDragStart=this._onDragStart.event,this.addDisposables(this._onDragStart,this.dataDisposable,this.pointerEventsDisposable),this.configure()}setDisabled(e){this.disabled=e}isCancelled(e){return!1}configure(){this.addDisposables(this._onDragStart,I(this.el,"dragstart",e=>{if(e.defaultPrevented||this.isCancelled(e)||this.disabled){e.preventDefault();return}const t=xe();this.pointerEventsDisposable.value={dispose:()=>{t.release()}},this.el.classList.add("dv-dragged"),setTimeout(()=>this.el.classList.remove("dv-dragged"),0),this.dataDisposable.value=this.getData(e),this._onDragStart.fire(e),e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.items.length>0||e.dataTransfer.setData("text/plain",""))}),I(this.el,"dragend",()=>{this.pointerEventsDisposable.dispose(),setTimeout(()=>{this.dataDisposable.dispose()},0)}))}}class Dt extends E{constructor(e,t){super(),this.element=e,this.callbacks=t,this.target=null,this.registerListeners()}onDragEnter(e){this.target=e.target,this.callbacks.onDragEnter(e)}onDragOver(e){e.preventDefault(),this.callbacks.onDragOver&&this.callbacks.onDragOver(e)}onDragLeave(e){this.target===e.target&&(this.target=null,this.callbacks.onDragLeave(e))}onDragEnd(e){this.target=null,this.callbacks.onDragEnd(e)}onDrop(e){this.callbacks.onDrop(e)}registerListeners(){this.addDisposables(I(this.element,"dragenter",e=>{this.onDragEnter(e)},!0)),this.addDisposables(I(this.element,"dragover",e=>{this.onDragOver(e)},!0)),this.addDisposables(I(this.element,"dragleave",e=>{this.onDragLeave(e)})),this.addDisposables(I(this.element,"dragend",e=>{this.onDragEnd(e)})),this.addDisposables(I(this.element,"drop",e=>{this.onDrop(e)}))}}function di(o,e){const{top:t,left:i,width:s,height:n}=e,r=`${Math.round(t)}px`,a=`${Math.round(i)}px`,h=`${Math.round(s)}px`,l=`${Math.round(n)}px`;o.style.top=r,o.style.left=a,o.style.width=h,o.style.height=l,o.style.visibility="visible",(!o.style.transform||o.style.transform==="")&&(o.style.transform="translate3d(0, 0, 0)")}function ci(o,e){const{top:t,left:i,width:s,height:n}=e;o.style.top=t,o.style.left=i,o.style.width=s,o.style.height=n,o.style.visibility="visible",(!o.style.transform||o.style.transform==="")&&(o.style.transform="translate3d(0, 0, 0)")}function ui(o,e){const{top:t,left:i,width:s,height:n}=e,r=`${Math.round(t)}px`,a=`${Math.round(i)}px`,h=`${Math.round(s)}px`,l=`${Math.round(n)}px`;return o.style.top!==r||o.style.left!==a||o.style.width!==h||o.style.height!==l}class pi extends $e{get nativeEvent(){return this.options.nativeEvent}get position(){return this.options.position}constructor(e){super(),this.options=e}}function nt(o){switch(o){case"above":return"top";case"below":return"bottom";case"left":return"left";case"right":return"right";case"within":return"center";default:throw new Error(`invalid direction '${o}'`)}}function mi(o){switch(o){case"top":return"above";case"bottom":return"below";case"left":return"left";case"right":return"right";case"center":return"within";default:throw new Error(`invalid position '${o}'`)}}const fi={value:20,type:"percentage"},vi={value:50,type:"percentage"},gi=100,_i=100;class Q extends E{get disabled(){return this._disabled}set disabled(e){this._disabled=e}get state(){return this._state}constructor(e,t){super(),this.element=e,this.options=t,this._onDrop=new f,this.onDrop=this._onDrop.event,this._onWillShowOverlay=new f,this.onWillShowOverlay=this._onWillShowOverlay.event,this._disabled=!1,this._acceptedTargetZonesSet=new Set(this.options.acceptedTargetZones),this.dnd=new Dt(this.element,{onDragEnter:()=>{var i,s,n;(n=(s=(i=this.options).getOverrideTarget)===null||s===void 0?void 0:s.call(i))===null||n===void 0||n.getElements()},onDragOver:i=>{var s,n,r,a,h,l,d;Q.ACTUAL_TARGET=this;const c=(n=(s=this.options).getOverrideTarget)===null||n===void 0?void 0:n.call(s);if(this._acceptedTargetZonesSet.size===0){if(c)return;this.removeDropTarget();return}const m=(h=(a=(r=this.options).getOverlayOutline)===null||a===void 0?void 0:a.call(r))!==null&&h!==void 0?h:this.element,u=m.offsetWidth,v=m.offsetHeight;if(u===0||v===0)return;const p=i.currentTarget.getBoundingClientRect(),g=((l=i.clientX)!==null&&l!==void 0?l:0)-p.left,b=((d=i.clientY)!==null&&d!==void 0?d:0)-p.top,y=this.calculateQuadrant(this._acceptedTargetZonesSet,g,b,u,v);if(this.isAlreadyUsed(i)||y===null){this.removeDropTarget();return}if(!this.options.canDisplayOverlay(i,y)){if(c)return;this.removeDropTarget();return}const D=new pi({nativeEvent:i,position:y});if(this._onWillShowOverlay.fire(D),D.defaultPrevented){this.removeDropTarget();return}this.markAsUsed(i),c||this.targetElement||(this.targetElement=document.createElement("div"),this.targetElement.className="dv-drop-target-dropzone",this.overlayElement=document.createElement("div"),this.overlayElement.className="dv-drop-target-selection",this._state="center",this.targetElement.appendChild(this.overlayElement),m.classList.add("dv-drop-target"),m.append(this.targetElement)),this.toggleClasses(y,u,v),this._state=y},onDragLeave:()=>{var i,s;!((s=(i=this.options).getOverrideTarget)===null||s===void 0)&&s.call(i)||this.removeDropTarget()},onDragEnd:i=>{var s,n;const r=(n=(s=this.options).getOverrideTarget)===null||n===void 0?void 0:n.call(s);r&&Q.ACTUAL_TARGET===this&&this._state&&(i.stopPropagation(),this._onDrop.fire({position:this._state,nativeEvent:i})),this.removeDropTarget(),r?.clear()},onDrop:i=>{var s,n,r;i.preventDefault();const a=this._state;this.removeDropTarget(),(r=(n=(s=this.options).getOverrideTarget)===null||n===void 0?void 0:n.call(s))===null||r===void 0||r.clear(),a&&(i.stopPropagation(),this._onDrop.fire({position:a,nativeEvent:i}))}}),this.addDisposables(this._onDrop,this._onWillShowOverlay,this.dnd)}setTargetZones(e){this._acceptedTargetZonesSet=new Set(e)}setOverlayModel(e){this.options.overlayModel=e}dispose(){this.removeDropTarget(),super.dispose()}markAsUsed(e){e[Q.USED_EVENT_ID]=!0}isAlreadyUsed(e){const t=e[Q.USED_EVENT_ID];return typeof t=="boolean"&&t}toggleClasses(e,t,i){var s,n,r,a,h,l,d;const c=(n=(s=this.options).getOverrideTarget)===null||n===void 0?void 0:n.call(s);if(!c&&!this.overlayElement)return;const m=t<gi,u=i<_i,v=e==="left",p=e==="right",g=e==="top",b=e==="bottom",y=!m&&p,D=!m&&v,_=!u&&g,x=!u&&b;let C=1;const M=(a=(r=this.options.overlayModel)===null||r===void 0?void 0:r.size)!==null&&a!==void 0?a:vi;if(M.type==="percentage"?C=O(M.value,0,100)/100:((y||D)&&(C=O(0,M.value,t)/t),(_||x)&&(C=O(0,M.value,i)/i)),c){const U=(d=(l=(h=this.options).getOverlayOutline)===null||l===void 0?void 0:l.call(h))!==null&&d!==void 0?d:this.element,k=U.getBoundingClientRect(),H=c.getElements(void 0,U),j=H.root,G=H.overlay,z=j.getBoundingClientRect(),w=k.top-z.top,S=k.left-z.left,R={top:w,left:S,width:t,height:i};if(y?(R.left=S+t*(1-C),R.width=t*C):D?R.width=t*C:_?R.height=i*C:x&&(R.top=w+i*(1-C),R.height=i*C),m&&v&&(R.width=4),m&&p&&(R.left=S+t-4,R.width=4),!ui(G,R))return;di(G,R),G.className=`dv-drop-target-anchor${this.options.className?` ${this.options.className}`:""}`,A(G,"dv-drop-target-left",v),A(G,"dv-drop-target-right",p),A(G,"dv-drop-target-top",g),A(G,"dv-drop-target-bottom",b),A(G,"dv-drop-target-center",e==="center"),H.changed&&(A(G,"dv-drop-target-anchor-container-changed",!0),setTimeout(()=>{A(G,"dv-drop-target-anchor-container-changed",!1)},10));return}if(!this.overlayElement)return;const L={top:"0px",left:"0px",width:"100%",height:"100%"};y?(L.left=`${100*(1-C)}%`,L.width=`${100*C}%`):D?L.width=`${100*C}%`:_?L.height=`${100*C}%`:x&&(L.top=`${100*(1-C)}%`,L.height=`${100*C}%`),ci(this.overlayElement,L),A(this.overlayElement,"dv-drop-target-small-vertical",u),A(this.overlayElement,"dv-drop-target-small-horizontal",m),A(this.overlayElement,"dv-drop-target-left",v),A(this.overlayElement,"dv-drop-target-right",p),A(this.overlayElement,"dv-drop-target-top",g),A(this.overlayElement,"dv-drop-target-bottom",b),A(this.overlayElement,"dv-drop-target-center",e==="center")}calculateQuadrant(e,t,i,s,n){var r,a;const h=(a=(r=this.options.overlayModel)===null||r===void 0?void 0:r.activationSize)!==null&&a!==void 0?a:fi;return h.type==="percentage"?wi(e,t,i,s,n,h.value):bi(e,t,i,s,n,h.value)}removeDropTarget(){var e;this.targetElement&&(this._state=void 0,(e=this.targetElement.parentElement)===null||e===void 0||e.classList.remove("dv-drop-target"),this.targetElement.remove(),this.targetElement=void 0,this.overlayElement=void 0)}}Q.USED_EVENT_ID="__dockview_droptarget_event_is_used__";function wi(o,e,t,i,s,n){const r=100*e/i,a=100*t/s;return o.has("left")&&r<n?"left":o.has("right")&&r>100-n?"right":o.has("top")&&a<n?"top":o.has("bottom")&&a>100-n?"bottom":o.has("center")?"center":null}function bi(o,e,t,i,s,n){return o.has("left")&&e<n?"left":o.has("right")&&e>i-n?"right":o.has("top")&&t<n?"top":o.has("bottom")&&t>s-n?"bottom":o.has("center")?"center":null}class Ct extends $e{constructor(){super()}}class Di extends E{get isFocused(){return this._isFocused}get isActive(){return this._isActive}get isVisible(){return this._isVisible}get width(){return this._width}get height(){return this._height}constructor(e,t){super(),this.id=e,this.component=t,this._isFocused=!1,this._isActive=!1,this._isVisible=!0,this._width=0,this._height=0,this._parameters={},this.panelUpdatesDisposable=new Y,this._onDidDimensionChange=new f,this.onDidDimensionsChange=this._onDidDimensionChange.event,this._onDidChangeFocus=new f,this.onDidFocusChange=this._onDidChangeFocus.event,this._onWillFocus=new f,this.onWillFocus=this._onWillFocus.event,this._onDidVisibilityChange=new f,this.onDidVisibilityChange=this._onDidVisibilityChange.event,this._onWillVisibilityChange=new f,this.onWillVisibilityChange=this._onWillVisibilityChange.event,this._onDidActiveChange=new f,this.onDidActiveChange=this._onDidActiveChange.event,this._onActiveChange=new f,this.onActiveChange=this._onActiveChange.event,this._onDidParametersChange=new f,this.onDidParametersChange=this._onDidParametersChange.event,this.addDisposables(this.onDidFocusChange(i=>{this._isFocused=i.isFocused}),this.onDidActiveChange(i=>{this._isActive=i.isActive}),this.onDidVisibilityChange(i=>{this._isVisible=i.isVisible}),this.onDidDimensionsChange(i=>{this._width=i.width,this._height=i.height}),this.panelUpdatesDisposable,this._onDidDimensionChange,this._onDidChangeFocus,this._onDidVisibilityChange,this._onDidActiveChange,this._onWillFocus,this._onActiveChange,this._onWillFocus,this._onWillVisibilityChange,this._onDidParametersChange)}getParameters(){return this._parameters}initialize(e){this.panelUpdatesDisposable.value=this._onDidParametersChange.event(t=>{this._parameters=t,e.update({params:t})})}setVisible(e){this._onWillVisibilityChange.fire({isVisible:e})}setActive(){this._onActiveChange.fire()}updateParameters(e){this._onDidParametersChange.fire(e)}}class Ci extends E{get element(){return this._element}get width(){return this._width}get height(){return this._height}get params(){var e;return(e=this._params)===null||e===void 0?void 0:e.params}constructor(e,t,i){super(),this.id=e,this.component=t,this.api=i,this._height=0,this._width=0,this._element=document.createElement("div"),this._element.tabIndex=-1,this._element.style.outline="none",this._element.style.height="100%",this._element.style.width="100%",this._element.style.overflow="hidden";const s=mt(this._element);this.addDisposables(this.api,s.onDidFocus(()=>{this.api._onDidChangeFocus.fire({isFocused:!0})}),s.onDidBlur(()=>{this.api._onDidChangeFocus.fire({isFocused:!1})}),s)}focus(){const e=new Ct;this.api._onWillFocus.fire(e),!e.defaultPrevented&&this._element.focus()}layout(e,t){this._width=e,this._height=t,this.api._onDidDimensionChange.fire({width:e,height:t}),this.part&&this._params&&this.part.update(this._params.params)}init(e){this._params=e,this.part=this.getComponent()}update(e){var t,i;this._params=Object.assign(Object.assign({},this._params),{params:Object.assign(Object.assign({},(t=this._params)===null||t===void 0?void 0:t.params),e.params)});for(const s of Object.keys(e.params))e.params[s]===void 0&&delete this._params.params[s];(i=this.part)===null||i===void 0||i.update({params:this._params.params})}toJSON(){var e,t;const i=(t=(e=this._params)===null||e===void 0?void 0:e.params)!==null&&t!==void 0?t:{};return{id:this.id,component:this.component,params:Object.keys(i).length>0?i:void 0}}dispose(){var e;this.api.dispose(),(e=this.part)===null||e===void 0||e.dispose(),super.dispose()}}class yi extends E{get element(){return this._element}constructor(e,t){super(),this.accessor=e,this.group=t,this.disposable=new Y,this._onDidFocus=new f,this.onDidFocus=this._onDidFocus.event,this._onDidBlur=new f,this.onDidBlur=this._onDidBlur.event,this._element=document.createElement("div"),this._element.className="dv-content-container",this._element.tabIndex=-1,this.addDisposables(this._onDidFocus,this._onDidBlur);const i=t.dropTargetContainer;this.dropTarget=new Q(this.element,{getOverlayOutline:()=>{var s;return((s=e.options.theme)===null||s===void 0?void 0:s.dndPanelOverlay)==="group"?this.element.parentElement:null},className:"dv-drop-target-content",acceptedTargetZones:["top","bottom","left","right","center"],canDisplayOverlay:(s,n)=>{if(this.group.locked==="no-drop-target"||this.group.locked&&n==="center")return!1;const r=$();return!r&&s.shiftKey&&this.group.location.type!=="floating"?!1:r&&r.viewId===this.accessor.id?!0:this.group.canDisplayOverlay(s,n,"content")},getOverrideTarget:i?()=>i.model:void 0}),this.addDisposables(this.dropTarget)}show(){this.element.style.display=""}hide(){this.element.style.display="none"}renderPanel(e,t={asActive:!0}){const i=t.asActive||this.panel&&this.group.isPanelActive(this.panel);this.panel&&this.panel.view.content.element.parentElement===this._element&&this._element.removeChild(this.panel.view.content.element),this.panel=e;let s;switch(e.api.renderer){case"onlyWhenVisible":this.group.renderContainer.detatch(e),this.panel&&i&&this._element.appendChild(this.panel.view.content.element),s=this._element;break;case"always":e.view.content.element.parentElement===this._element&&this._element.removeChild(e.view.content.element),s=this.group.renderContainer.attach({panel:e,referenceContainer:this});break;default:throw new Error(`dockview: invalid renderer type '${e.api.renderer}'`)}if(i){const n=mt(s),r=new E;r.addDisposables(n,n.onDidFocus(()=>this._onDidFocus.fire()),n.onDidBlur(()=>this._onDidBlur.fire())),this.disposable.value=r}}openPanel(e){this.panel!==e&&this.renderPanel(e)}layout(e,t){}closePanel(){var e;this.panel&&this.panel.api.renderer==="onlyWhenVisible"&&((e=this.panel.view.content.element.parentElement)===null||e===void 0||e.removeChild(this.panel.view.content.element)),this.panel=void 0}dispose(){this.disposable.dispose(),super.dispose()}}function yt(o,e,t){var i,s;pt(e,"dv-dragged"),e.style.top="-9999px",document.body.appendChild(e),o.setDragImage(e,(i=t?.x)!==null&&i!==void 0?i:0,(s=t?.y)!==null&&s!==void 0?s:0),setTimeout(()=>{Me(e,"dv-dragged"),e.remove()},0)}class xi extends bt{constructor(e,t,i,s,n){super(e,n),this.accessor=t,this.group=i,this.panel=s,this.panelTransfer=le.getInstance()}getData(e){return this.panelTransfer.setData([new oe(this.accessor.id,this.group.id,this.panel.id)],oe.prototype),{dispose:()=>{this.panelTransfer.clearData(oe.prototype)}}}}class Ai extends E{get element(){return this._element}constructor(e,t,i){super(),this.panel=e,this.accessor=t,this.group=i,this.content=void 0,this._onPointDown=new f,this.onPointerDown=this._onPointDown.event,this._onDropped=new f,this.onDrop=this._onDropped.event,this._onDragStart=new f,this.onDragStart=this._onDragStart.event,this._element=document.createElement("div"),this._element.className="dv-tab",this._element.tabIndex=0,this._element.draggable=!this.accessor.options.disableDnd,A(this.element,"dv-inactive-tab",!0),this.dragHandler=new xi(this._element,this.accessor,this.group,this.panel,!!this.accessor.options.disableDnd),this.dropTarget=new Q(this._element,{acceptedTargetZones:["left","right"],overlayModel:{activationSize:{value:50,type:"percentage"}},canDisplayOverlay:(s,n)=>{if(this.group.locked)return!1;const r=$();return r&&this.accessor.id===r.viewId?!0:this.group.model.canDisplayOverlay(s,n,"tab")},getOverrideTarget:()=>{var s;return(s=i.model.dropTargetContainer)===null||s===void 0?void 0:s.model}}),this.onWillShowOverlay=this.dropTarget.onWillShowOverlay,this.addDisposables(this._onPointDown,this._onDropped,this._onDragStart,this.dragHandler.onDragStart(s=>{if(s.dataTransfer){const n=getComputedStyle(this.element),r=this.element.cloneNode(!0);Array.from(n).forEach(a=>r.style.setProperty(a,n.getPropertyValue(a),n.getPropertyPriority(a))),r.style.position="absolute",yt(s.dataTransfer,r,{y:-10,x:30})}this._onDragStart.fire(s)}),this.dragHandler,I(this._element,"pointerdown",s=>{this._onPointDown.fire(s)}),this.dropTarget.onDrop(s=>{this._onDropped.fire(s)}),this.dropTarget)}setActive(e){A(this.element,"dv-active-tab",e),A(this.element,"dv-inactive-tab",!e)}setContent(e){this.content&&this._element.removeChild(this.content.element),this.content=e,this._element.appendChild(this.content.element)}updateDragAndDropState(){this._element.draggable=!this.accessor.options.disableDnd,this.dragHandler.setDisabled(!!this.accessor.options.disableDnd)}dispose(){super.dispose()}}class Pe{get kind(){return this.options.kind}get nativeEvent(){return this.event.nativeEvent}get position(){return this.event.position}get defaultPrevented(){return this.event.defaultPrevented}get panel(){return this.options.panel}get api(){return this.options.api}get group(){return this.options.group}preventDefault(){this.event.preventDefault()}getData(){return this.options.getData()}constructor(e,t){this.event=e,this.options=t}}class Si extends bt{constructor(e,t,i,s){super(e,s),this.accessor=t,this.group=i,this.panelTransfer=le.getInstance(),this.addDisposables(I(e,"pointerdown",n=>{n.shiftKey&&Bt(n)},!0))}isCancelled(e){return this.group.api.location.type==="floating"&&!e.shiftKey}getData(e){const t=e.dataTransfer;this.panelTransfer.setData([new oe(this.accessor.id,this.group.id,null)],oe.prototype);const i=window.getComputedStyle(this.el),s=i.getPropertyValue("--dv-activegroup-visiblepanel-tab-background-color"),n=i.getPropertyValue("--dv-activegroup-visiblepanel-tab-color");if(t){const r=document.createElement("div");r.style.backgroundColor=s,r.style.color=n,r.style.padding="2px 8px",r.style.height="24px",r.style.fontSize="11px",r.style.lineHeight="20px",r.style.borderRadius="12px",r.style.position="absolute",r.style.pointerEvents="none",r.style.top="-9999px",r.textContent=`Multiple Panels (${this.group.size})`,yt(t,r,{y:-10,x:30})}return{dispose:()=>{this.panelTransfer.clearData(oe.prototype)}}}}class Pi extends E{get element(){return this._element}constructor(e,t){super(),this.accessor=e,this.group=t,this._onDrop=new f,this.onDrop=this._onDrop.event,this._onDragStart=new f,this.onDragStart=this._onDragStart.event,this._element=document.createElement("div"),this._element.className="dv-void-container",this._element.draggable=!this.accessor.options.disableDnd,A(this._element,"dv-draggable",!this.accessor.options.disableDnd),this.addDisposables(this._onDrop,this._onDragStart,I(this._element,"pointerdown",()=>{this.accessor.doSetGroupActive(this.group)})),this.handler=new Si(this._element,e,t,!!this.accessor.options.disableDnd),this.dropTarget=new Q(this._element,{acceptedTargetZones:["center"],canDisplayOverlay:(i,s)=>{const n=$();return n&&this.accessor.id===n.viewId?!0:t.model.canDisplayOverlay(i,s,"header_space")},getOverrideTarget:()=>{var i;return(i=t.model.dropTargetContainer)===null||i===void 0?void 0:i.model}}),this.onWillShowOverlay=this.dropTarget.onWillShowOverlay,this.addDisposables(this.handler,this.handler.onDragStart(i=>{this._onDragStart.fire(i)}),this.dropTarget.onDrop(i=>{this._onDrop.fire(i)}),this.dropTarget)}updateDragAndDropState(){this._element.draggable=!this.accessor.options.disableDnd,A(this._element,"dv-draggable",!this.accessor.options.disableDnd),this.handler.setDisabled(!!this.accessor.options.disableDnd)}}class Ee extends E{get element(){return this._element}constructor(e){super(),this.scrollableElement=e,this._scrollLeft=0,this._element=document.createElement("div"),this._element.className="dv-scrollable",this._horizontalScrollbar=document.createElement("div"),this._horizontalScrollbar.className="dv-scrollbar-horizontal",this.element.appendChild(e),this.element.appendChild(this._horizontalScrollbar),this.addDisposables(I(this.element,"wheel",t=>{this._scrollLeft+=t.deltaY*Ee.MouseWheelSpeed,this.calculateScrollbarStyles()}),I(this._horizontalScrollbar,"pointerdown",t=>{t.preventDefault(),A(this.element,"dv-scrollable-scrolling",!0);const i=t.clientX,s=this._scrollLeft,n=a=>{const h=a.clientX-i,{clientWidth:l}=this.element,{scrollWidth:d}=this.scrollableElement,c=l/d;this._scrollLeft=s+h/c,this.calculateScrollbarStyles()},r=()=>{A(this.element,"dv-scrollable-scrolling",!1),document.removeEventListener("pointermove",n),document.removeEventListener("pointerup",r),document.removeEventListener("pointercancel",r)};document.addEventListener("pointermove",n),document.addEventListener("pointerup",r),document.addEventListener("pointercancel",r)}),I(this.element,"scroll",()=>{this.calculateScrollbarStyles()}),I(this.scrollableElement,"scroll",()=>{this._scrollLeft=this.scrollableElement.scrollLeft,this.calculateScrollbarStyles()}),Se(this.element,()=>{A(this.element,"dv-scrollable-resizing",!0),this._animationTimer&&clearTimeout(this._animationTimer),this._animationTimer=setTimeout(()=>{clearTimeout(this._animationTimer),A(this.element,"dv-scrollable-resizing",!1)},500),this.calculateScrollbarStyles()}))}calculateScrollbarStyles(){const{clientWidth:e}=this.element,{scrollWidth:t}=this.scrollableElement;if(t>e){const s=e*(e/t);this._horizontalScrollbar.style.width=`${s}px`,this._scrollLeft=O(this._scrollLeft,0,this.scrollableElement.scrollWidth-e),this.scrollableElement.scrollLeft=this._scrollLeft;const n=this._scrollLeft/(t-e);this._horizontalScrollbar.style.left=`${(e-s)*n}px`}else this._horizontalScrollbar.style.width="0px",this._horizontalScrollbar.style.left="0px",this._scrollLeft=0}}Ee.MouseWheelSpeed=1;class Ei extends E{get showTabsOverflowControl(){return this._showTabsOverflowControl}set showTabsOverflowControl(e){if(this._showTabsOverflowControl!=e&&(this._showTabsOverflowControl=e,e)){const t=new Nt(this._tabsList);this._observerDisposable.value=new E(t,t.onDidChange(i=>{const s=i.hasScrollX||i.hasScrollY;this.toggleDropdown({reset:!s})}),I(this._tabsList,"scroll",()=>{this.toggleDropdown({reset:!1})}))}}get element(){return this._element}get panels(){return this._tabs.map(e=>e.value.panel.id)}get size(){return this._tabs.length}get tabs(){return this._tabs.map(e=>e.value)}constructor(e,t,i){if(super(),this.group=e,this.accessor=t,this._observerDisposable=new Y,this._tabs=[],this.selectedIndex=-1,this._showTabsOverflowControl=!1,this._onTabDragStart=new f,this.onTabDragStart=this._onTabDragStart.event,this._onDrop=new f,this.onDrop=this._onDrop.event,this._onWillShowOverlay=new f,this.onWillShowOverlay=this._onWillShowOverlay.event,this._onOverflowTabsChange=new f,this.onOverflowTabsChange=this._onOverflowTabsChange.event,this._tabsList=document.createElement("div"),this._tabsList.className="dv-tabs-container dv-horizontal",this.showTabsOverflowControl=i.showTabsOverflowControl,t.options.scrollbars==="native")this._element=this._tabsList;else{const s=new Ee(this._tabsList);this._element=s.element,this.addDisposables(s)}this.addDisposables(this._onOverflowTabsChange,this._observerDisposable,this._onWillShowOverlay,this._onDrop,this._onTabDragStart,I(this.element,"pointerdown",s=>{if(s.defaultPrevented)return;s.button===0&&this.accessor.doSetGroupActive(this.group)}),W.from(()=>{for(const{value:s,disposable:n}of this._tabs)n.dispose(),s.dispose();this._tabs=[]}))}indexOf(e){return this._tabs.findIndex(t=>t.value.panel.id===e)}isActive(e){return this.selectedIndex>-1&&this._tabs[this.selectedIndex].value===e}setActivePanel(e){let t=0;for(const i of this._tabs){const s=e.id===i.value.panel.id;if(i.value.setActive(s),s){const n=i.value.element,r=n.parentElement;(t<r.scrollLeft||t+n.clientWidth>r.scrollLeft+r.clientWidth)&&(r.scrollLeft=t)}t+=i.value.element.clientWidth}}openPanel(e,t=this._tabs.length){if(this._tabs.find(r=>r.value.panel.id===e.id))return;const i=new Ai(e,this.accessor,this.group);i.setContent(e.view.tab);const s=new E(i.onDragStart(r=>{this._onTabDragStart.fire({nativeEvent:r,panel:e})}),i.onPointerDown(r=>{if(r.defaultPrevented)return;const a=!this.accessor.options.disableFloatingGroups,h=this.group.api.location.type==="floating"&&this.size===1;if(a&&!h&&r.shiftKey){r.preventDefault();const l=this.accessor.getGroupPanel(i.panel.id),{top:d,left:c}=i.element.getBoundingClientRect(),{top:m,left:u}=this.accessor.element.getBoundingClientRect();this.accessor.addFloatingGroup(l,{x:c-u,y:d-m,inDragMode:!0});return}switch(r.button){case 0:this.group.activePanel!==e&&this.group.model.openPanel(e);break}}),i.onDrop(r=>{this._onDrop.fire({event:r.nativeEvent,index:this._tabs.findIndex(a=>a.value===i)})}),i.onWillShowOverlay(r=>{this._onWillShowOverlay.fire(new Pe(r,{kind:"tab",panel:this.group.activePanel,api:this.accessor.api,group:this.group,getData:$}))})),n={value:i,disposable:s};this.addTab(n,t)}delete(e){const t=this.indexOf(e),i=this._tabs.splice(t,1)[0],{value:s,disposable:n}=i;n.dispose(),s.dispose(),s.element.remove()}addTab(e,t=this._tabs.length){if(t<0||t>this._tabs.length)throw new Error("invalid location");this._tabsList.insertBefore(e.value.element,this._tabsList.children[t]),this._tabs=[...this._tabs.slice(0,t),e,...this._tabs.slice(t)],this.selectedIndex<0&&(this.selectedIndex=t)}toggleDropdown(e){const t=e.reset?[]:this._tabs.filter(i=>!Yt(i.value.element,this._tabsList)).map(i=>i.value.panel.id);this._onOverflowTabsChange.fire({tabs:t,reset:e.reset})}updateDragAndDropState(){for(const e of this._tabs)e.value.updateDragAndDropState()}}const xt=o=>{const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttributeNS(null,"height",o.height),e.setAttributeNS(null,"width",o.width),e.setAttributeNS(null,"viewBox",o.viewbox),e.setAttributeNS(null,"aria-hidden","false"),e.setAttributeNS(null,"focusable","false"),e.classList.add("dv-svg");const t=document.createElementNS("http://www.w3.org/2000/svg","path");return t.setAttributeNS(null,"d",o.path),e.appendChild(t),e},zi=()=>xt({width:"11",height:"11",viewbox:"0 0 28 28",path:"M2.1 27.3L0 25.2L11.55 13.65L0 2.1L2.1 0L13.65 11.55L25.2 0L27.3 2.1L15.75 13.65L27.3 25.2L25.2 27.3L13.65 15.75L2.1 27.3Z"}),Ii=()=>xt({width:"11",height:"11",viewbox:"0 0 15 25",path:"M2.15 24.1L0 21.95L9.9 12.05L0 2.15L2.15 0L14.2 12.05L2.15 24.1Z"});function Gi(){const o=document.createElement("div");o.className="dv-tabs-overflow-dropdown-default";const e=document.createElement("span");e.textContent="";const t=Ii();return o.appendChild(t),o.appendChild(e),{element:o,update:i=>{e.textContent=`${i.tabs}`}}}class Oi extends E{get onTabDragStart(){return this.tabs.onTabDragStart}get panels(){return this.tabs.panels}get size(){return this.tabs.size}get hidden(){return this._hidden}set hidden(e){this._hidden=e,this.element.style.display=e?"none":""}get element(){return this._element}constructor(e,t){super(),this.accessor=e,this.group=t,this._hidden=!1,this.dropdownPart=null,this._overflowTabs=[],this._dropdownDisposable=new Y,this._onDrop=new f,this.onDrop=this._onDrop.event,this._onGroupDragStart=new f,this.onGroupDragStart=this._onGroupDragStart.event,this._onWillShowOverlay=new f,this.onWillShowOverlay=this._onWillShowOverlay.event,this._element=document.createElement("div"),this._element.className="dv-tabs-and-actions-container",A(this._element,"dv-full-width-single-tab",this.accessor.options.singleTabMode==="fullwidth"),this.rightActionsContainer=document.createElement("div"),this.rightActionsContainer.className="dv-right-actions-container",this.leftActionsContainer=document.createElement("div"),this.leftActionsContainer.className="dv-left-actions-container",this.preActionsContainer=document.createElement("div"),this.preActionsContainer.className="dv-pre-actions-container",this.tabs=new Ei(t,e,{showTabsOverflowControl:!e.options.disableTabsOverflowList}),this.voidContainer=new Pi(this.accessor,this.group),this._element.appendChild(this.preActionsContainer),this._element.appendChild(this.tabs.element),this._element.appendChild(this.leftActionsContainer),this._element.appendChild(this.voidContainer.element),this._element.appendChild(this.rightActionsContainer),this.addDisposables(this.tabs.onDrop(i=>this._onDrop.fire(i)),this.tabs.onWillShowOverlay(i=>this._onWillShowOverlay.fire(i)),e.onDidOptionsChange(()=>{this.tabs.showTabsOverflowControl=!e.options.disableTabsOverflowList}),this.tabs.onOverflowTabsChange(i=>{this.toggleDropdown(i)}),this.tabs,this._onWillShowOverlay,this._onDrop,this._onGroupDragStart,this.voidContainer,this.voidContainer.onDragStart(i=>{this._onGroupDragStart.fire({nativeEvent:i,group:this.group})}),this.voidContainer.onDrop(i=>{this._onDrop.fire({event:i.nativeEvent,index:this.tabs.size})}),this.voidContainer.onWillShowOverlay(i=>{this._onWillShowOverlay.fire(new Pe(i,{kind:"header_space",panel:this.group.activePanel,api:this.accessor.api,group:this.group,getData:$}))}),I(this.voidContainer.element,"pointerdown",i=>{if(i.defaultPrevented)return;if(!this.accessor.options.disableFloatingGroups&&i.shiftKey&&this.group.api.location.type!=="floating"){i.preventDefault();const{top:n,left:r}=this.element.getBoundingClientRect(),{top:a,left:h}=this.accessor.element.getBoundingClientRect();this.accessor.addFloatingGroup(this.group,{x:r-h+20,y:n-a+20,inDragMode:!0})}}))}show(){this.hidden||(this.element.style.display="")}hide(){this._element.style.display="none"}setRightActionsElement(e){this.rightActions!==e&&(this.rightActions&&(this.rightActions.remove(),this.rightActions=void 0),e&&(this.rightActionsContainer.appendChild(e),this.rightActions=e))}setLeftActionsElement(e){this.leftActions!==e&&(this.leftActions&&(this.leftActions.remove(),this.leftActions=void 0),e&&(this.leftActionsContainer.appendChild(e),this.leftActions=e))}setPrefixActionsElement(e){this.preActions!==e&&(this.preActions&&(this.preActions.remove(),this.preActions=void 0),e&&(this.preActionsContainer.appendChild(e),this.preActions=e))}isActive(e){return this.tabs.isActive(e)}indexOf(e){return this.tabs.indexOf(e)}setActive(e){}delete(e){this.tabs.delete(e),this.updateClassnames()}setActivePanel(e){this.tabs.setActivePanel(e)}openPanel(e,t=this.tabs.size){this.tabs.openPanel(e,t),this.updateClassnames()}closePanel(e){this.delete(e.id)}updateClassnames(){A(this._element,"dv-single-tab",this.size===1)}toggleDropdown(e){const t=e.reset?[]:e.tabs;if(this._overflowTabs=t,this._overflowTabs.length>0&&this.dropdownPart){this.dropdownPart.update({tabs:t.length});return}if(this._overflowTabs.length===0){this._dropdownDisposable.dispose();return}const i=document.createElement("div");i.className="dv-tabs-overflow-dropdown-root";const s=Gi();s.update({tabs:t.length}),this.dropdownPart=s,i.appendChild(s.element),this.rightActionsContainer.prepend(i),this._dropdownDisposable.value=new E(W.from(()=>{var n,r;i.remove(),(r=(n=this.dropdownPart)===null||n===void 0?void 0:n.dispose)===null||r===void 0||r.call(n),this.dropdownPart=null}),I(i,"pointerdown",n=>{n.preventDefault()},{capture:!0}),I(i,"click",n=>{const r=document.createElement("div");r.style.overflow="auto",r.className="dv-tabs-overflow-container";for(const h of this.tabs.tabs.filter(l=>this._overflowTabs.includes(l.panel.id))){const l=this.group.panels.find(u=>u===h.panel),c=l.view.createTabRenderer("headerOverflow").element,m=document.createElement("div");A(m,"dv-tab",!0),A(m,"dv-active-tab",l.api.isActive),A(m,"dv-inactive-tab",!l.api.isActive),m.addEventListener("click",u=>{this.accessor.popupService.close(),!u.defaultPrevented&&(h.element.scrollIntoView(),h.panel.api.setActive())}),m.appendChild(c),r.appendChild(m)}const a=Kt(i);this.accessor.popupService.openPopover(r,{x:n.clientX,y:n.clientY,zIndex:a?.style.zIndex?`calc(${a.style.zIndex} * 2)`:void 0})}))}updateDragAndDropState(){this.tabs.updateDragAndDropState(),this.voidContainer.updateDragAndDropState()}}class At extends Rt{constructor(e,t,i,s,n){super(),this.nativeEvent=e,this.target=t,this.position=i,this.getData=s,this.group=n}}function Mi(o){return!!o.referencePanel}function Ti(o){return!!o.referenceGroup}function Li(o){return!!o.referencePanel}function ki(o){return!!o.referenceGroup}class qe extends $e{get nativeEvent(){return this.options.nativeEvent}get position(){return this.options.position}get panel(){return this.options.panel}get group(){return this.options.group}get api(){return this.options.api}constructor(e){super(),this.options=e}getData(){return this.options.getData()}}class St extends qe{get kind(){return this._kind}constructor(e){super(e),this._kind=e.kind}}class Ri extends E{get element(){throw new Error("dockview: not supported")}get activePanel(){return this._activePanel}get locked(){return this._locked}set locked(e){this._locked=e,A(this.container,"dv-locked-groupview",e==="no-drop-target"||e)}get isActive(){return this._isGroupActive}get panels(){return this._panels}get size(){return this._panels.length}get isEmpty(){return this._panels.length===0}get hasWatermark(){return!!(this.watermark&&this.container.contains(this.watermark.element))}get header(){return this.tabsContainer}get isContentFocused(){return document.activeElement?Te(document.activeElement,this.contentContainer.element):!1}get location(){return this._location}set location(e){switch(this._location=e,A(this.container,"dv-groupview-floating",!1),A(this.container,"dv-groupview-popout",!1),e.type){case"grid":this.contentContainer.dropTarget.setTargetZones(["top","bottom","left","right","center"]);break;case"floating":this.contentContainer.dropTarget.setTargetZones(["center"]),this.contentContainer.dropTarget.setTargetZones(e?["center"]:["top","bottom","left","right","center"]),A(this.container,"dv-groupview-floating",!0);break;case"popout":this.contentContainer.dropTarget.setTargetZones(["center"]),A(this.container,"dv-groupview-popout",!0);break}this.groupPanel.api._onDidLocationChange.fire({location:this.location})}constructor(e,t,i,s,n){var r;super(),this.container=e,this.accessor=t,this.id=i,this.options=s,this.groupPanel=n,this._isGroupActive=!1,this._locked=!1,this._location={type:"grid"},this.mostRecentlyUsed=[],this._overwriteRenderContainer=null,this._overwriteDropTargetContainer=null,this._onDidChange=new f,this.onDidChange=this._onDidChange.event,this._width=0,this._height=0,this._panels=[],this._panelDisposables=new Map,this._onMove=new f,this.onMove=this._onMove.event,this._onDidDrop=new f,this.onDidDrop=this._onDidDrop.event,this._onWillDrop=new f,this.onWillDrop=this._onWillDrop.event,this._onWillShowOverlay=new f,this.onWillShowOverlay=this._onWillShowOverlay.event,this._onTabDragStart=new f,this.onTabDragStart=this._onTabDragStart.event,this._onGroupDragStart=new f,this.onGroupDragStart=this._onGroupDragStart.event,this._onDidAddPanel=new f,this.onDidAddPanel=this._onDidAddPanel.event,this._onDidPanelTitleChange=new f,this.onDidPanelTitleChange=this._onDidPanelTitleChange.event,this._onDidPanelParametersChange=new f,this.onDidPanelParametersChange=this._onDidPanelParametersChange.event,this._onDidRemovePanel=new f,this.onDidRemovePanel=this._onDidRemovePanel.event,this._onDidActivePanelChange=new f,this.onDidActivePanelChange=this._onDidActivePanelChange.event,this._onUnhandledDragOverEvent=new f,this.onUnhandledDragOverEvent=this._onUnhandledDragOverEvent.event,A(this.container,"dv-groupview",!0),this._api=new Ae(this.accessor),this.tabsContainer=new Oi(this.accessor,this.groupPanel),this.contentContainer=new yi(this.accessor,this),e.append(this.tabsContainer.element,this.contentContainer.element),this.header.hidden=!!s.hideHeader,this.locked=(r=s.locked)!==null&&r!==void 0?r:!1,this.addDisposables(this._onTabDragStart,this._onGroupDragStart,this._onWillShowOverlay,this.tabsContainer.onTabDragStart(a=>{this._onTabDragStart.fire(a)}),this.tabsContainer.onGroupDragStart(a=>{this._onGroupDragStart.fire(a)}),this.tabsContainer.onDrop(a=>{this.handleDropEvent("header",a.event,"center",a.index)}),this.contentContainer.onDidFocus(()=>{this.accessor.doSetGroupActive(this.groupPanel)}),this.contentContainer.onDidBlur(()=>{}),this.contentContainer.dropTarget.onDrop(a=>{this.handleDropEvent("content",a.nativeEvent,a.position)}),this.tabsContainer.onWillShowOverlay(a=>{this._onWillShowOverlay.fire(a)}),this.contentContainer.dropTarget.onWillShowOverlay(a=>{this._onWillShowOverlay.fire(new Pe(a,{kind:"content",panel:this.activePanel,api:this._api,group:this.groupPanel,getData:$}))}),this._onMove,this._onDidChange,this._onDidDrop,this._onWillDrop,this._onDidAddPanel,this._onDidRemovePanel,this._onDidActivePanelChange,this._onUnhandledDragOverEvent,this._onDidPanelTitleChange,this._onDidPanelParametersChange)}focusContent(){this.contentContainer.element.focus()}set renderContainer(e){this.panels.forEach(t=>{this.renderContainer.detatch(t)}),this._overwriteRenderContainer=e,this.panels.forEach(t=>{this.rerender(t)})}get renderContainer(){var e;return(e=this._overwriteRenderContainer)!==null&&e!==void 0?e:this.accessor.overlayRenderContainer}set dropTargetContainer(e){this._overwriteDropTargetContainer=e}get dropTargetContainer(){var e;return(e=this._overwriteDropTargetContainer)!==null&&e!==void 0?e:this.accessor.rootDropTargetContainer}initialize(){this.options.panels&&this.options.panels.forEach(e=>{this.doAddPanel(e)}),this.options.activePanel&&this.openPanel(this.options.activePanel),this.setActive(this.isActive,!0),this.updateContainer(),this.accessor.options.createRightHeaderActionComponent&&(this._rightHeaderActions=this.accessor.options.createRightHeaderActionComponent(this.groupPanel),this.addDisposables(this._rightHeaderActions),this._rightHeaderActions.init({containerApi:this._api,api:this.groupPanel.api,group:this.groupPanel}),this.tabsContainer.setRightActionsElement(this._rightHeaderActions.element)),this.accessor.options.createLeftHeaderActionComponent&&(this._leftHeaderActions=this.accessor.options.createLeftHeaderActionComponent(this.groupPanel),this.addDisposables(this._leftHeaderActions),this._leftHeaderActions.init({containerApi:this._api,api:this.groupPanel.api,group:this.groupPanel}),this.tabsContainer.setLeftActionsElement(this._leftHeaderActions.element)),this.accessor.options.createPrefixHeaderActionComponent&&(this._prefixHeaderActions=this.accessor.options.createPrefixHeaderActionComponent(this.groupPanel),this.addDisposables(this._prefixHeaderActions),this._prefixHeaderActions.init({containerApi:this._api,api:this.groupPanel.api,group:this.groupPanel}),this.tabsContainer.setPrefixActionsElement(this._prefixHeaderActions.element))}rerender(e){this.contentContainer.renderPanel(e,{asActive:!1})}indexOf(e){return this.tabsContainer.indexOf(e.id)}toJSON(){var e;const t={views:this.tabsContainer.panels,activeView:(e=this._activePanel)===null||e===void 0?void 0:e.id,id:this.id};return this.locked!==!1&&(t.locked=this.locked),this.header.hidden&&(t.hideHeader=!0),t}moveToNext(e){e||(e={}),e.panel||(e.panel=this.activePanel);const t=e.panel?this.panels.indexOf(e.panel):-1;let i;if(t<this.panels.length-1)i=t+1;else if(!e.suppressRoll)i=0;else return;this.openPanel(this.panels[i])}moveToPrevious(e){if(e||(e={}),e.panel||(e.panel=this.activePanel),!e.panel)return;const t=this.panels.indexOf(e.panel);let i;if(t>0)i=t-1;else if(!e.suppressRoll)i=this.panels.length-1;else return;this.openPanel(this.panels[i])}containsPanel(e){return this.panels.includes(e)}init(e){}update(e){}focus(){var e;(e=this._activePanel)===null||e===void 0||e.focus()}openPanel(e,t={}){(typeof t.index!="number"||t.index>this.panels.length)&&(t.index=this.panels.length);const i=!!t.skipSetActive;if(e.updateParentGroup(this.groupPanel,{skipSetActive:t.skipSetActive}),this.doAddPanel(e,t.index,{skipSetActive:i}),this._activePanel===e){this.contentContainer.renderPanel(e,{asActive:!0});return}i||this.doSetActivePanel(e),t.skipSetGroupActive||this.accessor.doSetGroupActive(this.groupPanel),t.skipSetActive||this.updateContainer()}removePanel(e,t={skipSetActive:!1}){const i=typeof e=="string"?e:e.id,s=this._panels.find(n=>n.id===i);if(!s)throw new Error("invalid operation");return this._removePanel(s,t)}closeAllPanels(){if(this.panels.length>0){const e=[...this.panels];for(const t of e)this.doClose(t)}else this.accessor.removeGroup(this.groupPanel)}closePanel(e){this.doClose(e)}doClose(e){const t=this.panels.length===1&&this.accessor.groups.length===1;this.accessor.removePanel(e,t&&this.accessor.options.noPanelsOverlay==="emptyGroup"?{removeEmptyGroup:!1}:void 0)}isPanelActive(e){return this._activePanel===e}updateActions(e){this.tabsContainer.setRightActionsElement(e)}setActive(e,t=!1){!t&&this.isActive===e||(this._isGroupActive=e,A(this.container,"dv-active-group",e),A(this.container,"dv-inactive-group",!e),this.tabsContainer.setActive(this.isActive),!this._activePanel&&this.panels.length>0&&this.doSetActivePanel(this.panels[0]),this.updateContainer())}layout(e,t){var i;this._width=e,this._height=t,this.contentContainer.layout(this._width,this._height),!((i=this._activePanel)===null||i===void 0)&&i.layout&&this._activePanel.layout(this._width,this._height)}_removePanel(e,t){const i=this._activePanel===e;if(this.doRemovePanel(e),i&&this.panels.length>0){const s=this.mostRecentlyUsed[0];this.openPanel(s,{skipSetActive:t.skipSetActive,skipSetGroupActive:t.skipSetActiveGroup})}return this._activePanel&&this.panels.length===0&&this.doSetActivePanel(void 0),t.skipSetActive||this.updateContainer(),e}doRemovePanel(e){const t=this.panels.indexOf(e);if(this._activePanel===e&&this.contentContainer.closePanel(),this.tabsContainer.delete(e.id),this._panels.splice(t,1),this.mostRecentlyUsed.includes(e)){const s=this.mostRecentlyUsed.indexOf(e);this.mostRecentlyUsed.splice(s,1)}const i=this._panelDisposables.get(e.id);i&&(i.dispose(),this._panelDisposables.delete(e.id)),this._onDidRemovePanel.fire({panel:e})}doAddPanel(e,t=this.panels.length,i={skipSetActive:!1}){const n=this._panels.indexOf(e)>-1;this.tabsContainer.show(),this.contentContainer.show(),this.tabsContainer.openPanel(e,t),i.skipSetActive||this.contentContainer.openPanel(e),!n&&(this.updateMru(e),this.panels.splice(t,0,e),this._panelDisposables.set(e.id,new E(e.api.onDidTitleChange(r=>this._onDidPanelTitleChange.fire(r)),e.api.onDidParametersChange(r=>this._onDidPanelParametersChange.fire(r)))),this._onDidAddPanel.fire({panel:e}))}doSetActivePanel(e){this._activePanel!==e&&(this._activePanel=e,e&&(this.tabsContainer.setActivePanel(e),e.layout(this._width,this._height),this.updateMru(e),this._onDidActivePanelChange.fire({panel:e})))}updateMru(e){this.mostRecentlyUsed.includes(e)&&this.mostRecentlyUsed.splice(this.mostRecentlyUsed.indexOf(e),1),this.mostRecentlyUsed=[e,...this.mostRecentlyUsed]}updateContainer(){var e,t;if(this.panels.forEach(i=>i.runEvents()),this.isEmpty&&!this.watermark){const i=this.accessor.createWatermarkComponent();i.init({containerApi:this._api,group:this.groupPanel}),this.watermark=i,I(this.watermark.element,"pointerdown",()=>{this.isActive||this.accessor.doSetGroupActive(this.groupPanel)}),this.contentContainer.element.appendChild(this.watermark.element)}!this.isEmpty&&this.watermark&&(this.watermark.element.remove(),(t=(e=this.watermark).dispose)===null||t===void 0||t.call(e),this.watermark=void 0)}canDisplayOverlay(e,t,i){const s=new At(e,i,t,$,this.accessor.getPanel(this.id));return this._onUnhandledDragOverEvent.fire(s),s.isAccepted}handleDropEvent(e,t,i,s){if(this.locked==="no-drop-target")return;function n(){switch(e){case"header":return typeof s=="number"?"tab":"header_space";case"content":return"content"}}const r=typeof s=="number"?this.panels[s]:void 0,a=new St({nativeEvent:t,position:i,panel:r,getData:()=>$(),kind:n(),group:this.groupPanel,api:this._api});if(this._onWillDrop.fire(a),a.defaultPrevented)return;const h=$();if(h&&h.viewId===this.accessor.id){if(e==="content"&&h.groupId===this.id&&(i==="center"||h.panelId===null)||e==="header"&&h.groupId===this.id&&h.panelId===null)return;if(h.panelId===null){const{groupId:u}=h;this._onMove.fire({target:i,groupId:u,index:s});return}if(this.tabsContainer.indexOf(h.panelId)!==-1&&this.tabsContainer.size===1)return;const{groupId:d,panelId:c}=h;if(this.id===d&&!i&&this.tabsContainer.indexOf(c)===s)return;this._onMove.fire({target:i,groupId:h.groupId,itemId:h.panelId,index:s})}else this._onDidDrop.fire(new qe({nativeEvent:t,position:i,panel:r,getData:()=>$(),group:this.groupPanel,api:this._api}))}updateDragAndDropState(){this.tabsContainer.updateDragAndDropState()}dispose(){var e,t,i;super.dispose(),(e=this.watermark)===null||e===void 0||e.element.remove(),(i=(t=this.watermark)===null||t===void 0?void 0:t.dispose)===null||i===void 0||i.call(t),this.watermark=void 0;for(const s of this.panels)s.dispose();this.tabsContainer.dispose(),this.contentContainer.dispose()}}class Ye extends Di{constructor(e,t,i){super(e,t),this._onDidConstraintsChangeInternal=new f,this.onDidConstraintsChangeInternal=this._onDidConstraintsChangeInternal.event,this._onDidConstraintsChange=new f,this.onDidConstraintsChange=this._onDidConstraintsChange.event,this._onDidSizeChange=new f,this.onDidSizeChange=this._onDidSizeChange.event,this.addDisposables(this._onDidConstraintsChangeInternal,this._onDidConstraintsChange,this._onDidSizeChange),i&&this.initialize(i)}setConstraints(e){this._onDidConstraintsChangeInternal.fire(e)}setSize(e){this._onDidSizeChange.fire(e)}}class Vi extends Ci{get priority(){return this._priority}get snap(){return this._snap}get minimumWidth(){return this.__minimumWidth()}get minimumHeight(){return this.__minimumHeight()}get maximumHeight(){return this.__maximumHeight()}get maximumWidth(){return this.__maximumWidth()}__minimumWidth(){const e=typeof this._minimumWidth=="function"?this._minimumWidth():this._minimumWidth;return e!==this._evaluatedMinimumWidth&&(this._evaluatedMinimumWidth=e,this.updateConstraints()),e}__maximumWidth(){const e=typeof this._maximumWidth=="function"?this._maximumWidth():this._maximumWidth;return e!==this._evaluatedMaximumWidth&&(this._evaluatedMaximumWidth=e,this.updateConstraints()),e}__minimumHeight(){const e=typeof this._minimumHeight=="function"?this._minimumHeight():this._minimumHeight;return e!==this._evaluatedMinimumHeight&&(this._evaluatedMinimumHeight=e,this.updateConstraints()),e}__maximumHeight(){const e=typeof this._maximumHeight=="function"?this._maximumHeight():this._maximumHeight;return e!==this._evaluatedMaximumHeight&&(this._evaluatedMaximumHeight=e,this.updateConstraints()),e}get isActive(){return this.api.isActive}get isVisible(){return this.api.isVisible}constructor(e,t,i,s){super(e,t,s??new Ye(e,t)),this._evaluatedMinimumWidth=0,this._evaluatedMaximumWidth=Number.MAX_SAFE_INTEGER,this._evaluatedMinimumHeight=0,this._evaluatedMaximumHeight=Number.MAX_SAFE_INTEGER,this._minimumWidth=0,this._minimumHeight=0,this._maximumWidth=Number.MAX_SAFE_INTEGER,this._maximumHeight=Number.MAX_SAFE_INTEGER,this._snap=!1,this._onDidChange=new f,this.onDidChange=this._onDidChange.event,typeof i?.minimumWidth=="number"&&(this._minimumWidth=i.minimumWidth),typeof i?.maximumWidth=="number"&&(this._maximumWidth=i.maximumWidth),typeof i?.minimumHeight=="number"&&(this._minimumHeight=i.minimumHeight),typeof i?.maximumHeight=="number"&&(this._maximumHeight=i.maximumHeight),this.api.initialize(this),this.addDisposables(this.api.onWillVisibilityChange(n=>{const{isVisible:r}=n,{accessor:a}=this._params;a.setVisible(this,r)}),this.api.onActiveChange(()=>{const{accessor:n}=this._params;n.doSetGroupActive(this)}),this.api.onDidConstraintsChangeInternal(n=>{(typeof n.minimumWidth=="number"||typeof n.minimumWidth=="function")&&(this._minimumWidth=n.minimumWidth),(typeof n.minimumHeight=="number"||typeof n.minimumHeight=="function")&&(this._minimumHeight=n.minimumHeight),(typeof n.maximumWidth=="number"||typeof n.maximumWidth=="function")&&(this._maximumWidth=n.maximumWidth),(typeof n.maximumHeight=="number"||typeof n.maximumHeight=="function")&&(this._maximumHeight=n.maximumHeight)}),this.api.onDidSizeChange(n=>{this._onDidChange.fire({height:n.height,width:n.width})}),this._onDidChange)}setVisible(e){this.api._onDidVisibilityChange.fire({isVisible:e})}setActive(e){this.api._onDidActiveChange.fire({isActive:e})}init(e){e.maximumHeight&&(this._maximumHeight=e.maximumHeight),e.minimumHeight&&(this._minimumHeight=e.minimumHeight),e.maximumWidth&&(this._maximumWidth=e.maximumWidth),e.minimumWidth&&(this._minimumWidth=e.minimumWidth),this._priority=e.priority,this._snap=!!e.snap,super.init(e),typeof e.isVisible=="boolean"&&this.setVisible(e.isVisible)}updateConstraints(){this.api._onDidConstraintsChange.fire({minimumWidth:this._evaluatedMinimumWidth,maximumWidth:this._evaluatedMaximumWidth,minimumHeight:this._evaluatedMinimumHeight,maximumHeight:this._evaluatedMaximumHeight})}toJSON(){const e=super.toJSON(),t=s=>s===Number.MAX_SAFE_INTEGER?void 0:s,i=s=>s<=0?void 0:s;return Object.assign(Object.assign({},e),{minimumHeight:i(this.minimumHeight),maximumHeight:t(this.maximumHeight),minimumWidth:i(this.minimumWidth),maximumWidth:t(this.maximumWidth),snap:this.snap,priority:this.priority})}}const pe="dockview: DockviewGroupPanelApiImpl not initialized";class Wi extends Ye{get location(){if(!this._group)throw new Error(pe);return this._group.model.location}constructor(e,t){super(e,"__dockviewgroup__"),this.accessor=t,this._onDidLocationChange=new f,this.onDidLocationChange=this._onDidLocationChange.event,this._onDidActivePanelChange=new f,this.onDidActivePanelChange=this._onDidActivePanelChange.event,this.addDisposables(this._onDidLocationChange,this._onDidActivePanelChange)}close(){if(this._group)return this.accessor.removeGroup(this._group)}getWindow(){return this.location.type==="popout"?this.location.getWindow():window}moveTo(e){var t,i,s,n;if(!this._group)throw new Error(pe);const r=(t=e.group)!==null&&t!==void 0?t:this.accessor.addGroup({direction:mi((i=e.position)!==null&&i!==void 0?i:"right"),skipSetActive:(s=e.skipSetActive)!==null&&s!==void 0?s:!1});this.accessor.moveGroupOrPanel({from:{groupId:this._group.id},to:{group:r,position:e.group&&(n=e.position)!==null&&n!==void 0?n:"center",index:e.index},skipSetActive:e.skipSetActive})}maximize(){if(!this._group)throw new Error(pe);this.location.type==="grid"&&this.accessor.maximizeGroup(this._group)}isMaximized(){if(!this._group)throw new Error(pe);return this.accessor.isMaximizedGroup(this._group)}exitMaximized(){if(!this._group)throw new Error(pe);this.isMaximized()&&this.accessor.exitMaximizedGroup()}initialize(e){this._group=e}}const Ni=100,Hi=100;class st extends Vi{get minimumWidth(){var e;if(typeof this._explicitConstraints.minimumWidth=="number")return this._explicitConstraints.minimumWidth;const t=(e=this.activePanel)===null||e===void 0?void 0:e.minimumWidth;return typeof t=="number"?t:super.__minimumWidth()}get minimumHeight(){var e;if(typeof this._explicitConstraints.minimumHeight=="number")return this._explicitConstraints.minimumHeight;const t=(e=this.activePanel)===null||e===void 0?void 0:e.minimumHeight;return typeof t=="number"?t:super.__minimumHeight()}get maximumWidth(){var e;if(typeof this._explicitConstraints.maximumWidth=="number")return this._explicitConstraints.maximumWidth;const t=(e=this.activePanel)===null||e===void 0?void 0:e.maximumWidth;return typeof t=="number"?t:super.__maximumWidth()}get maximumHeight(){var e;if(typeof this._explicitConstraints.maximumHeight=="number")return this._explicitConstraints.maximumHeight;const t=(e=this.activePanel)===null||e===void 0?void 0:e.maximumHeight;return typeof t=="number"?t:super.__maximumHeight()}get panels(){return this._model.panels}get activePanel(){return this._model.activePanel}get size(){return this._model.size}get model(){return this._model}get locked(){return this._model.locked}set locked(e){this._model.locked=e}get header(){return this._model.header}constructor(e,t,i){var s,n,r,a,h,l;super(t,"groupview_default",{minimumHeight:(n=(s=i.constraints)===null||s===void 0?void 0:s.minimumHeight)!==null&&n!==void 0?n:Hi,minimumWidth:(a=(r=i.constraints)===null||r===void 0?void 0:r.minimumWidth)!==null&&a!==void 0?a:Ni,maximumHeight:(h=i.constraints)===null||h===void 0?void 0:h.maximumHeight,maximumWidth:(l=i.constraints)===null||l===void 0?void 0:l.maximumWidth},new Wi(t,e)),this._explicitConstraints={},this.api.initialize(this),this._model=new Ri(this.element,e,t,i,this),this.addDisposables(this.model.onDidActivePanelChange(d=>{this.api._onDidActivePanelChange.fire(d)}),this.api.onDidConstraintsChangeInternal(d=>{d.minimumWidth!==void 0&&(this._explicitConstraints.minimumWidth=typeof d.minimumWidth=="function"?d.minimumWidth():d.minimumWidth),d.minimumHeight!==void 0&&(this._explicitConstraints.minimumHeight=typeof d.minimumHeight=="function"?d.minimumHeight():d.minimumHeight),d.maximumWidth!==void 0&&(this._explicitConstraints.maximumWidth=typeof d.maximumWidth=="function"?d.maximumWidth():d.maximumWidth),d.maximumHeight!==void 0&&(this._explicitConstraints.maximumHeight=typeof d.maximumHeight=="function"?d.maximumHeight():d.maximumHeight)}))}focus(){this.api.isActive||this.api.setActive(),super.focus()}initialize(){this._model.initialize()}setActive(e){super.setActive(e),this.model.setActive(e)}layout(e,t){super.layout(e,t),this.model.layout(e,t)}getComponent(){return this._model}toJSON(){return this.model.toJSON()}}const Bi={name:"dark",className:"dockview-theme-dark"},Fi={className:"dockview-theme-abyss"};class Ui extends Ye{get location(){return this.group.api.location}get title(){return this.panel.title}get isGroupActive(){return this.group.isActive}get renderer(){return this.panel.renderer}set group(e){const t=this._group;this._group!==e&&(this._group=e,this._onDidGroupChange.fire({}),this.setupGroupEventListeners(t),this._onDidLocationChange.fire({location:this.group.api.location}))}get group(){return this._group}get tabComponent(){return this._tabComponent}constructor(e,t,i,s,n){super(e.id,s),this.panel=e,this.accessor=i,this._onDidTitleChange=new f,this.onDidTitleChange=this._onDidTitleChange.event,this._onDidActiveGroupChange=new f,this.onDidActiveGroupChange=this._onDidActiveGroupChange.event,this._onDidGroupChange=new f,this.onDidGroupChange=this._onDidGroupChange.event,this._onDidRendererChange=new f,this.onDidRendererChange=this._onDidRendererChange.event,this._onDidLocationChange=new f,this.onDidLocationChange=this._onDidLocationChange.event,this.groupEventsDisposable=new Y,this._tabComponent=n,this.initialize(e),this._group=t,this.setupGroupEventListeners(),this.addDisposables(this.groupEventsDisposable,this._onDidRendererChange,this._onDidTitleChange,this._onDidGroupChange,this._onDidActiveGroupChange,this._onDidLocationChange)}getWindow(){return this.group.api.getWindow()}moveTo(e){var t,i;this.accessor.moveGroupOrPanel({from:{groupId:this._group.id,panelId:this.panel.id},to:{group:(t=e.group)!==null&&t!==void 0?t:this._group,position:e.group&&(i=e.position)!==null&&i!==void 0?i:"center",index:e.index},skipSetActive:e.skipSetActive})}setTitle(e){this.panel.setTitle(e)}setRenderer(e){this.panel.setRenderer(e)}close(){this.group.model.closePanel(this.panel)}maximize(){this.group.api.maximize()}isMaximized(){return this.group.api.isMaximized()}exitMaximized(){this.group.api.exitMaximized()}setupGroupEventListeners(e){var t;let i=(t=e?.isActive)!==null&&t!==void 0?t:!1;this.groupEventsDisposable.value=new E(this.group.api.onDidVisibilityChange(s=>{const n=!s.isVisible&&this.isVisible,r=s.isVisible&&!this.isVisible,a=this.group.model.isPanelActive(this.panel);(n||r&&a)&&this._onDidVisibilityChange.fire(s)}),this.group.api.onDidLocationChange(s=>{this.group===this.panel.group&&this._onDidLocationChange.fire(s)}),this.group.api.onDidActiveChange(()=>{this.group===this.panel.group&&i!==this.isGroupActive&&(i=this.isGroupActive,this._onDidActiveGroupChange.fire({isActive:this.isGroupActive}))}))}}class ue extends E{get params(){return this._params}get title(){return this._title}get group(){return this._group}get renderer(){var e;return(e=this._renderer)!==null&&e!==void 0?e:this.accessor.renderer}get minimumWidth(){return this._minimumWidth}get minimumHeight(){return this._minimumHeight}get maximumWidth(){return this._maximumWidth}get maximumHeight(){return this._maximumHeight}constructor(e,t,i,s,n,r,a,h){super(),this.id=e,this.accessor=s,this.containerApi=n,this.view=a,this._renderer=h.renderer,this._group=r,this._minimumWidth=h.minimumWidth,this._minimumHeight=h.minimumHeight,this._maximumWidth=h.maximumWidth,this._maximumHeight=h.maximumHeight,this.api=new Ui(this,this._group,s,t,i),this.addDisposables(this.api.onActiveChange(()=>{s.setActivePanel(this)}),this.api.onDidSizeChange(l=>{this.group.api.setSize(l)}),this.api.onDidRendererChange(()=>{this.group.model.rerender(this)}))}init(e){this._params=e.params,this.view.init(Object.assign(Object.assign({},e),{api:this.api,containerApi:this.containerApi})),this.setTitle(e.title)}focus(){const e=new Ct;this.api._onWillFocus.fire(e),!e.defaultPrevented&&(this.api.isActive||this.api.setActive())}toJSON(){return{id:this.id,contentComponent:this.view.contentComponent,tabComponent:this.view.tabComponent,params:Object.keys(this._params||{}).length>0?this._params:void 0,title:this.title,renderer:this._renderer,minimumHeight:this._minimumHeight,maximumHeight:this._maximumHeight,minimumWidth:this._minimumWidth,maximumWidth:this._maximumWidth}}setTitle(e){e!==this.title&&(this._title=e,this.api._onDidTitleChange.fire({title:e}))}setRenderer(e){e!==this.renderer&&(this._renderer=e,this.api._onDidRendererChange.fire({renderer:e}))}update(e){var t;this._params=Object.assign(Object.assign({},(t=this._params)!==null&&t!==void 0?t:{}),e.params);for(const i of Object.keys(e.params))e.params[i]===void 0&&delete this._params[i];this.view.update({params:this._params})}updateParentGroup(e,t){this._group=e,this.api.group=this._group;const i=this._group.model.isPanelActive(this),s=this.group.api.isActive&&i;t?.skipSetActive||this.api.isActive!==s&&this.api._onDidActiveChange.fire({isActive:this.group.api.isActive&&i}),this.api.isVisible!==i&&this.api._onDidVisibilityChange.fire({isVisible:i})}runEvents(){const e=this._group.model.isPanelActive(this),t=this.group.api.isActive&&e;this.api.isActive!==t&&this.api._onDidActiveChange.fire({isActive:this.group.api.isActive&&e}),this.api.isVisible!==e&&this.api._onDidVisibilityChange.fire({isVisible:e})}layout(e,t){this.api._onDidDimensionChange.fire({width:e,height:t}),this.view.layout(e,t)}dispose(){this.api.dispose(),this.view.dispose()}}let ot=class extends E{get element(){return this._element}constructor(){super(),this._element=document.createElement("div"),this._element.className="dv-default-tab",this._content=document.createElement("div"),this._content.className="dv-default-tab-content",this.action=document.createElement("div"),this.action.className="dv-default-tab-action",this.action.appendChild(zi()),this._element.appendChild(this._content),this._element.appendChild(this.action),this.render()}init(e){this._title=e.title,this.addDisposables(e.api.onDidTitleChange(t=>{this._title=t.title,this.render()}),I(this.action,"pointerdown",t=>{t.preventDefault()}),I(this.action,"click",t=>{t.defaultPrevented||(t.preventDefault(),e.api.close())})),this.render()}render(){var e;this._content.textContent!==this._title&&(this._content.textContent=(e=this._title)!==null&&e!==void 0?e:"")}};class Pt{get content(){return this._content}get tab(){return this._tab}constructor(e,t,i,s){this.accessor=e,this.id=t,this.contentComponent=i,this.tabComponent=s,this._content=this.createContentComponent(this.id,i),this._tab=this.createTabComponent(this.id,s)}createTabRenderer(e){var t;const i=this.createTabComponent(this.id,this.tabComponent);return this._params&&i.init(Object.assign(Object.assign({},this._params),{tabLocation:e})),this._updateEvent&&((t=i.update)===null||t===void 0||t.call(i,this._updateEvent)),i}init(e){this._params=e,this.content.init(e),this.tab.init(Object.assign(Object.assign({},e),{tabLocation:"header"}))}layout(e,t){var i,s;(s=(i=this.content).layout)===null||s===void 0||s.call(i,e,t)}update(e){var t,i,s,n;this._updateEvent=e,(i=(t=this.content).update)===null||i===void 0||i.call(t,e),(n=(s=this.tab).update)===null||n===void 0||n.call(s,e)}dispose(){var e,t,i,s;(t=(e=this.content).dispose)===null||t===void 0||t.call(e),(s=(i=this.tab).dispose)===null||s===void 0||s.call(i)}createContentComponent(e,t){return this.accessor.options.createComponent({id:e,name:t})}createTabComponent(e,t){const i=t??this.accessor.options.defaultTabComponent;if(i){if(this.accessor.options.createTabComponent){const s=this.accessor.options.createTabComponent({id:e,name:i});return s||new ot}console.warn(`dockview: tabComponent '${t}' was not found. falling back to the default tab.`)}return new ot}}class ji{constructor(e){this.accessor=e}fromJSON(e,t){var i,s;const n=e.id,r=e.params,a=e.title,h=e.view,l=h?h.content.id:(i=e.contentComponent)!==null&&i!==void 0?i:"unknown",d=h?(s=h.tab)===null||s===void 0?void 0:s.id:e.tabComponent,c=new Pt(this.accessor,n,l,d),m=new ue(n,l,d,this.accessor,new Ae(this.accessor),t,c,{renderer:e.renderer,minimumWidth:e.minimumWidth,minimumHeight:e.minimumHeight,maximumWidth:e.maximumWidth,maximumHeight:e.maximumHeight});return m.init({title:a??n,params:r??{}}),m}}class $i extends E{get element(){return this._element}constructor(){super(),this._element=document.createElement("div"),this._element.className="dv-watermark"}init(e){}}class qi{constructor(){this._orderedList=[]}push(e){this._orderedList=[...this._orderedList.filter(t=>t!==e),e],this.update()}destroy(e){this._orderedList=this._orderedList.filter(t=>t!==e),this.update()}update(){for(let e=0;e<this._orderedList.length;e++)this._orderedList[e].setAttribute("aria-level",`${e}`),this._orderedList[e].style.zIndex=`calc(var(--dv-overlay-z-index, 999) + ${e*2})`}}const _e=new qi;class se extends E{set minimumInViewportWidth(e){this.options.minimumInViewportWidth=e}set minimumInViewportHeight(e){this.options.minimumInViewportHeight=e}get element(){return this._element}get isVisible(){return this._isVisible}constructor(e){super(),this.options=e,this._element=document.createElement("div"),this._onDidChange=new f,this.onDidChange=this._onDidChange.event,this._onDidChangeEnd=new f,this.onDidChangeEnd=this._onDidChangeEnd.event,this.addDisposables(this._onDidChange,this._onDidChangeEnd),this._element.className="dv-resize-container",this._isVisible=!0,this.setupResize("top"),this.setupResize("bottom"),this.setupResize("left"),this.setupResize("right"),this.setupResize("topleft"),this.setupResize("topright"),this.setupResize("bottomleft"),this.setupResize("bottomright"),this._element.appendChild(this.options.content),this.options.container.appendChild(this._element),this.setBounds(Object.assign(Object.assign(Object.assign(Object.assign({height:this.options.height,width:this.options.width},"top"in this.options&&{top:this.options.top}),"bottom"in this.options&&{bottom:this.options.bottom}),"left"in this.options&&{left:this.options.left}),"right"in this.options&&{right:this.options.right})),_e.push(this._element)}setVisible(e){e!==this.isVisible&&(this._isVisible=e,A(this.element,"dv-hidden",!this.isVisible))}bringToFront(){_e.push(this._element)}setBounds(e={}){typeof e.height=="number"&&(this._element.style.height=`${e.height}px`),typeof e.width=="number"&&(this._element.style.width=`${e.width}px`),"top"in e&&typeof e.top=="number"&&(this._element.style.top=`${e.top}px`,this._element.style.bottom="auto",this.verticalAlignment="top"),"bottom"in e&&typeof e.bottom=="number"&&(this._element.style.bottom=`${e.bottom}px`,this._element.style.top="auto",this.verticalAlignment="bottom"),"left"in e&&typeof e.left=="number"&&(this._element.style.left=`${e.left}px`,this._element.style.right="auto",this.horiziontalAlignment="left"),"right"in e&&typeof e.right=="number"&&(this._element.style.right=`${e.right}px`,this._element.style.left="auto",this.horiziontalAlignment="right");const t=this.options.container.getBoundingClientRect(),i=this._element.getBoundingClientRect(),s=Math.max(0,this.getMinimumWidth(i.width)),n=Math.max(0,this.getMinimumHeight(i.height));if(this.verticalAlignment==="top"){const r=O(i.top-t.top,-n,Math.max(0,t.height-i.height+n));this._element.style.top=`${r}px`,this._element.style.bottom="auto"}if(this.verticalAlignment==="bottom"){const r=O(t.bottom-i.bottom,-n,Math.max(0,t.height-i.height+n));this._element.style.bottom=`${r}px`,this._element.style.top="auto"}if(this.horiziontalAlignment==="left"){const r=O(i.left-t.left,-s,Math.max(0,t.width-i.width+s));this._element.style.left=`${r}px`,this._element.style.right="auto"}if(this.horiziontalAlignment==="right"){const r=O(t.right-i.right,-s,Math.max(0,t.width-i.width+s));this._element.style.right=`${r}px`,this._element.style.left="auto"}this._onDidChange.fire()}toJSON(){const e=this.options.container.getBoundingClientRect(),t=this._element.getBoundingClientRect(),i={};return this.verticalAlignment==="top"?i.top=parseFloat(this._element.style.top):this.verticalAlignment==="bottom"?i.bottom=parseFloat(this._element.style.bottom):i.top=t.top-e.top,this.horiziontalAlignment==="left"?i.left=parseFloat(this._element.style.left):this.horiziontalAlignment==="right"?i.right=parseFloat(this._element.style.right):i.left=t.left-e.left,i.width=t.width,i.height=t.height,i}setupDrag(e,t={inDragMode:!1}){const i=new Y,s=()=>{let n=null;const r=xe();i.value=new E({dispose:()=>{r.release()}},I(window,"pointermove",a=>{const h=this.options.container.getBoundingClientRect(),l=a.clientX-h.left,d=a.clientY-h.top;A(this._element,"dv-resize-container-dragging",!0);const c=this._element.getBoundingClientRect();n===null&&(n={x:a.clientX-c.left,y:a.clientY-c.top});const m=Math.max(0,this.getMinimumWidth(c.width)),u=Math.max(0,this.getMinimumHeight(c.height)),v=O(d-n.y,-u,Math.max(0,h.height-c.height+u)),p=O(n.y-d+h.height-c.height,-u,Math.max(0,h.height-c.height+u)),g=O(l-n.x,-m,Math.max(0,h.width-c.width+m)),b=O(n.x-l+h.width-c.width,-m,Math.max(0,h.width-c.width+m)),y={};v<=p?y.top=v:y.bottom=p,g<=b?y.left=g:y.right=b,this.setBounds(y)}),I(window,"pointerup",()=>{A(this._element,"dv-resize-container-dragging",!1),i.dispose(),this._onDidChangeEnd.fire()}))};this.addDisposables(i,I(e,"pointerdown",n=>{if(n.defaultPrevented){n.preventDefault();return}et(n)||s()}),I(this.options.content,"pointerdown",n=>{n.defaultPrevented||et(n)||n.shiftKey&&s()}),I(this.options.content,"pointerdown",()=>{_e.push(this._element)},!0)),t.inDragMode&&s()}setupResize(e){const t=document.createElement("div");t.className=`dv-resize-handle-${e}`,this._element.appendChild(t);const i=new Y;this.addDisposables(i,I(t,"pointerdown",s=>{s.preventDefault();let n=null;const r=xe();i.value=new E(I(window,"pointermove",a=>{const h=this.options.container.getBoundingClientRect(),l=this._element.getBoundingClientRect(),d=a.clientY-h.top,c=a.clientX-h.left;n===null&&(n={originalY:d,originalHeight:l.height,originalX:c,originalWidth:l.width});let m,u,v,p,g,b;const y=()=>{m=O(d,-Number.MAX_VALUE,n.originalY+n.originalHeight>h.height?this.getMinimumHeight(h.height):Math.max(0,n.originalY+n.originalHeight-se.MINIMUM_HEIGHT)),v=n.originalY+n.originalHeight-m,u=h.height-m-v},D=()=>{m=n.originalY-n.originalHeight,v=O(d-m,m<0&&typeof this.options.minimumInViewportHeight=="number"?-m+this.options.minimumInViewportHeight:se.MINIMUM_HEIGHT,Number.MAX_VALUE),u=h.height-m-v},_=()=>{p=O(c,-Number.MAX_VALUE,n.originalX+n.originalWidth>h.width?this.getMinimumWidth(h.width):Math.max(0,n.originalX+n.originalWidth-se.MINIMUM_WIDTH)),b=n.originalX+n.originalWidth-p,g=h.width-p-b},x=()=>{p=n.originalX-n.originalWidth,b=O(c-p,p<0&&typeof this.options.minimumInViewportWidth=="number"?-p+this.options.minimumInViewportWidth:se.MINIMUM_WIDTH,Number.MAX_VALUE),g=h.width-p-b};switch(e){case"top":y();break;case"bottom":D();break;case"left":_();break;case"right":x();break;case"topleft":y(),_();break;case"topright":y(),x();break;case"bottomleft":D(),_();break;case"bottomright":D(),x();break}const C={};m<=u?C.top=m:C.bottom=u,p<=g?C.left=p:C.right=g,C.height=v,C.width=b,this.setBounds(C)}),{dispose:()=>{r.release()}},I(window,"pointerup",()=>{i.dispose(),this._onDidChangeEnd.fire()}))}))}getMinimumWidth(e){return typeof this.options.minimumInViewportWidth=="number"?e-this.options.minimumInViewportWidth:0}getMinimumHeight(e){return typeof this.options.minimumInViewportHeight=="number"?e-this.options.minimumInViewportHeight:0}dispose(){_e.destroy(this._element),this._element.remove(),super.dispose()}}se.MINIMUM_HEIGHT=20;se.MINIMUM_WIDTH=20;class Yi extends E{constructor(e,t){super(),this.group=e,this.overlay=t,this.addDisposables(t)}position(e){this.overlay.setBounds(e)}}const we=100,ie={left:100,top:100,width:300,height:300},Xi=100;class Zi{constructor(){this.cache=new Map,this.currentFrameId=0,this.rafId=null}getPosition(e){const t=this.cache.get(e);if(t&&t.frameId===this.currentFrameId)return t.rect;this.scheduleFrameUpdate();const i=Le(e);return this.cache.set(e,{rect:i,frameId:this.currentFrameId}),i}invalidate(){this.currentFrameId++}scheduleFrameUpdate(){this.rafId||(this.rafId=requestAnimationFrame(()=>{this.currentFrameId++,this.rafId=null}))}}function Ji(){const o=document.createElement("div");return o.tabIndex=-1,o}class rt extends E{constructor(e,t){super(),this.element=e,this.accessor=t,this.map={},this._disposed=!1,this.positionCache=new Zi,this.pendingUpdates=new Set,this.addDisposables(W.from(()=>{for(const i of Object.values(this.map))i.disposable.dispose(),i.destroy.dispose();this._disposed=!0}))}updateAllPositions(){if(!this._disposed){this.positionCache.invalidate();for(const e of Object.values(this.map))e.panel.api.isVisible&&e.resize&&e.resize()}}detatch(e){if(this.map[e.api.id]){const{disposable:t,destroy:i}=this.map[e.api.id];return t.dispose(),i.dispose(),delete this.map[e.api.id],!0}return!1}attach(e){const{panel:t,referenceContainer:i}=e;if(!this.map[t.api.id]){const d=Ji();d.className="dv-render-overlay",this.map[t.api.id]={panel:t,disposable:W.NONE,destroy:W.NONE,element:d}}const s=this.map[t.api.id].element;t.view.content.element.parentElement!==s&&s.appendChild(t.view.content.element),s.parentElement!==this.element&&this.element.appendChild(s);const n=()=>{const d=t.api.id;this.pendingUpdates.has(d)||(this.pendingUpdates.add(d),requestAnimationFrame(()=>{if(this.pendingUpdates.delete(d),this.isDisposed||!this.map[d])return;const c=this.positionCache.getPosition(i.element),m=this.positionCache.getPosition(this.element),u=c.left-m.left,v=c.top-m.top,p=c.width,g=c.height;s.style.left=`${u}px`,s.style.top=`${v}px`,s.style.width=`${p}px`,s.style.height=`${g}px`,A(s,"dv-render-overlay-float",t.group.api.location.type==="floating")}))},r=()=>{t.api.isVisible&&(this.positionCache.invalidate(),n()),s.style.display=t.api.isVisible?"":"none"},a=new Y,h=()=>{t.api.location.type==="floating"?queueMicrotask(()=>{const d=this.accessor.floatingGroups.find(v=>v.group===t.api.group);if(!d)return;const c=d.overlay.element,m=()=>{const v=Number(c.getAttribute("aria-level"));s.style.zIndex=`calc(var(--dv-overlay-z-index, 999) + ${v*2+1})`},u=new MutationObserver(()=>{m()});a.value=W.from(()=>u.disconnect()),u.observe(c,{attributeFilter:["aria-level"],attributes:!0}),m()}):s.style.zIndex=""},l=new E(a,new Dt(s,{onDragEnd:d=>{i.dropTarget.dnd.onDragEnd(d)},onDragEnter:d=>{i.dropTarget.dnd.onDragEnter(d)},onDragLeave:d=>{i.dropTarget.dnd.onDragLeave(d)},onDrop:d=>{i.dropTarget.dnd.onDrop(d)},onDragOver:d=>{i.dropTarget.dnd.onDragOver(d)}}),t.api.onDidVisibilityChange(()=>{r()}),t.api.onDidDimensionsChange(()=>{t.api.isVisible&&n()}),t.api.onDidLocationChange(()=>{h()}));return this.map[t.api.id].destroy=W.from(()=>{var d;t.view.content.element.parentElement===s&&s.removeChild(t.view.content.element),(d=s.parentElement)===null||d===void 0||d.removeChild(s)}),h(),queueMicrotask(()=>{this.isDisposed||r()}),this.map[t.api.id].disposable.dispose(),this.map[t.api.id].disposable=l,this.map[t.api.id].resize=n,s}}var Ki=function(o,e,t,i){function s(n){return n instanceof t?n:new t(function(r){r(n)})}return new(t||(t=Promise))(function(n,r){function a(d){try{l(i.next(d))}catch(c){r(c)}}function h(d){try{l(i.throw(d))}catch(c){r(c)}}function l(d){d.done?n(d.value):s(d.value).then(a,h)}l((i=i.apply(o,e||[])).next())})};class Qi extends E{get window(){var e,t;return(t=(e=this._window)===null||e===void 0?void 0:e.value)!==null&&t!==void 0?t:null}constructor(e,t,i){super(),this.target=e,this.className=t,this.options=i,this._onWillClose=new f,this.onWillClose=this._onWillClose.event,this._onDidClose=new f,this.onDidClose=this._onDidClose.event,this._window=null,this.addDisposables(this._onWillClose,this._onDidClose,{dispose:()=>{this.close()}})}dimensions(){if(!this._window)return null;const e=this._window.value.screenX,t=this._window.value.screenY,i=this._window.value.innerWidth,s=this._window.value.innerHeight;return{top:t,left:e,width:i,height:s}}close(){var e,t;this._window&&(this._onWillClose.fire(),(t=(e=this.options).onWillClose)===null||t===void 0||t.call(e,{id:this.target,window:this._window.value}),this._window.disposable.dispose(),this._window=null,this._onDidClose.fire())}open(){var e,t;return Ki(this,void 0,void 0,function*(){if(this._window)throw new Error("instance of popout window is already open");const i=`${this.options.url}`,s=Object.entries({top:this.options.top,left:this.options.left,width:this.options.width,height:this.options.height}).map(([h,l])=>`${h}=${l}`).join(","),n=window.open(i,this.target,s);if(!n)return null;const r=new E;this._window={value:n,disposable:r},r.addDisposables(W.from(()=>{n.close()}),I(window,"beforeunload",()=>{this.close()}));const a=this.createPopoutWindowContainer();return this.className&&a.classList.add(this.className),(t=(e=this.options).onDidOpen)===null||t===void 0||t.call(e,{id:this.target,window:n}),new Promise((h,l)=>{n.addEventListener("unload",d=>{}),n.addEventListener("load",()=>{try{const d=n.document;d.title=document.title,d.body.appendChild(a),Ft(d,window.document.styleSheets),I(n,"beforeunload",()=>{this.close()}),h(a)}catch(d){l(d)}})})})}createPopoutWindowContainer(){const e=document.createElement("div");return e.classList.add("dv-popout-window"),e.id="dv-popout-window",e.style.position="absolute",e.style.width="100%",e.style.height="100%",e.style.top="0px",e.style.left="0px",e}}class en extends E{constructor(e){super(),this.accessor=e,this.init()}init(){const e=new Set,t=new Set;this.addDisposables(this.accessor.onDidAddPanel(i=>{if(e.has(i.api.id))throw new Error(`dockview: Invalid event sequence. [onDidAddPanel] called for panel ${i.api.id} but panel already exists`);e.add(i.api.id)}),this.accessor.onDidRemovePanel(i=>{if(e.has(i.api.id))e.delete(i.api.id);else throw new Error(`dockview: Invalid event sequence. [onDidRemovePanel] called for panel ${i.api.id} but panel does not exists`)}),this.accessor.onDidAddGroup(i=>{if(t.has(i.api.id))throw new Error(`dockview: Invalid event sequence. [onDidAddGroup] called for group ${i.api.id} but group already exists`);t.add(i.api.id)}),this.accessor.onDidRemoveGroup(i=>{if(t.has(i.api.id))t.delete(i.api.id);else throw new Error(`dockview: Invalid event sequence. [onDidRemoveGroup] called for group ${i.api.id} but group does not exists`)}))}}class tn extends E{constructor(e){super(),this.root=e,this._active=null,this._activeDisposable=new Y,this._element=document.createElement("div"),this._element.className="dv-popover-anchor",this._element.style.position="relative",this.root.prepend(this._element),this.addDisposables(W.from(()=>{this.close()}),this._activeDisposable)}openPopover(e,t){var i;this.close();const s=document.createElement("div");s.style.position="absolute",s.style.zIndex=(i=t.zIndex)!==null&&i!==void 0?i:"var(--dv-overlay-z-index)",s.appendChild(e);const n=this._element.getBoundingClientRect(),r=n.left,a=n.top;s.style.top=`${t.y-a}px`,s.style.left=`${t.x-r}px`,this._element.appendChild(s),this._active=s,this._activeDisposable.value=new E(I(window,"pointerdown",h=>{var l;const d=h.target;if(!(d instanceof HTMLElement))return;let c=d;for(;c&&c!==s;)c=(l=c?.parentElement)!==null&&l!==void 0?l:null;c||this.close()})),requestAnimationFrame(()=>{Jt(s,this.root)})}close(){this._active&&(this._active.remove(),this._activeDisposable.dispose(),this._active=null)}}class at extends E{get disabled(){return this._disabled}set disabled(e){var t;this.disabled!==e&&(this._disabled=e,e&&((t=this.model)===null||t===void 0||t.clear()))}get model(){if(!this.disabled)return{clear:()=>{var e;this._model&&((e=this._model.root.parentElement)===null||e===void 0||e.removeChild(this._model.root)),this._model=void 0},exists:()=>!!this._model,getElements:(e,t)=>{const i=this._outline!==t;if(this._outline=t,this._model)return this._model.changed=i,this._model;const s=this.createContainer(),n=this.createAnchor();if(this._model={root:s,overlay:n,changed:i},s.appendChild(n),this.element.appendChild(s),e?.target instanceof HTMLElement){const r=e.target.getBoundingClientRect(),a=this.element.getBoundingClientRect();n.style.left=`${r.left-a.left}px`,n.style.top=`${r.top-a.top}px`}return this._model}}}constructor(e,t){super(),this.element=e,this._disabled=!1,this._disabled=t.disabled,this.addDisposables(W.from(()=>{var i;(i=this.model)===null||i===void 0||i.clear()}))}createContainer(){const e=document.createElement("div");return e.className="dv-drop-target-container",e}createAnchor(){const e=document.createElement("div");return e.className="dv-drop-target-anchor",e.style.visibility="hidden",e}}const ht={activationSize:{type:"pixels",value:10},size:{type:"pixels",value:20}};function be(o){const e=o.from.activePanel;[...o.from.panels].map(i=>{const s=o.from.model.removePanel(i);return o.from.model.renderContainer.detatch(i),s}).forEach(i=>{o.to.model.openPanel(i,{skipSetActive:e!==i,skipSetGroupActive:!0})})}class nn extends li{get orientation(){return this.gridview.orientation}get totalPanels(){return this.panels.length}get panels(){return this.groups.flatMap(e=>e.panels)}get options(){return this._options}get activePanel(){const e=this.activeGroup;if(e)return e.activePanel}get renderer(){var e;return(e=this.options.defaultRenderer)!==null&&e!==void 0?e:"onlyWhenVisible"}get api(){return this._api}get floatingGroups(){return this._floatingGroups}get popoutRestorationPromise(){return this._popoutRestorationPromise}constructor(e,t){var i,s,n;super(e,{proportionalLayout:!0,orientation:P.HORIZONTAL,styles:t.hideBorders?{separatorBorder:"transparent"}:void 0,disableAutoResizing:t.disableAutoResizing,locked:t.locked,margin:(s=(i=t.theme)===null||i===void 0?void 0:i.gap)!==null&&s!==void 0?s:0,className:t.className}),this.nextGroupId=_t(),this._deserializer=new ji(this),this._watermark=null,this._onWillDragPanel=new f,this.onWillDragPanel=this._onWillDragPanel.event,this._onWillDragGroup=new f,this.onWillDragGroup=this._onWillDragGroup.event,this._onDidDrop=new f,this.onDidDrop=this._onDidDrop.event,this._onWillDrop=new f,this.onWillDrop=this._onWillDrop.event,this._onWillShowOverlay=new f,this.onWillShowOverlay=this._onWillShowOverlay.event,this._onUnhandledDragOverEvent=new f,this.onUnhandledDragOverEvent=this._onUnhandledDragOverEvent.event,this._onDidRemovePanel=new f,this.onDidRemovePanel=this._onDidRemovePanel.event,this._onDidAddPanel=new f,this.onDidAddPanel=this._onDidAddPanel.event,this._onDidPopoutGroupSizeChange=new f,this.onDidPopoutGroupSizeChange=this._onDidPopoutGroupSizeChange.event,this._onDidPopoutGroupPositionChange=new f,this.onDidPopoutGroupPositionChange=this._onDidPopoutGroupPositionChange.event,this._onDidOpenPopoutWindowFail=new f,this.onDidOpenPopoutWindowFail=this._onDidOpenPopoutWindowFail.event,this._onDidLayoutFromJSON=new f,this.onDidLayoutFromJSON=this._onDidLayoutFromJSON.event,this._onDidActivePanelChange=new f({replay:!0}),this.onDidActivePanelChange=this._onDidActivePanelChange.event,this._onDidMovePanel=new f,this.onDidMovePanel=this._onDidMovePanel.event,this._onDidMaximizedGroupChange=new f,this.onDidMaximizedGroupChange=this._onDidMaximizedGroupChange.event,this._floatingGroups=[],this._popoutGroups=[],this._popoutRestorationPromise=Promise.resolve(),this._onDidRemoveGroup=new f,this.onDidRemoveGroup=this._onDidRemoveGroup.event,this._onDidAddGroup=new f,this.onDidAddGroup=this._onDidAddGroup.event,this._onDidOptionsChange=new f,this.onDidOptionsChange=this._onDidOptionsChange.event,this._onDidActiveGroupChange=new f,this.onDidActiveGroupChange=this._onDidActiveGroupChange.event,this._moving=!1,this._options=t,this.popupService=new tn(this.element),this._themeClassnames=new vt(this.element),this._api=new Ae(this),this.rootDropTargetContainer=new at(this.element,{disabled:!0}),this.overlayRenderContainer=new rt(this.gridview.element,this),this._rootDropTarget=new Q(this.element,{className:"dv-drop-target-edge",canDisplayOverlay:(r,a)=>{const h=$();if(h)return h.viewId!==this.id?!1:a==="center"?this.gridview.length===0:!0;if(a==="center"&&this.gridview.length!==0)return!1;const l=new At(r,"edge",a,$);return this._onUnhandledDragOverEvent.fire(l),l.isAccepted},acceptedTargetZones:["top","bottom","left","right","center"],overlayModel:(n=t.rootOverlayModel)!==null&&n!==void 0?n:ht,getOverrideTarget:()=>{var r;return(r=this.rootDropTargetContainer)===null||r===void 0?void 0:r.model}}),this.updateDropTargetModel(t),A(this.gridview.element,"dv-dockview",!0),A(this.element,"dv-debug",!!t.debug),this.updateTheme(),this.updateWatermark(),t.debug&&this.addDisposables(new en(this)),this.addDisposables(this.rootDropTargetContainer,this.overlayRenderContainer,this._onWillDragPanel,this._onWillDragGroup,this._onWillShowOverlay,this._onDidActivePanelChange,this._onDidAddPanel,this._onDidRemovePanel,this._onDidLayoutFromJSON,this._onDidDrop,this._onWillDrop,this._onDidMovePanel,this._onDidAddGroup,this._onDidRemoveGroup,this._onDidActiveGroupChange,this._onUnhandledDragOverEvent,this._onDidMaximizedGroupChange,this._onDidOptionsChange,this._onDidPopoutGroupSizeChange,this._onDidPopoutGroupPositionChange,this._onDidOpenPopoutWindowFail,this.onDidViewVisibilityChangeMicroTaskQueue(()=>{this.updateWatermark()}),this.onDidAdd(r=>{this._moving||this._onDidAddGroup.fire(r)}),this.onDidRemove(r=>{this._moving||this._onDidRemoveGroup.fire(r)}),this.onDidActiveChange(r=>{this._moving||this._onDidActiveGroupChange.fire(r)}),this.onDidMaximizedChange(r=>{this._onDidMaximizedGroupChange.fire({group:r.panel,isMaximized:r.isMaximized})}),he.any(this.onDidAdd,this.onDidRemove)(()=>{this.updateWatermark()}),he.any(this.onDidAddPanel,this.onDidRemovePanel,this.onDidAddGroup,this.onDidRemove,this.onDidMovePanel,this.onDidActivePanelChange,this.onDidPopoutGroupPositionChange,this.onDidPopoutGroupSizeChange)(()=>{this._bufferOnDidLayoutChange.fire()}),W.from(()=>{for(const r of[...this._floatingGroups])r.dispose();for(const r of[...this._popoutGroups])r.disposable.dispose()}),this._rootDropTarget,this._rootDropTarget.onWillShowOverlay(r=>{this.gridview.length>0&&r.position==="center"||this._onWillShowOverlay.fire(new Pe(r,{kind:"edge",panel:void 0,api:this._api,group:void 0,getData:$}))}),this._rootDropTarget.onDrop(r=>{var a;const h=new St({nativeEvent:r.nativeEvent,position:r.position,panel:void 0,api:this._api,group:void 0,getData:$,kind:"edge"});if(this._onWillDrop.fire(h),h.defaultPrevented)return;const l=$();l?this.moveGroupOrPanel({from:{groupId:l.groupId,panelId:(a=l.panelId)!==null&&a!==void 0?a:void 0},to:{group:this.orthogonalize(r.position),position:"center"}}):this._onDidDrop.fire(new qe({nativeEvent:r.nativeEvent,position:r.position,panel:void 0,api:this._api,group:void 0,getData:$}))}),this._rootDropTarget)}setVisible(e,t){switch(e.api.location.type){case"grid":super.setVisible(e,t);break;case"floating":{const i=this.floatingGroups.find(s=>s.group===e);i&&(i.overlay.setVisible(t),e.api._onDidVisibilityChange.fire({isVisible:t}));break}case"popout":console.warn("dockview: You cannot hide a group that is in a popout window");break}}addPopoutGroup(e,t){var i,s,n,r,a;if(e instanceof ue&&e.group.size===1)return this.addPopoutGroup(e.group,t);const h=qt(this.gridview.element),l=this.element;function d(){return t?.position?t.position:e instanceof st?e.element.getBoundingClientRect():e.group?e.group.element.getBoundingClientRect():l.getBoundingClientRect()}const c=d(),m=(s=(i=t?.overridePopoutGroup)===null||i===void 0?void 0:i.id)!==null&&s!==void 0?s:this.getNextGroupId(),u=new Qi(`${this.id}-${m}`,h??"",{url:(a=(n=t?.popoutUrl)!==null&&n!==void 0?n:(r=this.options)===null||r===void 0?void 0:r.popoutUrl)!==null&&a!==void 0?a:"/popout.html",left:window.screenX+c.left,top:window.screenY+c.top,width:c.width,height:c.height,onDidOpen:t?.onDidOpen,onWillClose:t?.onWillClose}),v=new E(u,u.onDidClose(()=>{v.dispose()}));return u.open().then(p=>{var g;if(u.isDisposed)return!1;const b=t?.referenceGroup?t.referenceGroup:e instanceof ue?e.group:e,y=e.api.location.type,D=b.element.parentElement!==null;let _;if(D?t?.overridePopoutGroup?_=t.overridePopoutGroup:(_=this.createGroup({id:m}),p&&this._onDidAddGroup.fire(_)):_=b,p===null)return console.error("dockview: failed to create popout. perhaps you need to allow pop-ups for this website"),v.dispose(),this._onDidOpenPopoutWindowFail.fire(),this.movingLock(()=>be({from:_,to:b})),b.api.isVisible||b.api.setVisible(!0),!1;const x=document.createElement("div");x.className="dv-overlay-render-container";const C=new rt(x,this);_.model.renderContainer=C,_.layout(u.window.innerWidth,u.window.innerHeight);let M;if(!t?.overridePopoutGroup&&D)if(e instanceof ue)this.movingLock(()=>{const z=b.model.removePanel(e);_.model.openPanel(z)});else switch(this.movingLock(()=>be({from:b,to:_})),y){case"grid":b.api.setVisible(!1);break;case"floating":case"popout":M=(g=this._floatingGroups.find(z=>z.group.api.id===e.api.id))===null||g===void 0?void 0:g.overlay.toJSON(),this.removeGroup(b);break}p.classList.add("dv-dockview"),p.style.overflow="hidden",p.appendChild(x),p.appendChild(_.element);const L=document.createElement("div"),U=new at(L,{disabled:this.rootDropTargetContainer.disabled});p.appendChild(L),_.model.dropTargetContainer=U,_.model.location={type:"popout",getWindow:()=>u.window,popoutUrl:t?.popoutUrl},D&&e.api.location.type==="grid"&&e.api.setVisible(!1),this.doSetGroupAndPanelActive(_),v.addDisposables(_.api.onDidActiveChange(z=>{var w;z.isActive&&((w=u.window)===null||w===void 0||w.focus())}),_.api.onWillFocus(()=>{var z;(z=u.window)===null||z===void 0||z.focus()}));let k;const H=D&&b&&this.getPanel(b.id),j={window:u,popoutGroup:_,referenceGroup:H?b.id:void 0,disposable:{dispose:()=>(v.dispose(),k)}},G=Xt(u.window);return v.addDisposables(G,Zt(u.window,()=>{this._onDidPopoutGroupSizeChange.fire({width:u.window.innerWidth,height:u.window.innerHeight,group:_})}),G.event(()=>{this._onDidPopoutGroupPositionChange.fire({screenX:u.window.screenX,screenY:u.window.screenX,group:_})}),I(u.window,"resize",()=>{_.layout(u.window.innerWidth,u.window.innerHeight)}),C,W.from(()=>{if(!this.isDisposed){if(D&&this.getPanel(b.id))this.movingLock(()=>be({from:_,to:b})),b.api.isVisible||b.api.setVisible(!0),this.getPanel(_.id)&&this.doRemoveGroup(_,{skipPopoutAssociated:!0});else if(this.getPanel(_.id)){if(_.model.renderContainer=this.overlayRenderContainer,_.model.dropTargetContainer=this.rootDropTargetContainer,k=_,!this._popoutGroups.find(w=>w.popoutGroup===_))return;M?this.addFloatingGroup(_,{height:M.height,width:M.width,position:M}):(this.doRemoveGroup(_,{skipDispose:!0,skipActive:!0,skipPopoutReturn:!0}),_.model.location={type:"grid"},this.movingLock(()=>{this.doAddGroup(_,[0])})),this.doSetGroupAndPanelActive(_)}}})),this._popoutGroups.push(j),this.updateWatermark(),!0}).catch(p=>(console.error("dockview: failed to create popout.",p),!1))}addFloatingGroup(e,t){var i,s,n,r,a;let h;if(e instanceof ue)h=this.createGroup(),this._onDidAddGroup.fire(h),this.movingLock(()=>this.removePanel(e,{removeEmptyGroup:!0,skipDispose:!0,skipSetActiveGroup:!0})),this.movingLock(()=>h.model.openPanel(e,{skipSetGroupActive:!0}));else{h=e;const p=(i=this._popoutGroups.find(y=>y.popoutGroup===h))===null||i===void 0?void 0:i.referenceGroup,g=p?this.getPanel(p):void 0;typeof t?.skipRemoveGroup=="boolean"&&t.skipRemoveGroup||(g?(this.movingLock(()=>be({from:e,to:g})),this.doRemoveGroup(e,{skipPopoutReturn:!0,skipPopoutAssociated:!0}),this.doRemoveGroup(g,{skipDispose:!0}),h=g):this.doRemoveGroup(e,{skipDispose:!0,skipPopoutReturn:!0,skipPopoutAssociated:!1}))}function l(){if(t?.position){const p={};return"left"in t.position?p.left=Math.max(t.position.left,0):"right"in t.position?p.right=Math.max(t.position.right,0):p.left=ie.left,"top"in t.position?p.top=Math.max(t.position.top,0):"bottom"in t.position?p.bottom=Math.max(t.position.bottom,0):p.top=ie.top,typeof t.width=="number"?p.width=Math.max(t.width,0):p.width=ie.width,typeof t.height=="number"?p.height=Math.max(t.height,0):p.height=ie.height,p}return{left:typeof t?.x=="number"?Math.max(t.x,0):ie.left,top:typeof t?.y=="number"?Math.max(t.y,0):ie.top,width:typeof t?.width=="number"?Math.max(t.width,0):ie.width,height:typeof t?.height=="number"?Math.max(t.height,0):ie.height}}const d=l(),c=new se(Object.assign(Object.assign({container:this.gridview.element,content:h.element},d),{minimumInViewportWidth:this.options.floatingGroupBounds==="boundedWithinViewport"?void 0:(n=(s=this.options.floatingGroupBounds)===null||s===void 0?void 0:s.minimumWidthWithinViewport)!==null&&n!==void 0?n:we,minimumInViewportHeight:this.options.floatingGroupBounds==="boundedWithinViewport"?void 0:(a=(r=this.options.floatingGroupBounds)===null||r===void 0?void 0:r.minimumHeightWithinViewport)!==null&&a!==void 0?a:we})),m=h.element.querySelector(".dv-void-container");if(!m)throw new Error("failed to find drag handle");c.setupDrag(m,{inDragMode:typeof t?.inDragMode=="boolean"?t.inDragMode:!1});const u=new Yi(h,c),v=new E(h.api.onDidActiveChange(p=>{p.isActive&&c.bringToFront()}),Se(h.element,p=>{const{width:g,height:b}=p.contentRect;h.layout(g,b)}));u.addDisposables(c.onDidChange(()=>{h.layout(h.width,h.height)}),c.onDidChangeEnd(()=>{this._bufferOnDidLayoutChange.fire()}),h.onDidChange(p=>{c.setBounds({height:p?.height,width:p?.width})}),{dispose:()=>{v.dispose(),Ge(this._floatingGroups,u),h.model.location={type:"grid"},this.updateWatermark()}}),this._floatingGroups.push(u),h.model.location={type:"floating"},t?.skipActiveGroup||this.doSetGroupAndPanelActive(h),this.updateWatermark()}orthogonalize(e,t){switch(this.gridview.normalize(),e){case"top":case"bottom":this.gridview.orientation===P.HORIZONTAL&&this.gridview.insertOrthogonalSplitviewAtRoot();break;case"left":case"right":this.gridview.orientation===P.VERTICAL&&this.gridview.insertOrthogonalSplitviewAtRoot();break}switch(e){case"top":case"left":case"center":return this.createGroupAtLocation([0],void 0,t);case"bottom":case"right":return this.createGroupAtLocation([this.gridview.length],void 0,t);default:throw new Error(`unsupported position ${e}`)}}updateOptions(e){var t,i;if(super.updateOptions(e),"floatingGroupBounds"in e)for(const r of this._floatingGroups){switch(e.floatingGroupBounds){case"boundedWithinViewport":r.overlay.minimumInViewportHeight=void 0,r.overlay.minimumInViewportWidth=void 0;break;case void 0:r.overlay.minimumInViewportHeight=we,r.overlay.minimumInViewportWidth=we;break;default:r.overlay.minimumInViewportHeight=(t=e.floatingGroupBounds)===null||t===void 0?void 0:t.minimumHeightWithinViewport,r.overlay.minimumInViewportWidth=(i=e.floatingGroupBounds)===null||i===void 0?void 0:i.minimumWidthWithinViewport}r.overlay.setBounds()}this.updateDropTargetModel(e);const s=this.options.disableDnd;this._options=Object.assign(Object.assign({},this.options),e);const n=this.options.disableDnd;s!==n&&this.updateDragAndDropState(),"theme"in e&&this.updateTheme(),this.layout(this.gridview.width,this.gridview.height,!0)}layout(e,t,i){if(super.layout(e,t,i),this._floatingGroups)for(const s of this._floatingGroups)s.overlay.setBounds()}updateDragAndDropState(){for(const e of this.groups)e.model.updateDragAndDropState()}focus(){var e;(e=this.activeGroup)===null||e===void 0||e.focus()}getGroupPanel(e){return this.panels.find(t=>t.id===e)}setActivePanel(e){e.group.model.openPanel(e),this.doSetGroupAndPanelActive(e.group)}moveToNext(e={}){var t;if(!e.group){if(!this.activeGroup)return;e.group=this.activeGroup}if(e.includePanel&&e.group&&e.group.activePanel!==e.group.panels[e.group.panels.length-1]){e.group.model.moveToNext({suppressRoll:!0});return}const i=B(e.group.element),s=(t=this.gridview.next(i))===null||t===void 0?void 0:t.view;this.doSetGroupAndPanelActive(s)}moveToPrevious(e={}){var t;if(!e.group){if(!this.activeGroup)return;e.group=this.activeGroup}if(e.includePanel&&e.group&&e.group.activePanel!==e.group.panels[0]){e.group.model.moveToPrevious({suppressRoll:!0});return}const i=B(e.group.element),s=(t=this.gridview.previous(i))===null||t===void 0?void 0:t.view;s&&this.doSetGroupAndPanelActive(s)}toJSON(){var e;const t=this.gridview.serialize(),i=this.panels.reduce((a,h)=>(a[h.id]=h.toJSON(),a),{}),s=this._floatingGroups.map(a=>({data:a.group.toJSON(),position:a.overlay.toJSON()})),n=this._popoutGroups.map(a=>({data:a.popoutGroup.toJSON(),gridReferenceGroup:a.referenceGroup,position:a.window.dimensions(),url:a.popoutGroup.api.location.type==="popout"?a.popoutGroup.api.location.popoutUrl:void 0})),r={grid:t,panels:i,activeGroup:(e=this.activeGroup)===null||e===void 0?void 0:e.id};return s.length>0&&(r.floatingGroups=s),n.length>0&&(r.popoutGroups=n),r}fromJSON(e){var t,i;if(this.clear(),typeof e!="object"||e===null)throw new Error("serialized layout must be a non-null object");const{grid:s,panels:n,activeGroup:r}=e;if(s.root.type!=="branch"||!Array.isArray(s.root.data))throw new Error("root must be of type branch");try{const a=this.width,h=this.height,l=u=>{const{id:v,locked:p,hideHeader:g,views:b,activeView:y}=u;if(typeof v!="string")throw new Error("group id must be of type string");const D=this.createGroup({id:v,locked:!!p,hideHeader:!!g});this._onDidAddGroup.fire(D);const _=[];for(const x of b){const C=this._deserializer.fromJSON(n[x],D);_.push(C)}for(let x=0;x<b.length;x++){const C=_[x],M=typeof y=="string"&&y===C.id;D.model.openPanel(C,{skipSetActive:!M,skipSetGroupActive:!0})}return!D.activePanel&&D.panels.length>0&&D.model.openPanel(D.panels[D.panels.length-1],{skipSetGroupActive:!0}),D};this.gridview.deserialize(s,{fromJSON:u=>l(u.data)}),this.layout(a,h,!0);const d=(t=e.floatingGroups)!==null&&t!==void 0?t:[];for(const u of d){const{data:v,position:p}=u,g=l(v);this.addFloatingGroup(g,{position:p,width:p.width,height:p.height,skipRemoveGroup:!0,inDragMode:!1})}const c=(i=e.popoutGroups)!==null&&i!==void 0?i:[],m=[];c.forEach((u,v)=>{const{data:p,position:g,gridReferenceGroup:b,url:y}=u,D=l(p),_=new Promise(x=>{setTimeout(()=>{this.addPopoutGroup(D,{position:g??void 0,overridePopoutGroup:b?D:void 0,referenceGroup:b?this.getPanel(b):void 0,popoutUrl:y}),x()},v*Xi)});m.push(_)}),this._popoutRestorationPromise=Promise.all(m).then(()=>{});for(const u of this._floatingGroups)u.overlay.setBounds();if(typeof r=="string"){const u=this.getPanel(r);u&&this.doSetGroupAndPanelActive(u)}}catch(a){console.error("dockview: failed to deserialize layout. Reverting changes",a);for(const h of this.groups)for(const l of h.panels)this.removePanel(l,{removeEmptyGroup:!1,skipDispose:!1});for(const h of this.groups)h.dispose(),this._groups.delete(h.id),this._onDidRemoveGroup.fire(h);for(const h of[...this._floatingGroups])h.dispose();throw this.clear(),a}this.updateWatermark(),requestAnimationFrame(()=>{this.overlayRenderContainer.updateAllPositions()}),this._onDidLayoutFromJSON.fire()}clear(){const e=Array.from(this._groups.values()).map(i=>i.value),t=!!this.activeGroup;for(const i of e)this.removeGroup(i,{skipActive:!0});t&&this.doSetGroupAndPanelActive(void 0),this.gridview.clear()}closeAllGroups(){for(const e of this._groups.entries()){const[t,i]=e;i.value.model.closeAllPanels()}}addPanel(e){var t,i;if(this.panels.find(h=>h.id===e.id))throw new Error(`panel with id ${e.id} already exists`);let s;if(e.position&&e.floating)throw new Error("you can only provide one of: position, floating as arguments to .addPanel(...)");const n={width:e.initialWidth,height:e.initialHeight};let r;if(e.position)if(Mi(e.position)){const h=typeof e.position.referencePanel=="string"?this.getGroupPanel(e.position.referencePanel):e.position.referencePanel;if(r=e.position.index,!h)throw new Error(`referencePanel '${e.position.referencePanel}' does not exist`);s=this.findGroup(h)}else if(Ti(e.position)){if(s=typeof e.position.referenceGroup=="string"?(t=this._groups.get(e.position.referenceGroup))===null||t===void 0?void 0:t.value:e.position.referenceGroup,r=e.position.index,!s)throw new Error(`referenceGroup '${e.position.referenceGroup}' does not exist`)}else{const h=this.orthogonalize(nt(e.position.direction)),l=this.createPanel(e,h);return h.model.openPanel(l,{skipSetActive:e.inactive,skipSetGroupActive:e.inactive,index:r}),e.inactive||this.doSetGroupAndPanelActive(h),h.api.setSize({height:n?.height,width:n?.width}),l}else s=this.activeGroup;let a;if(s){const h=it(((i=e.position)===null||i===void 0?void 0:i.direction)||"within");if(e.floating){const l=this.createGroup();this._onDidAddGroup.fire(l);const d=typeof e.floating=="object"&&e.floating!==null?e.floating:{};this.addFloatingGroup(l,Object.assign(Object.assign({},d),{inDragMode:!1,skipRemoveGroup:!0,skipActiveGroup:!0})),a=this.createPanel(e,l),l.model.openPanel(a,{skipSetActive:e.inactive,skipSetGroupActive:e.inactive,index:r})}else if(s.api.location.type==="floating"||h==="center")a=this.createPanel(e,s),s.model.openPanel(a,{skipSetActive:e.inactive,skipSetGroupActive:e.inactive,index:r}),s.api.setSize({width:n?.width,height:n?.height}),e.inactive||this.doSetGroupAndPanelActive(s);else{const l=B(s.element),d=ce(this.gridview.orientation,l,h),c=this.createGroupAtLocation(d,this.orientationAtLocation(d)===P.VERTICAL?n?.height:n?.width);a=this.createPanel(e,c),c.model.openPanel(a,{skipSetActive:e.inactive,skipSetGroupActive:e.inactive,index:r}),e.inactive||this.doSetGroupAndPanelActive(c)}}else if(e.floating){const h=this.createGroup();this._onDidAddGroup.fire(h);const l=typeof e.floating=="object"&&e.floating!==null?e.floating:{};this.addFloatingGroup(h,Object.assign(Object.assign({},l),{inDragMode:!1,skipRemoveGroup:!0,skipActiveGroup:!0})),a=this.createPanel(e,h),h.model.openPanel(a,{skipSetActive:e.inactive,skipSetGroupActive:e.inactive,index:r})}else{const h=this.createGroupAtLocation([0],this.gridview.orientation===P.VERTICAL?n?.height:n?.width);a=this.createPanel(e,h),h.model.openPanel(a,{skipSetActive:e.inactive,skipSetGroupActive:e.inactive,index:r}),e.inactive||this.doSetGroupAndPanelActive(h)}return a}removePanel(e,t={removeEmptyGroup:!0}){const i=e.group;if(!i)throw new Error(`cannot remove panel ${e.id}. it's missing a group.`);i.model.removePanel(e,{skipSetActiveGroup:t.skipSetActiveGroup}),t.skipDispose||(e.group.model.renderContainer.detatch(e),e.dispose()),i.size===0&&t.removeEmptyGroup&&this.removeGroup(i,{skipActive:t.skipSetActiveGroup})}createWatermarkComponent(){return this.options.createWatermarkComponent?this.options.createWatermarkComponent():new $i}updateWatermark(){var e,t;if(this.groups.filter(i=>i.api.location.type==="grid"&&i.api.isVisible).length===0){if(!this._watermark){this._watermark=this.createWatermarkComponent(),this._watermark.init({containerApi:new Ae(this)});const i=document.createElement("div");i.className="dv-watermark-container",jt(i,"watermark-component"),i.appendChild(this._watermark.element),this.gridview.element.appendChild(i)}}else this._watermark&&(this._watermark.element.parentElement.remove(),(t=(e=this._watermark).dispose)===null||t===void 0||t.call(e),this._watermark=null)}addGroup(e){var t;if(e){let i;if(Li(e)){const l=typeof e.referencePanel=="string"?this.panels.find(d=>d.id===e.referencePanel):e.referencePanel;if(!l)throw new Error(`reference panel ${e.referencePanel} does not exist`);if(i=this.findGroup(l),!i)throw new Error(`reference group for reference panel ${e.referencePanel} does not exist`)}else if(ki(e)){if(i=typeof e.referenceGroup=="string"?(t=this._groups.get(e.referenceGroup))===null||t===void 0?void 0:t.value:e.referenceGroup,!i)throw new Error(`reference group ${e.referenceGroup} does not exist`)}else{const l=this.orthogonalize(nt(e.direction),e);return e.skipSetActive||this.doSetGroupAndPanelActive(l),l}const s=it(e.direction||"within"),n=B(i.element),r=ce(this.gridview.orientation,n,s),a=this.createGroup(e),h=this.getLocationOrientation(r)===P.VERTICAL?e.initialHeight:e.initialWidth;return this.doAddGroup(a,r,h),e.skipSetActive||this.doSetGroupAndPanelActive(a),a}else{const i=this.createGroup(e);return this.doAddGroup(i),this.doSetGroupAndPanelActive(i),i}}getLocationOrientation(e){return e.length%2==0&&this.gridview.orientation===P.HORIZONTAL?P.HORIZONTAL:P.VERTICAL}removeGroup(e,t){this.doRemoveGroup(e,t)}doRemoveGroup(e,t){var i;const s=[...e.panels];if(!t?.skipDispose)for(const a of s)this.removePanel(a,{removeEmptyGroup:!1,skipDispose:(i=t?.skipDispose)!==null&&i!==void 0?i:!1});const n=this.activePanel;if(e.api.location.type==="floating"){const a=this._floatingGroups.find(h=>h.group===e);if(a){if(t?.skipDispose||(a.group.dispose(),this._groups.delete(e.id),this._onDidRemoveGroup.fire(e)),Ge(this._floatingGroups,a),a.dispose(),!t?.skipActive&&this._activeGroup===e){const h=Array.from(this._groups.values());this.doSetGroupAndPanelActive(h.length>0?h[0].value:void 0)}return a.group}throw new Error("failed to find floating group")}if(e.api.location.type==="popout"){const a=this._popoutGroups.find(h=>h.popoutGroup===e);if(a){if(!t?.skipDispose){if(!t?.skipPopoutAssociated){const l=a.referenceGroup?this.getPanel(a.referenceGroup):void 0;l&&l.panels.length===0&&this.removeGroup(l)}a.popoutGroup.dispose(),this._groups.delete(e.id),this._onDidRemoveGroup.fire(e)}Ge(this._popoutGroups,a);const h=a.disposable.dispose();if(!t?.skipPopoutReturn&&h&&(this.doAddGroup(h,[0]),this.doSetGroupAndPanelActive(h)),!t?.skipActive&&this._activeGroup===e){const l=Array.from(this._groups.values());this.doSetGroupAndPanelActive(l.length>0?l[0].value:void 0)}return this.updateWatermark(),a.popoutGroup}throw new Error("failed to find popout group")}const r=super.doRemoveGroup(e,t);return t?.skipActive||this.activePanel!==n&&this._onDidActivePanelChange.fire(this.activePanel),r}movingLock(e){const t=this._moving;try{return this._moving=!0,e()}finally{this._moving=t}}moveGroupOrPanel(e){var t;const i=e.to.group,s=e.from.groupId,n=e.from.panelId,r=e.to.position,a=e.to.index,h=s?(t=this._groups.get(s))===null||t===void 0?void 0:t.value:void 0;if(!h)throw new Error(`Failed to find group id ${s}`);if(n===void 0){this.moveGroup({from:{group:h},to:{group:i,position:r},skipSetActive:e.skipSetActive});return}if(!r||r==="center"){const l=this.movingLock(()=>h.model.removePanel(n,{skipSetActive:!1,skipSetActiveGroup:!0}));if(!l)throw new Error(`No panel with id ${n}`);h.model.size===0&&this.doRemoveGroup(h,{skipActive:!0});const d=i.model.size===0;this.movingLock(()=>{var c;return i.model.openPanel(l,{index:a,skipSetActive:((c=e.skipSetActive)!==null&&c!==void 0?c:!1)&&!d,skipSetGroupActive:!0})}),e.skipSetActive||this.doSetGroupAndPanelActive(i),this._onDidMovePanel.fire({panel:l,from:h})}else{const l=B(i.element),d=ce(this.gridview.orientation,l,r);if(h.size<2){const[c,m]=re(d);if(h.api.location.type==="grid"){const g=B(h.element),[b,y]=re(g);if(Qt(b,c)){this.gridview.moveView(b,y,m),this._onDidMovePanel.fire({panel:this.getGroupPanel(n),from:h});return}}if(h.api.location.type==="popout"){const g=this._popoutGroups.find(D=>D.popoutGroup===h),b=this.movingLock(()=>g.popoutGroup.model.removePanel(g.popoutGroup.panels[0],{skipSetActive:!0,skipSetActiveGroup:!0}));this.doRemoveGroup(h,{skipActive:!0});const y=this.createGroupAtLocation(d);this.movingLock(()=>y.model.openPanel(b)),this.doSetGroupAndPanelActive(y),this._onDidMovePanel.fire({panel:this.getGroupPanel(n),from:h});return}const u=this.movingLock(()=>this.doRemoveGroup(h,{skipActive:!0,skipDispose:!0})),v=B(i.element),p=ce(this.gridview.orientation,v,r);this.movingLock(()=>this.doAddGroup(u,p)),this.doSetGroupAndPanelActive(u),this._onDidMovePanel.fire({panel:this.getGroupPanel(n),from:h})}else{const c=this.movingLock(()=>h.model.removePanel(n,{skipSetActive:!1,skipSetActiveGroup:!0}));if(!c)throw new Error(`No panel with id ${n}`);const m=ce(this.gridview.orientation,l,r),u=this.createGroupAtLocation(m);this.movingLock(()=>u.model.openPanel(c,{skipSetGroupActive:!0})),this.doSetGroupAndPanelActive(u),this._onDidMovePanel.fire({panel:c,from:h})}}}moveGroup(e){const t=e.from.group,i=e.to.group,s=e.to.position;if(s==="center"){const n=t.activePanel,r=this.movingLock(()=>[...t.panels].map(a=>t.model.removePanel(a.id,{skipSetActive:!0})));t?.model.size===0&&this.doRemoveGroup(t,{skipActive:!0}),this.movingLock(()=>{for(const a of r)i.model.openPanel(a,{skipSetActive:a!==n,skipSetGroupActive:!0})}),e.skipSetActive!==!0?this.doSetGroupAndPanelActive(i):this.activePanel||this.doSetGroupAndPanelActive(i)}else{switch(t.api.location.type){case"grid":this.gridview.removeView(B(t.element));break;case"floating":{const n=this._floatingGroups.find(r=>r.group===t);if(!n)throw new Error("failed to find floating group");n.dispose();break}case"popout":{const n=this._popoutGroups.find(a=>a.popoutGroup===t);if(!n)throw new Error("failed to find popout group");const r=this._popoutGroups.indexOf(n);if(r>=0&&this._popoutGroups.splice(r,1),n.referenceGroup){const a=this.getPanel(n.referenceGroup);a&&!a.api.isVisible&&this.doRemoveGroup(a,{skipActive:!0})}n.window.dispose(),i.api.location.type==="grid"?(t.model.renderContainer=this.overlayRenderContainer,t.model.dropTargetContainer=this.rootDropTargetContainer,t.model.location={type:"grid"}):i.api.location.type==="floating"&&(t.model.renderContainer=this.overlayRenderContainer,t.model.dropTargetContainer=this.rootDropTargetContainer,t.model.location={type:"floating"});break}}if(i.api.location.type==="grid"){const n=B(i.element),r=ce(this.gridview.orientation,n,s);let a;switch(this.gridview.orientation){case P.VERTICAL:a=n.length%2==0?t.api.width:t.api.height;break;case P.HORIZONTAL:a=n.length%2==0?t.api.height:t.api.width;break}this.gridview.addView(t,a,r)}else if(i.api.location.type==="floating"){const n=this._floatingGroups.find(r=>r.group===i);if(n){const r=n.overlay.toJSON();let a,h;"left"in r?a=r.left+50:"right"in r?a=Math.max(0,r.right-r.width-50):a=50,"top"in r?h=r.top+50:"bottom"in r?h=Math.max(0,r.bottom-r.height-50):h=50,this.addFloatingGroup(t,{height:r.height,width:r.width,position:{left:a,top:h}})}}}if(t.panels.forEach(n=>{this._onDidMovePanel.fire({panel:n,from:t})}),e.skipSetActive===!1){const n=i??t;this.doSetGroupAndPanelActive(n)}}doSetGroupActive(e){super.doSetGroupActive(e);const t=this.activePanel;!this._moving&&t!==this._onDidActivePanelChange.value&&this._onDidActivePanelChange.fire(t)}doSetGroupAndPanelActive(e){super.doSetGroupActive(e);const t=this.activePanel;e&&this.hasMaximizedGroup()&&!this.isMaximizedGroup(e)&&this.exitMaximizedGroup(),!this._moving&&t!==this._onDidActivePanelChange.value&&this._onDidActivePanelChange.fire(t)}getNextGroupId(){let e=this.nextGroupId.next();for(;this._groups.has(e);)e=this.nextGroupId.next();return e}createGroup(e){e||(e={});let t=e?.id;if(t&&this._groups.has(e.id)&&(console.warn(`dockview: Duplicate group id ${e?.id}. reassigning group id to avoid errors`),t=void 0),!t)for(t=this.nextGroupId.next();this._groups.has(t);)t=this.nextGroupId.next();const i=new st(this,t,e);if(i.init({params:{},accessor:this}),!this._groups.has(i.id)){const s=new E(i.model.onTabDragStart(n=>{this._onWillDragPanel.fire(n)}),i.model.onGroupDragStart(n=>{this._onWillDragGroup.fire(n)}),i.model.onMove(n=>{const{groupId:r,itemId:a,target:h,index:l}=n;this.moveGroupOrPanel({from:{groupId:r,panelId:a},to:{group:i,position:h,index:l}})}),i.model.onDidDrop(n=>{this._onDidDrop.fire(n)}),i.model.onWillDrop(n=>{this._onWillDrop.fire(n)}),i.model.onWillShowOverlay(n=>{if(this.options.disableDnd){n.preventDefault();return}this._onWillShowOverlay.fire(n)}),i.model.onUnhandledDragOverEvent(n=>{this._onUnhandledDragOverEvent.fire(n)}),i.model.onDidAddPanel(n=>{this._moving||this._onDidAddPanel.fire(n.panel)}),i.model.onDidRemovePanel(n=>{this._moving||this._onDidRemovePanel.fire(n.panel)}),i.model.onDidActivePanelChange(n=>{this._moving||n.panel===this.activePanel&&this._onDidActivePanelChange.value!==n.panel&&this._onDidActivePanelChange.fire(n.panel)}),he.any(i.model.onDidPanelTitleChange,i.model.onDidPanelParametersChange)(()=>{this._bufferOnDidLayoutChange.fire()}));this._groups.set(i.id,{value:i,disposable:s})}return i.initialize(),i}createPanel(e,t){var i,s,n;const r=e.component,a=(i=e.tabComponent)!==null&&i!==void 0?i:this.options.defaultTabComponent,h=new Pt(this,e.id,r,a),l=new ue(e.id,r,a,this,this._api,t,h,{renderer:e.renderer,minimumWidth:e.minimumWidth,minimumHeight:e.minimumHeight,maximumWidth:e.maximumWidth,maximumHeight:e.maximumHeight});return l.init({title:(s=e.title)!==null&&s!==void 0?s:e.id,params:(n=e?.params)!==null&&n!==void 0?n:{}}),l}createGroupAtLocation(e,t,i){const s=this.createGroup(i);return this.doAddGroup(s,e,t),s}findGroup(e){var t;return(t=Array.from(this._groups.values()).find(i=>i.value.model.containsPanel(e)))===null||t===void 0?void 0:t.value}orientationAtLocation(e){const t=this.gridview.orientation;return e.length%2==1?t:J(t)}updateDropTargetModel(e){"dndEdges"in e&&(this._rootDropTarget.disabled=typeof e.dndEdges=="boolean"&&e.dndEdges===!1,typeof e.dndEdges=="object"&&e.dndEdges!==null?this._rootDropTarget.setOverlayModel(e.dndEdges):this._rootDropTarget.setOverlayModel(ht)),"rootOverlayModel"in e&&this.updateDropTargetModel({dndEdges:e.dndEdges})}updateTheme(){var e,t;const i=(e=this._options.theme)!==null&&e!==void 0?e:Fi;switch(this._themeClassnames.setClassNames(i.className),this.gridview.margin=(t=i.gap)!==null&&t!==void 0?t:0,i.dndOverlayMounting){case"absolute":this.rootDropTargetContainer.disabled=!1;break;case"relative":default:this.rootDropTargetContainer.disabled=!0;break}}}function sn(o,e){return new nn(o,e).api}class Xe{_element;onResizeCb=null;_loaded=!1;get loaded(){return this._loaded}get element(){return this._element}constructor(){this._element=document.createElement("div")}init(e){e.params.handler=this,this.setup?.(e),e.api.onDidDimensionsChange(t=>{this.onResize?.(t.width,t.height),this.onResizeCb?.(t.width,t.height)})}}class on{_element;get element(){return this._element}constructor(){this._element=document.createElement("div"),this._element.style.padding="5px 10px 0 10px"}init(e){e.api.onDidTitleChange(t=>{this._element.textContent=t.title})}}class Et extends Xe{canvas;setup(){this.canvas=document.createElement("canvas"),this._element.appendChild(this.canvas)}onResize(e,t){this.canvas.width=e,this.canvas.height=t}}class We{static hexStrToRgb(e){if(e=e.replace(/^#/,""),e.length===3&&(e=e.split("").map(n=>n+n).join("")),e.length!==6)return null;const t=parseInt(e.substring(0,2),16),i=parseInt(e.substring(2,4),16),s=parseInt(e.substring(4,6),16);return{r:t,g:i,b:s}}static rgbToHexStr(e){const t=Math.max(0,Math.min(255,e.r)).toString(16).padStart(2,"0"),i=Math.max(0,Math.min(255,e.g)).toString(16).padStart(2,"0"),s=Math.max(0,Math.min(255,e.b)).toString(16).padStart(2,"0");return`#${t}${i}${s}`}static sleep(e){return new Promise(t=>setTimeout(t,e))}}var Ce=1e-6,Z=typeof Float32Array<"u"?Float32Array:Array;function rn(){var o=new Z(9);return Z!=Float32Array&&(o[1]=0,o[2]=0,o[3]=0,o[5]=0,o[6]=0,o[7]=0),o[0]=1,o[4]=1,o[8]=1,o}function me(){var o=new Z(16);return Z!=Float32Array&&(o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[11]=0,o[12]=0,o[13]=0,o[14]=0),o[0]=1,o[5]=1,o[10]=1,o[15]=1,o}function an(o){return o[0]=1,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=1,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=1,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,o}function lt(o,e){var t=e[0],i=e[1],s=e[2],n=e[3],r=e[4],a=e[5],h=e[6],l=e[7],d=e[8],c=e[9],m=e[10],u=e[11],v=e[12],p=e[13],g=e[14],b=e[15],y=t*a-i*r,D=t*h-s*r,_=t*l-n*r,x=i*h-s*a,C=i*l-n*a,M=s*l-n*h,L=d*p-c*v,U=d*g-m*v,k=d*b-u*v,H=c*g-m*p,j=c*b-u*p,G=m*b-u*g,z=y*G-D*j+_*H+x*k-C*U+M*L;return z?(z=1/z,o[0]=(a*G-h*j+l*H)*z,o[1]=(s*j-i*G-n*H)*z,o[2]=(p*M-g*C+b*x)*z,o[3]=(m*C-c*M-u*x)*z,o[4]=(h*k-r*G-l*U)*z,o[5]=(t*G-s*k+n*U)*z,o[6]=(g*_-v*M-b*D)*z,o[7]=(d*M-m*_+u*D)*z,o[8]=(r*j-a*k+l*L)*z,o[9]=(i*k-t*j-n*L)*z,o[10]=(v*C-p*_+b*y)*z,o[11]=(c*_-d*C-u*y)*z,o[12]=(a*U-r*H-h*L)*z,o[13]=(t*H-i*U+s*L)*z,o[14]=(p*D-v*x-g*y)*z,o[15]=(d*x-c*D+m*y)*z,o):null}function hn(o,e,t){var i=e[0],s=e[1],n=e[2],r=e[3],a=e[4],h=e[5],l=e[6],d=e[7],c=e[8],m=e[9],u=e[10],v=e[11],p=e[12],g=e[13],b=e[14],y=e[15],D=t[0],_=t[1],x=t[2],C=t[3];return o[0]=D*i+_*a+x*c+C*p,o[1]=D*s+_*h+x*m+C*g,o[2]=D*n+_*l+x*u+C*b,o[3]=D*r+_*d+x*v+C*y,D=t[4],_=t[5],x=t[6],C=t[7],o[4]=D*i+_*a+x*c+C*p,o[5]=D*s+_*h+x*m+C*g,o[6]=D*n+_*l+x*u+C*b,o[7]=D*r+_*d+x*v+C*y,D=t[8],_=t[9],x=t[10],C=t[11],o[8]=D*i+_*a+x*c+C*p,o[9]=D*s+_*h+x*m+C*g,o[10]=D*n+_*l+x*u+C*b,o[11]=D*r+_*d+x*v+C*y,D=t[12],_=t[13],x=t[14],C=t[15],o[12]=D*i+_*a+x*c+C*p,o[13]=D*s+_*h+x*m+C*g,o[14]=D*n+_*l+x*u+C*b,o[15]=D*r+_*d+x*v+C*y,o}function ln(o,e,t,i,s){var n=1/Math.tan(e/2);if(o[0]=n/t,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=n,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[11]=-1,o[12]=0,o[13]=0,o[15]=0,s!=null&&s!==1/0){var r=1/(i-s);o[10]=(s+i)*r,o[14]=2*s*i*r}else o[10]=-1,o[14]=-2*i;return o}var dn=ln;function cn(o,e,t,i){var s,n,r,a,h,l,d,c,m,u,v=e[0],p=e[1],g=e[2],b=i[0],y=i[1],D=i[2],_=t[0],x=t[1],C=t[2];return Math.abs(v-_)<Ce&&Math.abs(p-x)<Ce&&Math.abs(g-C)<Ce?an(o):(d=v-_,c=p-x,m=g-C,u=1/Math.sqrt(d*d+c*c+m*m),d*=u,c*=u,m*=u,s=y*m-D*c,n=D*d-b*m,r=b*c-y*d,u=Math.sqrt(s*s+n*n+r*r),u?(u=1/u,s*=u,n*=u,r*=u):(s=0,n=0,r=0),a=c*r-m*n,h=m*s-d*r,l=d*n-c*s,u=Math.sqrt(a*a+h*h+l*l),u?(u=1/u,a*=u,h*=u,l*=u):(a=0,h=0,l=0),o[0]=s,o[1]=a,o[2]=d,o[3]=0,o[4]=n,o[5]=h,o[6]=c,o[7]=0,o[8]=r,o[9]=l,o[10]=m,o[11]=0,o[12]=-(s*v+n*p+r*g),o[13]=-(a*v+h*p+l*g),o[14]=-(d*v+c*p+m*g),o[15]=1,o)}function K(){var o=new Z(3);return Z!=Float32Array&&(o[0]=0,o[1]=0,o[2]=0),o}function Ne(o){var e=o[0],t=o[1],i=o[2];return Math.sqrt(e*e+t*t+i*i)}function ne(o,e,t){var i=new Z(3);return i[0]=o,i[1]=e,i[2]=t,i}function un(o,e){return o[0]=e[0],o[1]=e[1],o[2]=e[2],o}function dt(o,e,t){return o[0]=e[0]+t[0],o[1]=e[1]+t[1],o[2]=e[2]+t[2],o}function He(o,e,t){return o[0]=e[0]-t[0],o[1]=e[1]-t[1],o[2]=e[2]-t[2],o}function ct(o,e,t){return o[0]=e[0]*t,o[1]=e[1]*t,o[2]=e[2]*t,o}function De(o,e,t,i){return o[0]=e[0]+t[0]*i,o[1]=e[1]+t[1]*i,o[2]=e[2]+t[2]*i,o}function ae(o,e){var t=e[0],i=e[1],s=e[2],n=t*t+i*i+s*s;return n>0&&(n=1/Math.sqrt(n)),o[0]=e[0]*n,o[1]=e[1]*n,o[2]=e[2]*n,o}function pn(o,e){return o[0]*e[0]+o[1]*e[1]+o[2]*e[2]}function fe(o,e,t){var i=e[0],s=e[1],n=e[2],r=t[0],a=t[1],h=t[2];return o[0]=s*h-n*a,o[1]=n*r-i*h,o[2]=i*a-s*r,o}var mn=Ne;(function(){var o=K();return function(e,t,i,s,n,r){var a,h;for(t||(t=3),i||(i=0),s?h=Math.min(s*t+i,e.length):h=e.length,a=i;a<h;a+=t)o[0]=e[a],o[1]=e[a+1],o[2]=e[a+2],n(o,o,r),e[a]=o[0],e[a+1]=o[1],e[a+2]=o[2];return e}})();function fn(){var o=new Z(4);return Z!=Float32Array&&(o[0]=0,o[1]=0,o[2]=0,o[3]=0),o}function vn(o,e){var t=e[0],i=e[1],s=e[2],n=e[3],r=t*t+i*i+s*s+n*n;return r>0&&(r=1/Math.sqrt(r)),o[0]=t*r,o[1]=i*r,o[2]=s*r,o[3]=n*r,o}(function(){var o=fn();return function(e,t,i,s,n,r){var a,h;for(t||(t=4),i||(i=0),s?h=Math.min(s*t+i,e.length):h=e.length,a=i;a<h;a+=t)o[0]=e[a],o[1]=e[a+1],o[2]=e[a+2],o[3]=e[a+3],n(o,o,r),e[a]=o[0],e[a+1]=o[1],e[a+2]=o[2],e[a+3]=o[3];return e}})();function Be(){var o=new Z(4);return Z!=Float32Array&&(o[0]=0,o[1]=0,o[2]=0),o[3]=1,o}function gn(o,e,t){t=t*.5;var i=Math.sin(t);return o[0]=i*e[0],o[1]=i*e[1],o[2]=i*e[2],o[3]=Math.cos(t),o}function Oe(o,e,t,i){var s=e[0],n=e[1],r=e[2],a=e[3],h=t[0],l=t[1],d=t[2],c=t[3],m,u,v,p,g;return u=s*h+n*l+r*d+a*c,u<0&&(u=-u,h=-h,l=-l,d=-d,c=-c),1-u>Ce?(m=Math.acos(u),v=Math.sin(m),p=Math.sin((1-i)*m)/v,g=Math.sin(i*m)/v):(p=1-i,g=i),o[0]=p*s+g*h,o[1]=p*n+g*l,o[2]=p*r+g*d,o[3]=p*a+g*c,o}function _n(o,e){var t=e[0]+e[4]+e[8],i;if(t>0)i=Math.sqrt(t+1),o[3]=.5*i,i=.5/i,o[0]=(e[5]-e[7])*i,o[1]=(e[6]-e[2])*i,o[2]=(e[1]-e[3])*i;else{var s=0;e[4]>e[0]&&(s=1),e[8]>e[s*3+s]&&(s=2);var n=(s+1)%3,r=(s+2)%3;i=Math.sqrt(e[s*3+s]-e[n*3+n]-e[r*3+r]+1),o[s]=.5*i,i=.5/i,o[3]=(e[n*3+r]-e[r*3+n])*i,o[n]=(e[n*3+s]+e[s*3+n])*i,o[r]=(e[r*3+s]+e[s*3+r])*i}return o}var zt=vn;(function(){var o=K(),e=ne(1,0,0),t=ne(0,1,0);return function(i,s,n){var r=pn(s,n);return r<-.999999?(fe(o,e,s),mn(o)<1e-6&&fe(o,t,s),ae(o,o),gn(i,o,Math.PI),i):r>.999999?(i[0]=0,i[1]=0,i[2]=0,i[3]=1,i):(fe(o,s,n),i[0]=o[0],i[1]=o[1],i[2]=o[2],i[3]=1+r,zt(i,i))}})();(function(){var o=Be(),e=Be();return function(t,i,s,n,r,a){return Oe(o,i,r,a),Oe(e,s,n,a),Oe(t,o,e,2*a*(1-a)),t}})();(function(){var o=rn();return function(e,t,i,s){return o[0]=i[0],o[3]=i[1],o[6]=i[2],o[1]=s[0],o[4]=s[1],o[7]=s[2],o[2]=-t[0],o[5]=-t[1],o[8]=-t[2],zt(e,_n(e,o))}})();class It extends Xe{_parameters;get parameters(){return this._parameters}constructor(){super(),this._element.classList.add("inspector-panel","scrollable")}onFieldChangeCb;updateFields(e){if(this._parameters=e,this._element.innerHTML="",!e)return;const t=this.createField("Position",e.position,"xyz"),i=this.createField("Rotation",e.rotation,"xyz"),s=this.createField("Scale",e.scale,"xyz"),n=this.createField("Material",e.color,"color");this._element.append(t,i,s,n)}createField(e,t,i){const s=document.createElement("div");s.className="inspector-field";const n=document.createElement("p");n.textContent=e,n.className="inspector-title";const r=document.createElement("div");if(r.className="inspector-params",i==="xyz")for(let a=0;a<i.length;++a){const h=i.charAt(a),l=document.createElement("div");l.className="inspector-input-wrapper";const d=document.createElement("label");d.textContent=h.toUpperCase(),d.setAttribute("for",`${h}Input`),d.className="inspector-label";const c=document.createElement("input");c.type="number",c.name=`${h}Input`,c.value=t[a]?.toString()??"0",c.className="inspector-input",c.addEventListener("change",()=>{t[a]=parseFloat(c.value),this.onFieldChangeCb?.(e,i,t)}),l.append(d,c),r.appendChild(l)}else if(i==="color"){const a=document.createElement("div");a.className="inspector-input-wrapper";const h=document.createElement("label");h.textContent="Color",h.setAttribute("for","colorInput"),h.className="inspector-label";const l=document.createElement("input");l.type="color",l.name="colorInput",l.value=We.rgbToHexStr({r:t[0],g:t[1],b:t[2]}),l.className="inspector-color-input",l.addEventListener("input",()=>{const d=We.hexStrToRgb(l.value)??{r:0,g:0,b:0};t[0]=d.r,t[1]=d.g,t[2]=d.b,this.onFieldChangeCb?.(e,i,t)}),a.append(h,l),r.appendChild(a)}return s.append(n,r),s}}class Gt extends Xe{listElement;_itemList=[];get itemList(){return this._itemList}itemsMap=new Map;_activeItem=null;get activeItem(){return this._activeItem}panelContextMenuCallback;constructor(){super(),this._element.classList.add("hierarchy-panel","scrollable"),this.listElement=document.createElement("ul"),this.listElement.classList.add("hierarchy-list"),this._element.appendChild(this.listElement),this._element.addEventListener("contextmenu",e=>{if(e.preventDefault(),e.stopPropagation(),e.target.closest(".hierarchy-item"))return;const t=this.panelContextMenuCallback?.({name:"Hierarchy"},e.clientX,e.clientY);t&&t.length>0&&this.showContextMenu(t,e.clientX,e.clientY)}),this._element.addEventListener("click",e=>{this.activateItem(null)})}onContextMenu(e){this.panelContextMenuCallback=e}activateItem(e){this._activeItem?.html&&(this._activeItem.html.classList.remove("active"),this._activeItem.onLeave?.(this._activeItem)),this._activeItem=e,e&&(e.html&&e.html.classList.add("active"),e.onActive?.(e))}addItem(e,t){const i=document.createElement("li");if(i.textContent=e.name,i.classList.add("hierarchy-item"),e.html=i,e.onClick&&i.addEventListener("click",n=>{n.stopPropagation(),this.activateItem(e),e.onClick(e)}),i.addEventListener("contextmenu",n=>{n.preventDefault(),n.stopPropagation();const r=e.onContextMenu?.(e,n.clientX,n.clientY);r&&r.length>0&&this.showContextMenu(r,n.clientX,n.clientY)}),(t??this.listElement).appendChild(i),this.itemsMap.set(e.name,i),e.children&&e.children.length>0){const n=document.createElement("ul");n.classList.add("hierarchy-list"),i.appendChild(n);for(const r of e.children)this.addItem(r,n)}this.itemList.push(e)}removeItem(e){const t=this.itemsMap.get(e.name);t&&(t.remove(),this.itemsMap.delete(e.name));const i=this.itemList.indexOf(e);i>-1&&this.itemList.splice(i,1)}showContextMenu(e,t,i){const s=document.getElementById("hierarchy-context-menu");s&&s.remove();const n=document.createElement("div");n.id="hierarchy-context-menu",n.classList.add("hierarchy-context-menu"),n.style.left=`${t}px`,n.style.top=`${i}px`,e.forEach(r=>{const a=document.createElement("div");if(a.classList.add("hierarchy-context-menu-item"),a.textContent=r.text,n.appendChild(a),r.callback&&a.addEventListener("click",()=>{r.callback(),n.remove()}),r.children&&r.children.length>0){a.classList.add("has-children");const h=document.createElement("div");h.classList.add("hierarchy-context-submenu"),h.style.display="none",a.appendChild(h),this.buildSubMenu(h,r.children),a.addEventListener("mouseenter",()=>{this.positionSubMenu(h,a),h.style.display="block"}),a.addEventListener("mouseleave",()=>{h.style.display="none"})}}),document.body.appendChild(n),document.addEventListener("click",()=>n.remove(),{once:!0})}buildSubMenu(e,t){t.forEach(i=>{const s=document.createElement("div");if(s.classList.add("hierarchy-context-menu-item"),s.textContent=i.text,e.appendChild(s),i.callback&&s.addEventListener("click",()=>{i.callback(),e.closest("#hierarchy-context-menu")?.remove()}),i.children&&i.children.length>0){s.classList.add("has-children");const n=document.createElement("div");n.classList.add("hierarchy-context-submenu"),n.style.display="none",s.appendChild(n),this.buildSubMenu(n,i.children)}})}positionSubMenu(e,t){const i=t.getBoundingClientRect(),s=e.getBoundingClientRect(),n=window.innerWidth,r=window.innerHeight;let a=i.width,h=0;i.right+s.width>n&&(a=-s.width),i.top+s.height>r&&(h=r-s.height-i.top),e.style.left=`${a}px`,e.style.top=`${h}px`}}class wn{api;panelHandlers;constructor(e){this.panelHandlers=[];const t=new Et,i=new It,s=new Gt;this.panelHandlers.push(t),this.panelHandlers.push(i),this.panelHandlers.push(s),this.api=sn(e,{theme:Bi,createComponent:n=>{switch(n.name){case"Scene":return t;case"Inspector":return i;case"Hierarchy":return s;default:throw new Error("Panel not found")}},createTabComponent:n=>{switch(n.name){case"default":return new on;default:throw new Error("Tab not found")}}})}async initLayout(){const e=this.api.addPanel({id:"scene",component:"Scene",title:"Scene",tabComponent:"default"}),t=this.api.addPanel({id:"inspector",component:"Inspector",title:"Inspector",tabComponent:"default",position:{referencePanel:e,direction:"right"},minimumWidth:200,maximumWidth:350,initialWidth:250});this.api.addPanel({id:"hierarchy",component:"Hierarchy",title:"Hierarchy",tabComponent:"default",position:{referencePanel:t,direction:"above"},minimumWidth:200,maximumWidth:350,initialWidth:250}),await We.sleep(50)}getPanel(e){for(const t of this.panelHandlers)if(t instanceof e)return t;return null}}class bn{position=ne(0,2,4);rotation=Be();fov=45*Math.PI/180;near=.1;far=100;worldUp=ne(0,1,0);up=K();right=K();forward=K();target=ne(0,0,0);aspect=window.innerWidth/window.innerHeight;_viewMatrix=me();_projMatrix=me();_viewProjMatrix=me();_invViewProjMatrix=me();constructor(){this.updateMatrices()}updateMatrices(){cn(this._viewMatrix,this.position,this.target,this.worldUp);const e=me();lt(e,this._viewMatrix),this.right=ne(e[0],e[1],e[2]),this.up=ne(e[4],e[5],e[6]),this.forward=ne(e[8],e[9],e[10]),ct(this.forward,this.forward,-1),ae(this.right,this.right),ae(this.up,this.up),ae(this.forward,this.forward),dn(this._projMatrix,this.fov,this.aspect,this.near,this.far),hn(this._viewProjMatrix,this._projMatrix,this._viewMatrix),lt(this._invViewProjMatrix,this._viewProjMatrix)}getViewMatrix(){return this._viewMatrix}getProjectionMatrix(){return this._projMatrix}getInvViewProjMatrix(){return this._invViewProjMatrix}getViewProjMatrix(){return this._viewProjMatrix}orbit(e,t,i=.005){const s=K();He(s,this.position,this.target);let n=Ne(s),r=Math.atan2(s[2],s[0]),a=Math.acos(s[1]/n);r+=e*i,a-=t*i,a=Math.max(.1,Math.min(Math.PI-.1,a)),s[0]=n*Math.sin(a)*Math.cos(r),s[1]=n*Math.cos(a),s[2]=n*Math.sin(a)*Math.sin(r),dt(this.position,this.target,s)}zoom(e,t=.05,i=1,s=50){const n=K();He(n,this.position,this.target);let r=Ne(n);r+=e*t,r=Math.max(i,Math.min(s,r)),ae(n,n),ct(n,n,r),dt(this.position,this.target,n)}lookAt(e){un(this.target,e)}}const Dn=`
struct Uniforms {
    resolution: vec2<f32>,
    mouse: vec4<f32>,
    time: f32,
    deltaTime: f32,
};

struct Camera {
    position: vec3<f32>,
    invViewProj: mat4x4<f32>,
};

struct Object {
    position: vec3<f32>,
    _pad0: f32,
    rotation: vec3<f32>,
    _pad1: f32,
    scale: vec3<f32>,
    _pad2: f32,
    color: vec3<f32>,
    _pad3: f32,
    primitive: f32,
    id: f32,
};

@group(0) @binding(0)
var<uniform> uniforms : Uniforms;

@group(0) @binding(1)
var<storage, read> objects: array<Object>;

@group(0) @binding(2)
var<uniform> objectCount: u32;

@group(0) @binding(3)
var<storage, read_write> objectHitBuffer: array<f32>;

@group(0) @binding(4)
var<uniform> camera: Camera;

struct VertexOut {
    @builtin(position) position: vec4<f32>,
}

// -------------------------------------------------------------

@vertex
fn vs_main(@location(0) position: vec2<f32>) -> VertexOut {
    var out: VertexOut;
    out.position = vec4(position, 0.0, 1.0);
    return out;
}

// -------------------------------------------------------------
// SDFResult: unified return for distance + material + index + color
// -------------------------------------------------------------
struct SDFResult {
    dist: f32,
    mat: f32,
    idx: f32,
    color: vec3<f32>,
};

// -------------------------------------------------------------
const MAX_DIST: f32 = 100.0;
const SURF_DIST: f32 = 0.001;
const MAX_STEPS: i32 = 256;
const PI: f32 = 3.14159265359;

const MAT_GRID = 0.0;
const MAT_GIZMO = 1.0;

const MAT_SKY_COLOR: vec3<f32> = vec3(0.25, 0.25, 0.25);

// -------------------------------------------------------------
// Helpers
// -------------------------------------------------------------
fn atan2(y: f32, x: f32) -> f32 {
    return select(0.5 * 3.14159265, atan(y / x), x != 0.0);
}

// -------------------------------------------------------------
// Primitives
// -------------------------------------------------------------
fn sd_sphere(p: vec3<f32>, r: f32) -> f32 {
    return length(p) - r;
}

fn sd_ellipsoid(p: vec3<f32>, radii: vec3<f32>) -> f32 {
    let k0 = length(p / radii);
    let k1 = length(p / (radii * radii));
    return k0 * (k0 - 1.0) / k1;
}

fn sd_box(p: vec3<f32>, b: vec3<f32>) -> f32 {
    let q = abs(p) - b;
    return length(max(q, vec3(0.0))) + min(max(q.x, max(q.y, q.z)), 0.0);
}

fn sd_torus(p: vec3<f32>, t: vec2<f32>) -> f32 {
    let q = vec2(length(p.xz) - t.x, p.y);
    return length(q) - t.y;
}

fn sd_cylinder(p: vec3<f32>, r: f32, h: f32) -> f32 {
    let d = abs(vec2<f32>(length(p.xz), p.y)) - vec2<f32>(r, h);
    return min(max(d.x, d.y), 0.0) + length(max(d, vec2<f32>(0.0, 0.0)));
}

fn sd_cone(p: vec3<f32>, r: f32, h: f32) -> f32 {
    // c = normalize( vec2(h, r) )
    let hh = h * 2.0;
    let invLen = inverseSqrt(hh * hh + r * r);
    let c = vec2<f32>(hh * invLen, r * invLen);

    let q = length(vec2<f32>(p.x, p.z));

    // max( distance-to-side, distance-to-base-plane )
    return max(dot(c, vec2<f32>(q, p.y - h)), -hh - p.y + h);
}

fn sd_capsule(p: vec3<f32>, a: vec3<f32>, b: vec3<f32>, r: f32) -> f32 {
    let pa = p - a;
    let ba = b - a;
    let h = clamp(dot(pa, ba) / dot(ba, ba), 0.0, 1.0);
    return length(pa - ba * h) - r;
}

// -------------------------------------------------------------
// Rotation helper
// -------------------------------------------------------------
fn rotate_x(p: vec3<f32>, angle: f32) -> vec3<f32> {
    let c = cos(angle);
    let s = sin(angle);
    return vec3<f32>(
        p.x,
        c * p.y - s * p.z,
        s * p.y + c * p.z
    );
}

fn rotate_y(p: vec3<f32>, angle: f32) -> vec3<f32> {
    let c = cos(angle);
    let s = sin(angle);
    return vec3(
        c * p.x + s * p.z,
        p.y,
        -s * p.x + c * p.z
    );
}

fn rotate_z(p: vec3<f32>, angle: f32) -> vec3<f32> {
    let c = cos(angle);
    let s = sin(angle);
    return vec3<f32>(
        c * p.x - s * p.y,
        s * p.x + c * p.y,
        p.z
    );
}

// -------------------------------------------------------------
// Primitive dispatcher
// -------------------------------------------------------------
fn sdf_primitive(p: vec3<f32>, primitiveType: u32, scale: vec3<f32>, rotation: vec3<f32>) -> f32 {
    var q = p;

    // Apply rotation (simple Y rotation for demonstration; can extend to XYZ)
    if (rotation.x != 0.0) {
        q = rotate_x(q, rotation.x / 180.0 * PI);
    }
    if (rotation.y != 0.0) {
        q = rotate_y(q, rotation.y / 180.0 * PI);
    }
    if (rotation.z != 0.0) {
        q = rotate_z(q, rotation.z / 180.0 * PI);
    }

    switch (primitiveType) {
        case 0u: { // SPHERE / ELLIPSOID
            if all(scale == vec3<f32>(scale.x)) {
                return sd_sphere(q, scale.x);
            } else {
                return sd_ellipsoid(q, scale);
            }
        }
        case 1u: { // BOX / CUBOID
            return sd_box(q, scale);
        }
        case 2u: { // TORUS
            return sd_torus(q, vec2<f32>(scale.x, scale.y));
        }
        case 3u: { // CYLINDER
            return sd_cylinder(q, scale.x, scale.y);
        }
        case 4u: { // CONE
            return sd_cone(q, scale.x, scale.y);
        }
        case 5u: { // CAPSULE
            let a = vec3<f32>(0.0, -scale.y * 0.5, 0.0);
            let b = vec3<f32>(0.0, scale.y * 0.5, 0.0);
            return sd_capsule(q, a, b, scale.x);
        }
        default: {
            return MAX_DIST;
        }
    }
}


fn sd_grid_2D(p: vec3<f32>, thickness: f32, tile_size: f32) -> f32 {
    var q = p;
    q.x = q.x - tile_size * floor(q.x / tile_size + 0.5);
    q.z = q.z - tile_size * floor(q.z / tile_size + 0.5);

    let dx = abs(q.x) - thickness;
    let dz = abs(q.z) - thickness;

    let dX = max(dx, 0.0);
    let dZ = max(dz, 0.0);

    return max(min(dX, dZ), abs(q.y));
}

// -------------------------------------------------------------
// OBJECT DISTANCE (with object color)
// -------------------------------------------------------------
fn get_dist_obj(p: vec3<f32>) -> SDFResult {
    var res: SDFResult;
    res.dist = MAX_DIST;
    res.mat = -1.0;
    res.idx = -1.0;
    res.color = vec3(0.0);

    for (var i: u32 = 0u; i < objectCount; i++) {
        let obj = objects[i];
        let primitive = u32(obj.primitive);

        let local_p = p - obj.position;
        let d = sdf_primitive(local_p, u32(obj.primitive), obj.scale, obj.rotation);

        if d < res.dist {
            res.dist = d;
            res.idx = f32(i);
            res.color = obj.color;
            if f32(i) == objectHitBuffer[0] {
                res.color = mix(res.color, vec3<f32>(1.0, 0.0, 0.0), 0.4);
            }
        }
    }

    return res;
}

fn get_dist_gizmo(p: vec3<f32>) -> SDFResult {
    var res: SDFResult;
    res.dist = MAX_DIST;

    if (objectHitBuffer[0] < 0.0) {
        return res;
    }
    let trackedObj = objects[u32(objectHitBuffer[0])];

    let x_color = vec3<f32>(1.0, 0.0, 0.0);
    let y_color = vec3<f32>(0.0, 0.0, 1.0);
    let z_color = vec3<f32>(0.0, 1.0, 0.0);

    let q = p - trackedObj.position; 
    let s = trackedObj.scale * 1.2;

    //let sx = trackedObj.

    let cone_dia = 0.1;
    let cone_h = 0.1;
    let line_r = 0.02; // radius of connecting line

    // --- X axis ---
    let x_cone_pos = vec3<f32>(s.x + cone_h, 0.0, 0.0);
    var d = sd_cone(rotate_z(q - x_cone_pos, PI / 2.0), cone_dia, cone_h);
    if d < res.dist {
        res.dist = d;
        res.color = x_color;
    }

    // X line
    d = sd_capsule(q, vec3<f32>(0.0, 0.0, 0.0), x_cone_pos, line_r);
    if d < res.dist {
        res.dist = d;
        res.color = x_color;
    }

    // --- Y axis ---
    let y_cone_pos = vec3<f32>(0.0, s.y + cone_h, 0.0);
    d = sd_cone(q - y_cone_pos, cone_dia, cone_h);
    if d < res.dist {
        res.dist = d;
        res.color = y_color;
    }

    // Y line
    d = sd_capsule(q, vec3<f32>(0.0, 0.0, 0.0), y_cone_pos, line_r);
    if d < res.dist {
        res.dist = d;
        res.color = y_color;
    }

    // --- Z axis ---
    let z_cone_pos = vec3<f32>(0.0, 0.0, s.z + cone_h);
    d = sd_cone(rotate_x(q - z_cone_pos, -PI / 2.0), cone_dia, cone_h);
    if d < res.dist {
        res.dist = d;
        res.color = z_color;
    }

    // Z line
    d = sd_capsule(q, vec3<f32>(0.0, 0.0, 0.0), z_cone_pos, line_r);
    if d < res.dist {
        res.dist = d;
        res.color = z_color;
    }

    if d < MAX_DIST {
        res.mat = MAT_GIZMO;
    }

    return res;
}


// -------------------------------------------------------------
// SCENE SDF (distance + material + color integrated here)
// -------------------------------------------------------------
fn get_dist(p: vec3<f32>) -> SDFResult {
    var res: SDFResult;
    res.dist = MAX_DIST;
    res.mat = -1.0;
    res.idx = -1.0;
    res.color = vec3(0.0);

    // ----- GRID -----
    let gd = sd_grid_2D(p, 0.025, 1.0);
    if gd < res.dist {
        res.dist = gd;
        res.idx = -1.0;
        res.mat = MAT_GRID;

        // Reproduce your grid color logic:
        let modx = abs(p.x - 10.0 * floor(p.x / 10.0 + 0.5));
        let modz = abs(p.z - 10.0 * floor(p.z / 10.0 + 0.5));

        if abs(p.z) < 0.025 {
            res.color = vec3(1.0, 0.0, 0.0);
        } else if abs(p.x) < 0.025 {
            res.color = vec3(0.0, 1.0, 0.0);
        } else if modx < 0.025 || modz < 0.025 {
            res.color = vec3(0.31) * 0.4;
        } else {
            res.color = vec3(0.31);
        }
    }

    // ----- OBJECTS -----
    let o = get_dist_obj(p);
    if o.dist < res.dist {
        res = o;
    }

    return res;
}

// -------------------------------------------------------------
// RAY MARCH (returns SDFResult including color)
// -------------------------------------------------------------
fn ray_march(ro: vec3<f32>, rd: vec3<f32>, mode: u32) -> SDFResult {
    var total = 0.0;
    var res: SDFResult;

    res.dist = MAX_DIST;
    res.idx = -1.0;
    res.mat = -1.0;
    res.color = vec3(0.0);

    for (var i = 0; i < MAX_STEPS; i++) {
        let p = ro + rd * total;
        var s: SDFResult;

        if mode == 0u {
            s = get_dist(p);
        } else {
            s = get_dist_gizmo(p);
        }

        total += s.dist;
        res = s;

        if s.dist < SURF_DIST || total > MAX_DIST {
            res.dist = total;
            return res;
        }
    }

    res.dist = total;
    return res;
}

// -------------------------------------------------------------
fn get_normal(p: vec3<f32>) -> vec3<f32> {
    let e = vec2(0.001, 0.0);
    return normalize(vec3(
        get_dist(p + e.xyy).dist - get_dist(p - e.xyy).dist,
        get_dist(p + e.yxy).dist - get_dist(p - e.yxy).dist,
        get_dist(p + e.yyx).dist - get_dist(p - e.yyx).dist
    ));
}

// -------------------------------------------------------------
fn pick_object(ro: vec3<f32>, rd: vec3<f32>) -> i32 {
    var t = 0.0;
    for (var i = 0; i < MAX_STEPS; i++) {
        let p = ro + rd * t;
        let s = get_dist_obj(p);

        t += s.dist;
        if s.dist < SURF_DIST {
            return i32(s.idx);
        }
        if t > MAX_DIST {
            break;
        }
    }
    return -1;
}

// -------------------------------------------------------------
// Gamma
fn gamma_correct(c: vec3<f32>) -> vec3<f32> {
    return pow(c, vec3(1.0 / 2.2));
}
// -------------------------------------------------------------

@fragment
fn fs_main(@builtin(position) fragCoord: vec4<f32>) -> @location(0) vec4<f32> {
    let uv = fragCoord.xy * 2.0 / uniforms.resolution.xy - 1.0;

    // Mouse picking ray
    if uniforms.mouse.z == 1.0 {
        let ndc = vec4(
            (uniforms.mouse.x * 2.0 / uniforms.resolution.x - 1.0),
            -(uniforms.mouse.y * 2.0 / uniforms.resolution.y - 1.0),
            1.0,
            1.0
        );

        let wp = camera.invViewProj * ndc;
        let pos3 = wp.xyz / wp.w;

        let ro = camera.position;
        let rd = normalize(pos3 - ro);

        objectHitBuffer[0] = f32(pick_object(ro, rd));
    }

    // Main view ray
    let ndc = vec4(uv.x, -uv.y, 1.0, 1.0);
    let wp = camera.invViewProj * ndc;
    let pos3 = wp.xyz / wp.w;
    let ro = camera.position;
    let rd = normalize(pos3 - ro);

    var hit = ray_march(ro, rd, 0u);

    if objectHitBuffer[0] >= 0.0 {
        let gizmo_hit = ray_march(ro, rd, 1u);

        if gizmo_hit.dist < MAX_DIST {
            hit = gizmo_hit;
        }
    }
    let dist = hit.dist;

    if dist < MAX_DIST {
        let hit_pos = ro + rd * dist;
        let normal = get_normal(hit_pos);

        var color = hit.color;

        if hit.mat != MAT_GRID {
        // Lighting
            let light_pos = vec3(2.0, 5.0, -1.0);
            let light_dir = normalize(light_pos - hit_pos);
            let diffuse = max(dot(normal, light_dir), 0.0);

        // Shadow
            let shadow_pos = hit_pos + normal * 0.01;
            let shadow = select(0.3, 1.0, ray_march(shadow_pos, light_dir, 0u).dist > length(light_pos - shadow_pos));

            let ambient = 0.2;
            let albedo = hit.color;

            let shaded = albedo * (ambient + diffuse * shadow * 0.8);

        // Fog
            let fog = exp(-dist * 0.005);
            color = mix(MAT_SKY_COLOR, shaded, fog);
        }

        return vec4(gamma_correct(color), 1.0);
    }

    // Sky
    let sky = mix(MAT_SKY_COLOR, MAT_SKY_COLOR * 0.9, uv.y * 0.5 + 0.5);
    return vec4(gamma_correct(sky), 1.0);
}

`,Fe={SPHERE:0,ELLIPSOID:0,BOX:1,CUBOID:1,TORUS:2,CYLINDER:3,CONE:4,CAPSULE:5};class F{static globalId=0;static typeCountsRecord=new Map;name;static GPU_DATA_SIZE_WPAD_BYTES=80;position;rotation;scale;color;primitive;id;_device;_objectBuffer;_index;get index(){return this._index}constructor({name:e="",position:t=[0,0,0],rotation:i=[0,0,0],scale:s=[1,1,1],color:n=[1,1,1],primitive:r=Fe.CUBOID}={}){this.name=e,this.id=F.generateId(),this.position=[...t],this.rotation=[...i],this.scale=[...s],this.color=[...n],this.primitive=r,F.typeCountsRecord.set(r,(F.typeCountsRecord.get(r)||0)+1)}sync(){if(!this._device||!this._objectBuffer||this._index===void 0)return;const e=this._index*F.GPU_DATA_SIZE_WPAD_BYTES,t=new Float32Array(F.GPU_DATA_SIZE_WPAD_BYTES/4);t.set(this.position,0),t.set(this.rotation,4),t.set(this.scale,8),t.set(this.color,12),t.set([this.primitive,this.id],16),this._device.queue.writeBuffer(this._objectBuffer,e,t.buffer,0,t.byteLength)}copy(){return new F({name:`${this.name}Copy`,position:this.position,rotation:this.rotation,scale:this.scale,color:this.color,primitive:this.primitive})}destroy(){this._device=void 0,this._objectBuffer=void 0,this._index=void 0,this.position=[0,0,0],this.rotation=[0,0,0],this.scale=[0,0,0],this.color=[0,0,0],this.name=""}static generateId(){F.globalId++;const e=Math.floor(Math.random()*65535);return(F.globalId&65535)<<16|e&65535}static getCountByType(e){return F.typeCountsRecord.get(e)||0}}class Ze{static MAX_OBJECTS=1e3;static UNIFORMS_SIZE_WPAD_BYTES=48;device;pipeline;bindGroup;lastUniforms;uniformBuffer;objects;objectBuffer;objectCountBuffer;objectHitBuffer;objectHitStagingBuffer;vertexBuffer;camera;cameraBuffer;_lastIntersectedObj;get lastIntersectedObj(){return this._lastIntersectedObj}constructor(e,t,i){this.device=e,this.camera=i,this.lastUniforms={},this.objects=[];const s=new Float32Array([-1,-1,3,-1,-1,3]);this.vertexBuffer=this.device.createBuffer({size:s.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),e.queue.writeBuffer(this.vertexBuffer,0,s,0,s.length);const n={arrayStride:8,attributes:[{shaderLocation:0,offset:0,format:"float32x2"}]},r=e.createShaderModule({code:Dn});this.pipeline=e.createRenderPipeline({layout:"auto",vertex:{module:r,entryPoint:"vs_main",buffers:[n]},fragment:{module:r,entryPoint:"fs_main",targets:[{format:t}]},primitive:{topology:"triangle-strip",cullMode:"none"}}),this.uniformBuffer=e.createBuffer({size:Ze.UNIFORMS_SIZE_WPAD_BYTES,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!1}),this.objectBuffer=e.createBuffer({size:F.GPU_DATA_SIZE_WPAD_BYTES*128,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),this.objectCountBuffer=e.createBuffer({size:4,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.objectHitBuffer=e.createBuffer({size:4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}),this.device.queue.writeBuffer(this.objectHitBuffer,0,Float32Array.from([-1]).buffer),this.objectHitStagingBuffer=e.createBuffer({size:4,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),this.cameraBuffer=e.createBuffer({size:80,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!1}),this.bindGroup=e.createBindGroup({layout:this.pipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.uniformBuffer}},{binding:1,resource:{buffer:this.objectBuffer}},{binding:2,resource:{buffer:this.objectCountBuffer}},{binding:3,resource:{buffer:this.objectHitBuffer}},{binding:4,resource:{buffer:this.cameraBuffer}}]})}selectObject(e){this.device.queue.writeBuffer(this.objectHitBuffer,0,Float32Array.from([e?._index??-1]).buffer),this._lastIntersectedObj=e}addObject(e){if(this.objects.length>=this.objectBuffer.size){const i=this.objectBuffer.size*2,s=this.device.createBuffer({size:i,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),n=this.device.createCommandEncoder();n.copyBufferToBuffer(this.objectBuffer,0,s,0,this.objectBuffer.size),this.device.queue.submit([n.finish()]),this.objectBuffer.destroy(),this.objectBuffer=s}e._objectBuffer=this.objectBuffer,e._device=this.device,e._index=this.objects.length,this.objects.push(e);const t=new Uint32Array([this.objects.length]);this.device.queue.writeBuffer(this.objectCountBuffer,0,t.buffer),e.sync()}removeObject(e){const t=e._index;if(t===void 0||t<0||t>=this.objects.length)return;const i=this.objects.length-1;if(t!==i){const n=this.objects[i],r=this.device.createCommandEncoder(),a=this.device.createBuffer({size:F.GPU_DATA_SIZE_WPAD_BYTES,usage:GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST});r.copyBufferToBuffer(this.objectBuffer,i*F.GPU_DATA_SIZE_WPAD_BYTES,a,0,F.GPU_DATA_SIZE_WPAD_BYTES),r.copyBufferToBuffer(a,0,this.objectBuffer,t*F.GPU_DATA_SIZE_WPAD_BYTES,F.GPU_DATA_SIZE_WPAD_BYTES),this.device.queue.submit([r.finish()]),a.destroy(),n._index=t,this.objects[t]=n,this._lastIntersectedObj===n&&this.selectObject(n)}this.objects.pop();const s=new Uint32Array([this.objects.length]);this.device.queue.writeBuffer(this.objectCountBuffer,0,s.buffer),this._lastIntersectedObj===e&&this.selectObject(null),e.destroy()}getObjectByName(e){return this.objects.find(t=>t.name===e)??null}getObjectById(e){return this.objects.find(t=>t.id==e)??null}redeemMemory(){}updateUniforms(e){for(const i in e){const s=e[i];s!==void 0&&(this.lastUniforms[i]=s)}const t=new Float32Array(12);t.set([...this.lastUniforms.resolution??[0,0],0,0],0),t.set(this.lastUniforms.mouse??[0,0,0,0],4),t.set([this.lastUniforms.time??0,this.lastUniforms.deltaTime??0,0,0],8),this.device.queue.writeBuffer(this.uniformBuffer,0,t.buffer)}async checkCollision(){const e=this.device.createCommandEncoder();e.copyBufferToBuffer(this.objectHitBuffer,0,this.objectHitStagingBuffer,0,4),this.device.queue.submit([e.finish()]),await this.objectHitStagingBuffer.mapAsync(GPUMapMode.READ,0,4);const i=this.objectHitStagingBuffer.getMappedRange(0,4).slice();this.objectHitStagingBuffer.unmap();const n=new Float32Array(i)[0],r=this.objects[n];return this._lastIntersectedObj=r,r}render(e){const t=new Float32Array(20);t.set(this.camera.position,0),t.set(this.camera.getInvViewProjMatrix(),4),this.device.queue.writeBuffer(this.cameraBuffer,0,t),e.setPipeline(this.pipeline),e.setBindGroup(0,this.bindGroup),e.setVertexBuffer(0,this.vertexBuffer),e.draw(3)}}async function Cn(o){const e=await navigator.gpu.requestAdapter();if(!e)throw Error("Could not request GPU adapter.");const t=await e.requestDevice();if(!t)throw Error("Could not request GPU device.");const i=o.getContext("webgpu");if(!i)throw Error("Could not request WebGPU canvas context.");const s=navigator.gpu.getPreferredCanvasFormat();return i.configure({device:t,format:s,alphaMode:"opaque"}),{device:t,context:i,format:s}}const Ue=F;class Je{device;context;raymarcher;camera;_selectedObject;get selectedObject(){return this._selectedObject}onObjectSelected;onObjectUnselected;constructor(){this._selectedObject=null}static async create(e){const{device:t,context:i,format:s}=await Cn(e),n=new Je;return n.device=t,n.context=i,n.camera=new bn,n.camera.position=[5,8,12],n.raymarcher=new Ze(t,s,n.camera),n.setupEventListeners(e),n}addObject(e){this.raymarcher.addObject(e)}removeObject(e){this.raymarcher.removeObject(e)}selectObject(e){this.raymarcher.selectObject(e),this._selectedObject=e}render(e){const t=this.device.createCommandEncoder(),i=this.context.getCurrentTexture().createView(),s=t.beginRenderPass({colorAttachments:[{view:i,loadOp:"clear",storeOp:"store"}]});this.raymarcher.updateUniforms({time:e/1e3}),this.raymarcher.render(s),s.end(),this.device.queue.submit([t.finish()])}resize(e,t){this.raymarcher.updateUniforms({resolution:[e,t]}),this.camera.aspect=e/t,this.camera.updateMatrices()}setupEventListeners(e){let t=!1,i=!1,s=[0,0];e.addEventListener("mousedown",n=>{const r=e.getBoundingClientRect(),a=n.clientX-r.left,h=n.clientY-r.top;n.button===0&&(t=!0),n.button===2&&(i=!0),s=[a,h],this.raymarcher.updateUniforms({mouse:[a,h,1,0]}),(async()=>{await new Promise(d=>setTimeout(d,50));const l=await this.raymarcher.checkCollision();l?this.onObjectSelected?.(l):this._selectedObject&&this.onObjectUnselected?.(this._selectedObject),this._selectedObject=l})()}),e.addEventListener("mouseup",n=>{const r=e.getBoundingClientRect(),a=n.clientX-r.left,h=n.clientY-r.top;n.button===0&&(t=!1),n.button===2&&(i=!1),this.raymarcher.updateUniforms({mouse:[a,h,0,0]})}),e.addEventListener("mousemove",n=>{const r=e.getBoundingClientRect(),a=n.clientX-r.left,h=n.clientY-r.top,l=a-s[0],d=h-s[1];s=[a,h];const c=.005,m=.01;if(t&&(this.camera.orbit(l,d,c),this.camera.updateMatrices()),i){const u=K();He(u,this.camera.target,this.camera.position),ae(u,u);const v=K();fe(v,u,this.camera.up),ae(v,v);const p=K();fe(p,v,u),De(this.camera.position,this.camera.position,v,-l*m),De(this.camera.target,this.camera.target,v,-l*m),De(this.camera.position,this.camera.position,p,d*m),De(this.camera.target,this.camera.target,p,d*m),this.camera.updateMatrices()}}),e.addEventListener("wheel",n=>{this.camera.zoom(n.deltaY),this.camera.updateMatrices()}),e.addEventListener("contextmenu",n=>n.preventDefault())}}const yn=document.querySelector("#app"),ze=new wn(yn);await ze.initLayout();const Ot=ze.getPanel(It),Mt=ze.getPanel(Et),de=ze.getPanel(Gt),je=Mt.canvas,ee=await Je.create(je);ee.resize(je.width,je.height);Ke(new Ue({name:"Cube",color:[.2,.8,.2]}));const Tt=o=>{ee.render(o),requestAnimationFrame(Tt)};requestAnimationFrame(Tt);ee.onObjectSelected=o=>{console.log(`intersected object name: ${o.name}`);const e=de.itemList.find(t=>t.data?.objectRef===o)??null;de.activateItem(e)};ee.onObjectUnselected=o=>{console.log(`unselected : ${o.name}`),de.activateItem(null)};Mt.onResizeCb=(o,e)=>{ee.resize(o,e)};Ot.onFieldChangeCb=(o,e,t)=>{const i=ee.selectedObject;i&&(o==="Position"?i.position=t:o==="Rotation"?i.rotation=t:o==="Scale"?i.scale=t:o==="Material"&&(i.color=[t[0]/255,t[1]/255,t[2]/255]),i.sync())};function Lt(o){let e=null;o&&(e={position:o.position,rotation:o.rotation,scale:o.scale,color:[o.color[0]*255,o.color[1]*255,o.color[2]*255]}),Ot.updateFields(e)}function xn(o){return[{text:`Remove ${o.name}`,callback:()=>{ee.removeObject(o.data?.objectRef),de.removeItem(o)}},{text:`Copy ${o.name}`,callback:()=>{const e=o.data?.objectRef;Ke(e?.copy())}}]}function ut(o){const e=o.data?.objectRef;e&&(ee.selectObject(e),Lt(e))}function An(){ee.selectObject(null),Lt(null)}de.onContextMenu(()=>{const o=i=>i.charAt(0).toUpperCase()+i.slice(1).toLowerCase();return[{text:"Create new primitive",children:Object.keys(Fe).map(i=>({text:o(i),callback:()=>{const s=Fe[i],n=new Ue({primitive:s});n.name=`${o(i)}${Ue.getCountByType(n.primitive)}`,Ke(n)}}))}]});function Ke(o){ee.addObject(o);const e={name:o.name,onClick:ut,onActive:ut,onLeave:An,onContextMenu:xn,data:{objectRef:o}};de.addItem(e),de.activateItem(e)}window.addEventListener("contextmenu",o=>o.preventDefault());
